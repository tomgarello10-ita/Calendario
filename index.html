<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#ffffff"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="apple-mobile-web-app-title" content="Il Mio Anno"/>
  <title>Il Mio Anno</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <style>
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0}
    html,body{height:100%;overflow:hidden}
    body{font-family:-apple-system,'SF Pro Text','Helvetica Neue',sans-serif;overscroll-behavior:none;transition:background 0.3s,color 0.3s}
    body.dark{background:#000;color:#fff}
    body.light{background:#fff;color:#1C1C1E}
    ::-webkit-scrollbar{display:none}
    input,textarea{-webkit-appearance:none;user-select:text;font-family:inherit}
    *{user-select:none}
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
    .tap:active{opacity:0.45}
    .spin{animation:spin 1s linear infinite}
    .pulse{animation:pulse 1.5s ease infinite}
  </style>
</head>
<body class="light">
<div id="root" style="height:100%"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback} = React;

// â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ThemeCtx = React.createContext({dark:false,toggle:()=>{}});

const MONTHS=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
const MONTHS_S=["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
const DAYS=["L","M","M","G","V","S","D"];

const CATS=[
  {id:"verifica",    label:"Verifica",    emoji:"ğŸ“",color:"#FF3B30",bg:"rgba(255,59,48,0.1)"},
  {id:"compleanno",  label:"Compleanno",  emoji:"ğŸ‚",color:"#FF9500",bg:"rgba(255,149,0,0.1)"},
  {id:"commissione", label:"Commissione", emoji:"ğŸ›’",color:"#34C759",bg:"rgba(52,199,89,0.1)"},
  {id:"appuntamento",label:"Appuntamento",emoji:"ğŸ¥",color:"#007AFF",bg:"rgba(0,122,255,0.1)"},
  {id:"todo",        label:"Da fare",     emoji:"âœ…",color:"#AF52DE",bg:"rgba(175,82,222,0.1)"},
];
const getCat=id=>CATS.find(c=>c.id===id)||CATS[4];

const MATERIE=[
  {id:"matematica",label:"Matematica",emoji:"ğŸ“"},{id:"italiano",label:"Italiano",emoji:"ğŸ“–"},
  {id:"storia",label:"Storia",emoji:"ğŸ›ï¸"},{id:"scienze",label:"Scienze",emoji:"ğŸ”¬"},
  {id:"inglese",label:"Inglese",emoji:"ğŸ‡¬ğŸ‡§"},{id:"fisica",label:"Fisica",emoji:"âš¡"},
  {id:"chimica",label:"Chimica",emoji:"ğŸ§ª"},{id:"geografia",label:"Geografia",emoji:"ğŸŒ"},
  {id:"arte",label:"Arte",emoji:"ğŸ¨"},{id:"musica",label:"Musica",emoji:"ğŸµ"},
  {id:"filosofia",label:"Filosofia",emoji:"ğŸ¤”"},{id:"informatica",label:"Informatica",emoji:"ğŸ’»"},
  {id:"ed_fisica",label:"Ed. Fisica",emoji:"âš½"},{id:"latino",label:"Latino",emoji:"ğŸ“œ"},
  {id:"altra",label:"Altra",emoji:"ğŸ“š"},
];

const TIPI=["Scritto","Orale","Test","Compito","Presentazione"];

const today=new Date();
const todayStr=fmt(today.getFullYear(),today.getMonth(),today.getDate());
function fmt(y,m,d){return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`}
function daysIn(y,m){return new Date(y,m+1,0).getDate()}
function firstDay(y,m){const d=new Date(y,m,1).getDay();return d===0?6:d-1}
function addMonths(y,m,delta){let nm=m+delta,ny=y;while(nm>11){nm-=12;ny++;}while(nm<0){nm+=12;ny--;}return{year:ny,month:nm};}
function daysBetween(s){const[y,m,d]=s.split("-").map(Number);return Math.round((new Date(y,m-1,d)-new Date(today.getFullYear(),today.getMonth(),today.getDate()))/(864e5))}

const SK="ilmioanno_v6";
function loadEv(){try{return JSON.parse(localStorage.getItem(SK))||{}}catch{return{}}}
function saveEv(e){try{localStorage.setItem(SK,JSON.stringify(e))}catch{}}
function loadPref(){try{return JSON.parse(localStorage.getItem(SK+"_pref"))||{dark:false}}catch{return{dark:false}}}
function savePref(p){try{localStorage.setItem(SK+"_pref",JSON.stringify(p))}catch{}}

function getAlerts(ev){
  const a=[];
  Object.entries(ev).forEach(([day,evs])=>evs.forEach(e=>{
    const d=daysBetween(day),c=getCat(e.category);
    if(e.category==="verifica"){
      if(d===15)a.push({e,day,d,msg:"Inizia a ripassare!",u:"low",icon:"ğŸ“–"});
      else if(d===10)a.push({e,day,d,msg:"Ripassa con costanza",u:"medium",icon:"ğŸ“š"});
      else if(d===5)a.push({e,day,d,msg:"Ultimi giorni!",u:"high",icon:"âš¡"});
      else if(d===2)a.push({e,day,d,msg:"Dopodomani! Rivedi tutto",u:"high",icon:"ğŸ”¥"});
      else if(d===1)a.push({e,day,d,msg:"DOMANI! Sei pronto?",u:"urgent",icon:"ğŸš¨"});
      else if(d===0)a.push({e,day,d,msg:"OGGI! In bocca al lupo!",u:"urgent",icon:"ğŸ¯"});
    } else if(e.category==="compleanno"){
      if(d===7)a.push({e,day,d,msg:"Tra una settimana!",u:"low",icon:"ğŸ"});
      else if(d===3)a.push({e,day,d,msg:"Tra 3 giorni!",u:"medium",icon:"ğŸ‚"});
      else if(d===1)a.push({e,day,d,msg:"DOMANI! Non dimenticare!",u:"high",icon:"ğŸ‰"});
      else if(d===0)a.push({e,day,d,msg:"OGGI Ã¨ il compleanno! ğŸ¥³",u:"urgent",icon:"ğŸ‚"});
    } else {
      if(d===3)a.push({e,day,d,msg:"Tra 3 giorni",u:"low",icon:c.emoji});
      else if(d===1)a.push({e,day,d,msg:"DOMANI! Non dimenticare",u:"high",icon:"â°"});
      else if(d===0)a.push({e,day,d,msg:"OGGI!",u:"urgent",icon:"ğŸ””"});
    }
  }));
  const o={urgent:0,high:1,medium:2,low:3};
  return a.sort((a,b)=>o[a.u]-o[b.u]);
}

// â”€â”€ AI CALL (Gemini) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ SISTEMA RIPASSO OFFLINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const RIPASSO_DB={
  matematica:{
    esercizi_base:[
      "Risolvi: 2xÂ² - 5x + 3 = 0",
      "Risolvi il sistema: { 2x + y = 7 / x - y = 2 }",
      "Calcola l'area di un triangolo con base 8cm e altezza 5cm",
      "Semplifica la frazione: 36/48",
      "Risolvi: 3(x - 2) = 2x + 4",
      "Calcola: (2Â³ Ã— 4Â²) Ã· 2â´",
      "Trova il MCD e mcm di 12 e 18",
      "Risolvi la proporzione: 3 : x = 6 : 10"
    ],
    esercizi_avanzati:[
      "Studia il segno di: f(x) = xÂ² - 4x + 3",
      "Calcola il discriminante e le soluzioni di: xÂ² + 3x - 10 = 0",
      "Dimostra che la diagonale di un quadrato di lato 'a' Ã¨ aâˆš2",
      "Risolvi: |2x - 1| < 5",
      "Dato un cerchio di raggio 6, calcola area e circonferenza"
    ],
    teoria:["Ripassa le formule quadratiche","Studia i teoremi sulle figure piane","Rileggi le proprietÃ  delle potenze"],
    tips:["Sostituisci sempre per verificare","Disegna prima di calcolare","Controlla il segno del discriminante"]
  },
  italiano:{
    esercizi_base:[
      "Analizza grammaticalmente: 'Il gatto grigio dorme sul divano morbido'",
      "Individua soggetto, predicato e complementi in: 'Maria ha regalato un libro alla sua amica'",
      "Scrivi il contrario di: felice, lento, caldo, grande, chiaro",
      "Trasforma al passivo: 'Il professore spiega la lezione agli studenti'",
      "Trova le figure retoriche in: 'Il mare era una lastra di acciaio lucente'",
      "Dividi in sillabe: straordinario, psicologia, aeroplano, scienza",
      "Scrivi 3 sinonimi per: bello, camminare, dire, paura"
    ],
    esercizi_avanzati:[
      "Analisi del periodo: 'Sebbene fosse stanco, continuÃ² a lavorare finchÃ© non finÃ¬ il progetto'",
      "Scrivi un testo argomentativo di 15 righe su: 'I social media fanno piÃ¹ bene o male?'",
      "Commenta questa metafora: 'La vita Ã¨ un viaggio senza mappa'",
      "Trasforma dal discorso diretto all'indiretto: 'Marco disse: Vengo domani alla festa'"
    ],
    teoria:["Ripassa le congiunzioni subordinanti","Studia le figure retoriche principali","Rileggi la struttura del testo argomentativo"],
    tips:["Leggi le frasi ad alta voce","Fai schemi per i periodi complessi","Usa la matita per segnare gli elementi"]
  },
  storia:{
    esercizi_base:[
      "Metti in ordine cronologico: Rivoluzione Francese, Prima Guerra Mondiale, Rivoluzione Industriale, Caduta dell'Impero Romano",
      "Scrivi 3 cause della Prima Guerra Mondiale",
      "Chi era Napoleone Bonaparte? Scrivi 5 informazioni chiave",
      "In quale anno cadde il Muro di Berlino? E cosa rappresentava?",
      "Collega: Mussolini â†’ __, Hitler â†’ __, Stalin â†’ __ (fascismo/nazismo/comunismo)",
      "Quali paesi formavano la Triplice Alleanza nel 1914?",
      "Quando e dove fu firmata la Dichiarazione d'Indipendenza americana?"
    ],
    esercizi_avanzati:[
      "Confronta la Rivoluzione Francese e quella Americana: somiglianze e differenze",
      "Spiega il concetto di 'imperialismo' e fai 2 esempi storici",
      "Analizza le conseguenze del Trattato di Versailles sulla Germania",
      "PerchÃ© scoppiÃ² la Seconda Guerra Mondiale? Elenca le 4 cause principali"
    ],
    teoria:["Ripassa le date fondamentali del programma","Studia i personaggi chiave","Rileggi le mappe geografiche storiche"],
    tips:["Usa una linea del tempo visiva","Collega sempre causa â†’ evento â†’ conseguenza","Impara le date associandole a eventi memorabili"]
  },
  scienze:{
    esercizi_base:[
      "Descrivi le fasi della mitosi in ordine",
      "Qual Ã¨ la differenza tra cellula procariota ed eucariota?",
      "Completa: La fotosintesi produce ___ e ___ usando ___ e ___",
      "Elenca i 5 regni degli esseri viventi con un esempio per ciascuno",
      "Descrivi il ciclo dell'acqua in 4 fasi",
      "Qual Ã¨ la funzione di: nucleo, mitocondri, membrana cellulare?",
      "Differenza tra DNA e RNA: scrivi 3 differenze"
    ],
    esercizi_avanzati:[
      "Spiega la legge di Mendel usando l'esempio dei piselli",
      "Descrivi il processo di respirazione cellulare aerobica",
      "Cosa sono gli enzimi? Spiega il loro meccanismo d'azione",
      "Confronta fotosintesi e respirazione cellulare"
    ],
    teoria:["Ripassa i processi cellulari","Studia la classificazione degli organismi","Rileggi i cicli biogeochimici"],
    tips:["Disegna sempre gli schemi delle cellule","Collega struttura â†’ funzione","Usa flashcard per i termini scientifici"]
  },
  inglese:{
    esercizi_base:[
      "Metti i verbi al Past Simple: go, eat, write, run, have, see, make, take",
      "Trasforma al Present Perfect: 'I eat pizza' â†’ 'I ___ already ___ pizza'",
      "Scrivi le domande per: 'She works in Milan' / 'They went to Paris last year'",
      "Traduci: 'Se studiassi di piÃ¹, prenderesti voti migliori'",
      "Completa con la forma corretta: 'If I ___ (be) you, I ___ (study) more'",
      "Scrivi 5 frasi usando il Passive Voice al Present Simple",
      "Trasforma in reported speech: 'Tom said: I will call you tomorrow'"
    ],
    esercizi_avanzati:[
      "Scrivi un'email formale (100 parole) per candidarti a un lavoro",
      "Analizza il testo e rispondi: 'What is the main idea? What does the author imply?'",
      "Completa i phrasal verbs: give ___, take ___, look ___, put ___",
      "Scrivi un paragrafo con: although, however, therefore, in addition"
    ],
    teoria:["Ripassa i tempi verbali con esempi","Studia i connettori discorsivi","Rileggi le strutture condizionali"],
    tips:["Leggi le frasi ad alta voce per la pronuncia","Impara i phrasal verbs in contesto","Guarda video in inglese durante le pause"]
  },
  fisica:{
    esercizi_base:[
      "Un'auto percorre 150 km in 2 ore. Calcola la velocitÃ  media",
      "Calcola la forza necessaria per accelerare una massa di 5 kg a 3 m/sÂ²",
      "Un oggetto di 2 kg Ã¨ a 10 m di altezza. Calcola la sua energia potenziale (g=10 m/sÂ²)",
      "Applica la legge di Ohm: V=12V, R=4Î©, calcola I",
      "Converti: 72 km/h in m/s",
      "Un corpo cade da 20 m di altezza. Dopo quanto tempo tocca terra? (g=10 m/sÂ²)",
      "Calcola il peso di un oggetto di massa 8 kg"
    ],
    esercizi_avanzati:[
      "Un proiettile viene lanciato a 20 m/s. Calcola spazio e tempo per fermarsi (a=-4 m/sÂ²)",
      "Due cariche di +3Î¼C e -2Î¼C sono a 0,3 m. Calcola la forza elettrostatica",
      "Un circuito ha R1=6Î© e R2=3Î© in parallelo con V=12V. Calcola la resistenza totale e la corrente",
      "Enuncia e applica il principio di conservazione dell'energia in un esempio"
    ],
    teoria:["Ripassa le formule con le unitÃ  di misura","Studia le leggi fondamentali","Rileggi i grafici spazio-tempo e velocitÃ -tempo"],
    tips:["Scrivi SEMPRE le unitÃ  di misura","Disegna il diagramma delle forze","Controlla che il risultato abbia senso fisico"]
  },
  chimica:{
    esercizi_base:[
      "Scrivi la formula di: ossido di calcio, cloruro di sodio, acido solforico, idrossido di ferro(III)",
      "Bilancia: Hâ‚‚ + Oâ‚‚ â†’ Hâ‚‚O",
      "Bilancia: Fe + HCl â†’ FeClâ‚‚ + Hâ‚‚",
      "Quante moli ci sono in 44g di COâ‚‚? (M=44 g/mol)",
      "Qual Ã¨ il numero atomico e di massa del Carbonio? Quanti protoni, neutroni ed elettroni ha?",
      "Indica il gruppo e il periodo di: Na, Cl, Fe, O nella tavola periodica",
      "Scrivi la configurazione elettronica di: H, C, O, Na"
    ],
    esercizi_avanzati:[
      "Calcola la massa di NaCl necessaria per preparare 500 mL di soluzione 0,5 M",
      "Bilancia e classifica la reazione: CaCOâ‚ƒ â†’ CaO + COâ‚‚",
      "Spiega la differenza tra legame covalente polare e apolare con esempi",
      "Calcola il pH di una soluzione di HCl 0,01 M"
    ],
    teoria:["Ripassa la tavola periodica (gruppi e periodi)","Studia i tipi di legame chimico","Rileggi come bilanciare le equazioni"],
    tips:["Memorizza i simboli dei primi 20 elementi","Bilancia sempre atomo per atomo","Usa i coefficienti, non i pedici, per bilanciare"]
  },
  geografia:{
    esercizi_base:[
      "Indica su una mappa: i 5 oceani e i 7 continenti",
      "Qual Ã¨ la capitale di: Germania, Brasile, Australia, Giappone, Egitto?",
      "Descrivi il clima mediterraneo: caratteristiche, zone, vegetazione tipica",
      "Ordina per popolazione: Cina, India, USA, Indonesia, Brasile",
      "Cos'Ã¨ la densitÃ  di popolazione? Calcola quella di un paese con 60M abitanti e 300.000 kmÂ²",
      "Nomina i 3 fiumi piÃ¹ lunghi del mondo con i continenti in cui si trovano",
      "Differenza tra clima e tempo meteorologico: spiega con un esempio"
    ],
    esercizi_avanzati:[
      "Spiega il fenomeno El NiÃ±o e le sue conseguenze globali",
      "Analizza le cause dello spopolamento delle aree rurali italiane",
      "Confronta la densitÃ  demografica di Europa e Africa",
      "Descrivi la struttura interna della Terra e le sue conseguenze geologiche"
    ],
    teoria:["Ripassa le cartine fisiche e politiche","Studia i dati demografici principali","Rileggi i fenomeni climatici"],
    tips:["Studia SEMPRE con la cartina davanti","Collega geografia a storia ed economia","Usa mnemotecniche per le capitali"]
  },
  filosofia:{
    esercizi_base:[
      "Chi Ã¨ Socrate? Spiega il metodo maieutico in 5 righe",
      "Qual Ã¨ la differenza tra empirismo e razionalismo? Fai un esempio per ciascuno",
      "Riassumi la teoria delle Idee di Platone",
      "Cos'Ã¨ l'imperativo categorico di Kant? Fai un esempio pratico",
      "Spiega la dialettica hegeliana (tesi-antitesi-sintesi) con un esempio",
      "Chi Ã¨ Aristotele? Elenca 3 sue opere e i temi principali",
      "Differenza tra etica deontologica e consequenzialista"
    ],
    esercizi_avanzati:[
      "Confronta il pensiero di Platone e Aristotele sull'anima",
      "Analizza il pensiero di Nietzsche: volontÃ  di potenza e oltreuomo",
      "Spiega il problema mente-corpo nella filosofia moderna",
      "Commenta: 'Cogito ergo sum' di Cartesio â€” cosa significa e perchÃ© Ã¨ importante?"
    ],
    teoria:["Ripassa i filosofi per periodo storico","Studia i concetti chiave di ogni corrente","Rileggi le citazioni piÃ¹ famose"],
    tips:["Collega ogni filosofo al suo contesto storico","Spiega i concetti con esempi concreti","Fai schemi comparativi tra filosofi"]
  },
  latino:{
    esercizi_base:[
      "Declina al singolare e plurale: 'puella' (1Âª decl.) e 'dominus' (2Âª decl.)",
      "Coniuga 'amare' all'indicativo presente attivo (tutte le persone)",
      "Traduci: 'Puella in horto ambulat et flores videt'",
      "Indica il caso di ogni parola: 'Magistro discipuli libros dant'",
      "Trasforma dal singolare al plurale: 'Filius patri epistulam scribit'",
      "Riconosci le proposizioni in: 'Dico te errare quia multa ignoras'",
      "Coniuga 'esse' all'indicativo presente e imperfetto"
    ],
    esercizi_avanzati:[
      "Traduci e analizza: 'Caesar, postquam hostes vicit, Romam rediit'",
      "Individua e spiega l'ablativo assoluto in: 'Sole oriente, milites profecti sunt'",
      "Trasforma dalla proposizione infinitiva alla completiva con 'ut'",
      "Coniuga un verbo deponente (es. 'loquor') all'indicativo perfetto"
    ],
    teoria:["Ripassa tutte le declinazioni","Studia i tempi e modi verbali","Rileggi la sintassi dei casi"],
    tips:["Impara le desinenze come una tabella","Analizza prima di tradurre","Cerca i falsi amici con l'italiano"]
  },
  informatica:{
    esercizi_base:[
      "Converti il numero decimale 42 in binario",
      "Scrivi uno pseudocodice che calcola la somma dei numeri da 1 a 100",
      "Cosa fa questo codice? for i in range(5): print(i*2)",
      "Disegna il diagramma di flusso per: 'Leggi un numero, se Ã¨ pari stampa PARI altrimenti DISPARI'",
      "Qual Ã¨ la differenza tra RAM e ROM?",
      "Scrivi la query SQL per selezionare tutti gli studenti con voto > 7",
      "Cos'Ã¨ un algoritmo? Scrivi quello per fare una tazza di tÃ¨"
    ],
    esercizi_avanzati:[
      "Scrivi una funzione ricorsiva per calcolare il fattoriale di n",
      "Spiega la differenza tra lista e dizionario in Python con esempi",
      "Analizza la complessitÃ  di un algoritmo di ricerca lineare",
      "Scrivi una JOIN tra due tabelle: Studenti e Voti in SQL"
    ],
    teoria:["Ripassa i concetti di base dell'architettura","Studia i costrutti del linguaggio","Rileggi la teoria degli algoritmi"],
    tips:["Testa sempre il codice step by step","Usa i commenti per capire la logica","Parti da casi semplici e poi complica"]
  },
  arte:{
    esercizi_base:[
      "Descrivi la Gioconda di Leonardo: tecnica, soggetto, dettagli particolari",
      "Elenca le caratteristiche principali del Rinascimento italiano",
      "Chi Ã¨ Caravaggio? Spiega la tecnica del chiaroscuro con un suo dipinto",
      "Differenza tra Impressionismo e Post-impressionismo: artisti e caratteristiche",
      "Analizza La Notte Stellata di Van Gogh: colori, stile, stato d'animo",
      "Cosa rappresenta il Guernica di Picasso? In quale stile Ã¨ dipinto?",
      "Elenca 5 musei famosi nel mondo con le opere piÃ¹ importanti"
    ],
    esercizi_avanzati:[
      "Confronta la tecnica di Raffaello e Michelangelo nella Cappella Sistina",
      "Spiega come il Cubismo di Picasso rivoluzionÃ² l'arte del '900",
      "Analizza un'opera astratta: cosa comunica, quali tecniche usa",
      "Collega l'arte Barocca al suo contesto storico-religioso"
    ],
    teoria:["Ripassa i movimenti artistici in ordine cronologico","Studia gli artisti principali per periodo","Rileggi le caratteristiche delle tecniche pittoriche"],
    tips:["Guarda le immagini in alta risoluzione","Collega ogni opera al suo contesto","Usa le date per fissare i movimenti"]
  },
  musica:{
    esercizi_base:[
      "Scrivi le note della scala di Do maggiore in ordine",
      "Qual Ã¨ il valore di: semibreve, minima, semiminima, croma?",
      "Indica il tempo di: Allegro, Andante, Largo, Presto",
      "Chi Ã¨ Bach? Elenca 3 sue opere e il loro genere musicale",
      "Differenza tra musica barocca e classica: period, stile, compositori",
      "Cos'Ã¨ una sonata? E una sinfonia? Quanti movimenti hanno?",
      "Elenca gli strumenti dell'orchestra divisi per famiglia"
    ],
    esercizi_avanzati:[
      "Analizza la struttura di una fuga bachiana",
      "Confronta lo stile di Mozart e Beethoven con esempi di opere",
      "Spiega l'evoluzione dalla tonalitÃ  all'atonalitÃ  nel '900",
      "Descrivi le caratteristiche del Romanticismo musicale"
    ],
    teoria:["Ripassa le note e i valori ritmici","Studia i periodi storici della musica","Rileggi i generi musicali principali"],
    tips:["Ascolta le opere mentre studi","Batti il ritmo per memorizzare","Collega i compositori alla loro epoca"]
  },
  ed_fisica:{
    esercizi_base:[
      "Elenca e spiega le 5 capacitÃ  motorie fondamentali",
      "Quante persone giocano in una squadra di pallavolo? E di calcio? E di basket?",
      "Cos'Ã¨ il VOâ‚‚max? Come si misura e cosa indica?",
      "Spiega la differenza tra sport aerobico e anaerobico con 2 esempi ciascuno",
      "Descrivi le fasi di un corretto riscaldamento prima dell'attivitÃ  fisica",
      "Cosa sono le fibre muscolari lente e veloci? Quando vengono usate?",
      "Elenca i principi dell'allenamento sportivo (almeno 4)"
    ],
    esercizi_avanzati:[
      "Spiega il principio di supercompensazione nell'allenamento",
      "Analizza l'importanza dell'alimentazione per uno sportivo",
      "Descrivi le regole complete di uno sport a scelta",
      "Cos'Ã¨ il doping? Spiega effetti fisici e rischi per la salute"
    ],
    teoria:["Ripassa la fisiologia dell'esercizio","Studia le regole degli sport principali","Rileggi i principi dell'allenamento"],
    tips:["Collega sempre teoria e pratica","Usa schemi corporei per anatomia","Memorizza le regole con esempi di gioco"]
  },
  altra:{
    esercizi_base:[
      "Scrivi le 5 definizioni piÃ¹ importanti dell'argomento",
      "Elenca i 5 concetti chiave della materia e spiegali",
      "Crea 5 domande che potrebbe fare il professore e rispondici",
      "Spiega l'argomento come se dovessi insegnarlo a un compagno",
      "Scrivi un riassunto di 10 righe del capitolo principale",
      "Collega l'argomento a qualcosa che conosci giÃ  nella vita reale",
      "Crea una mappa concettuale con i collegamenti tra i temi"
    ],
    esercizi_avanzati:[
      "Analizza i pro e contro dell'argomento studiato",
      "Cerca un esempio pratico per ogni concetto teorico",
      "Scrivi 3 domande aperte con risposte complete",
      "Confronta due aspetti diversi dell'argomento"
    ],
    teoria:["Ripassa le definizioni fondamentali","Studia gli esempi principali","Rileggi le parti sottolineate"],
    tips:["Studia in blocchi da 25 minuti","Fai pause attive ogni ora","Spiega ad alta voce per fissare i concetti"]
  }
};

const MOTIVAZIONI_PER_LIVELLO=[
  ["ğŸ˜´","Partiamo dalle basi! Ogni esperto era un principiante. Anche 30 minuti oggi fanno la differenza. Ce la fai! ğŸ’ª"],
  ["ğŸ˜Ÿ","Hai giÃ  qualcosa su cui costruire! Concentrati sui punti deboli e vedrai miglioramenti rapidi. Forza! ğŸš€"],
  ["ğŸ˜","Sei a metÃ  strada, ottimo! Un po' di ripasso mirato e sarai pronto. Continua cosÃ¬! â­"],
  ["ğŸ˜Š","Quasi pronto! Ripassi veloci e riposo sono tutto quello che ti serve ora. Ottimo lavoro! ğŸ¯"],
  ["ğŸ”¥","Sei giÃ  preparato! Fai una revisione rapida, rilassati e dai il massimo domani. Sei una bomba! ğŸ†"]
];

function generaRipassoOffline(materia, argomento, tipo, livello){
  const db=RIPASSO_DB[materia]||RIPASSO_DB.altra;
  const [emoji, motivazione]=MOTIVAZIONI_PER_LIVELLO[livello-1];
  const mat=MATERIE.find(m=>m.id===materia);
  const matLabel=materia==="altra"?argomento:(mat?.label||"materia");
  const argTxt=argomento?` â€” "${argomento}"`:"";

  // Scegli gli esercizi in base al livello
  // Livello 1-2: esercizi base (piÃ¹ facili, con teoria prima)
  // Livello 3: metÃ  base metÃ  avanzati
  // Livello 4-5: esercizi avanzati (sfidanti)
  let pool=[];
  if(livello<=2){
    pool=[...db.esercizi_base];
  } else if(livello===3){
    pool=[...db.esercizi_base.slice(0,3),...(db.esercizi_avanzati||[]).slice(0,2)];
  } else {
    pool=[...(db.esercizi_avanzati||db.esercizi_base),...db.esercizi_base.slice(0,2)];
  }
  // Mescola un po' per variare
  pool.sort(()=>Math.random()-0.5);
  const numEsercizi=livello<=2?5:livello===3?4:4;
  const esercizi=pool.slice(0,numEsercizi);
  const teoria=db.teoria.slice(0,livello<=2?3:1);
  const tips=db.tips.slice(0,2);

  let piano=`${emoji} Ripasso: ${tipo||"Verifica"} di ${matLabel}${argTxt}\n`;
  piano+=`${"â”€".repeat(35)}\n\n`;

  if(livello<=2){
    piano+=`ğŸ“š PRIMA RIPASSA LA TEORIA\n`;
    teoria.forEach(t=>piano+=`â€¢ ${t}\n`);
    piano+=`\n`;
  }

  piano+=`âœï¸ ESERCIZI DA SVOLGERE\n\n`;
  esercizi.forEach((e,i)=>{
    piano+=`${i+1}. ${e}\n\n`;
  });

  if(argomento){
    piano+=`ğŸ¯ FOCUS SU: "${argomento}"\n`;
    piano+=`â€¢ Rileggi i tuoi appunti specifici su questo tema\n`;
    if(tipo==="Orale")piano+=`â€¢ Prova a spiegarlo ad alta voce senza guardare\n`;
    if(tipo==="Scritto"||tipo==="Test")piano+=`â€¢ Riscrivi le formule/regole principali a memoria\n`;
    piano+=`â€¢ Fai 2 esempi pratici sull'argomento\n`;
    piano+=`\n`;
  }

  piano+=`ğŸ’¡ CONSIGLI UTILI\n`;
  tips.forEach(t=>piano+=`â€¢ ${t}\n`);
  piano+=`\n${motivazione}`;
  return piano;
}


// â”€â”€ RICETTE DATABASE (ingredienti precisi) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const RICETTE_DB = {
  // PASTA
  "pasta al pomodoro":     {ingredienti:[{n:"Spaghetti o penne",q:"320g",c:"ğŸ¥«"},{n:"Pomodori pelati",q:"400g",c:"ğŸ¥«"},{n:"Aglio",q:"2 spicchi",c:"ğŸ¥¬"},{n:"Olio extravergine",q:"4 cucchiai",c:"ğŸ¥«"},{n:"Basilico fresco",q:"10 foglie",c:"ğŸ¥¬"},{n:"Sale",q:"q.b.",c:"ğŸ§‚"},{n:"Parmigiano",q:"50g",c:"ğŸ¥›"}], porzioni:4},
  "carbonara":             {ingredienti:[{n:"Spaghetti",q:"320g",c:"ğŸ¥«"},{n:"Guanciale",q:"150g",c:"ğŸ¥©"},{n:"Uova intere",q:"2",c:"ğŸ¥›"},{n:"Tuorli",q:"4",c:"ğŸ¥›"},{n:"Pecorino Romano",q:"100g",c:"ğŸ¥›"},{n:"Pepe nero",q:"q.b.",c:"ğŸ§‚"},{n:"Sale",q:"q.b.",c:"ğŸ§‚"}], porzioni:4},
  "amatriciana":           {ingredienti:[{n:"Bucatini",q:"320g",c:"ğŸ¥«"},{n:"Guanciale",q:"150g",c:"ğŸ¥©"},{n:"Pomodori pelati",q:"400g",c:"ğŸ¥«"},{n:"Pecorino Romano",q:"80g",c:"ğŸ¥›"},{n:"Peperoncino",q:"1",c:"ğŸ¥¬"},{n:"Vino bianco",q:"50ml",c:"ğŸ·"},{n:"Sale",q:"q.b.",c:"ğŸ§‚"}], porzioni:4},
  "cacio e pepe":          {ingredienti:[{n:"Spaghetti",q:"320g",c:"ğŸ¥«"},{n:"Pecorino Romano",q:"120g",c:"ğŸ¥›"},{n:"Pepe nero macinato",q:"2 cucchiaini",c:"ğŸ§‚"},{n:"Sale",q:"q.b.",c:"ğŸ§‚"}], porzioni:4},
  "pasta al pesto":        {ingredienti:[{n:"Trofie o linguine",q:"320g",c:"ğŸ¥«"},{n:"Basilico fresco",q:"50g",c:"ğŸ¥¬"},{n:"Pinoli",q:"30g",c:"ğŸŒ°"},{n:"Parmigiano",q:"50g",c:"ğŸ¥›"},{n:"Pecorino",q:"30g",c:"ğŸ¥›"},{n:"Aglio",q:"1 spicchio",c:"ğŸ¥¬"},{n:"Olio extravergine",q:"100ml",c:"ğŸ¥«"},{n:"Sale",q:"q.b.",c:"ğŸ§‚"}], porzioni:4},
  "lasagne":               {ingredienti:[{n:"Sfoglie di lasagna",q:"250g",c:"ğŸ¥«"},{n:"Carne macinata mista",q:"400g",c:"ğŸ¥©"},{n:"Pomodori pelati",q:"400g",c:"ğŸ¥«"},{n:"Besciamella",q:"500ml",c:"ğŸ¥›"},{n:"Parmigiano",q:"100g",c:"ğŸ¥›"},{n:"Cipolla",q:"1",c:"ğŸ¥¬"},{n:"Carota",q:"1",c:"ğŸ¥¬"},{n:"Sedano",q:"1 costa",c:"ğŸ¥¬"},{n:"Olio",q:"3 cucchiai",c:"ğŸ¥«"},{n:"Sale e pepe",q:"q.b.",c:"ğŸ§‚"}], porzioni:6},
  "pasta al forno":        {ingredienti:[{n:"Pasta corta (rigatoni/penne)",q:"320g",c:"ğŸ¥«"},{n:"RagÃ¹ di carne",q:"400g",c:"ğŸ¥©"},{n:"Mozzarella",q:"200g",c:"ğŸ¥›"},{n:"Parmigiano",q:"80g",c:"ğŸ¥›"},{n:"Pomodori pelati",q:"400g",c:"ğŸ¥«"},{n:"Basilico",q:"q.b.",c:"ğŸ¥¬"}], porzioni:4},
  "pasta e fagioli":       {ingredienti:[{n:"Pasta mista corta",q:"200g",c:"ğŸ¥«"},{n:"Fagioli borlotti",q:"400g (latta)",c:"ğŸ¥«"},{n:"Pancetta",q:"80g",c:"ğŸ¥©"},{n:"Aglio",q:"2 spicchi",c:"ğŸ¥¬"},{n:"Rosmarino",q:"1 rametto",c:"ğŸ¥¬"},{n:"Pomodori pelati",q:"200g",c:"ğŸ¥«"},{n:"Brodo vegetale",q:"1L",c:"ğŸ¥«"},{n:"Olio",q:"4 cucchiai",c:"ğŸ¥«"}], porzioni:4},
  "spaghetti alle vongole":{ingredienti:[{n:"Spaghetti",q:"320g",c:"ğŸ¥«"},{n:"Vongole",q:"1kg",c:"ğŸŸ"},{n:"Aglio",q:"3 spicchi",c:"ğŸ¥¬"},{n:"Prezzemolo",q:"1 mazzetto",c:"ğŸ¥¬"},{n:"Vino bianco",q:"100ml",c:"ğŸ·"},{n:"Olio extravergine",q:"5 cucchiai",c:"ğŸ¥«"},{n:"Peperoncino",q:"1",c:"ğŸ¥¬"}], porzioni:4},

  // RISOTTO
  "risotto":               {ingredienti:[{n:"Riso Carnaroli o Arborio",q:"320g",c:"ğŸ¥«"},{n:"Cipolla",q:"1",c:"ğŸ¥¬"},{n:"Vino bianco secco",q:"100ml",c:"ğŸ·"},{n:"Brodo caldo",q:"1,2L",c:"ğŸ¥«"},{n:"Burro",q:"60g",c:"ğŸ¥›"},{n:"Parmigiano",q:"80g",c:"ğŸ¥›"},{n:"Olio",q:"2 cucchiai",c:"ğŸ¥«"},{n:"Sale",q:"q.b.",c:"ğŸ§‚"}], porzioni:4},
  "risotto ai funghi":     {ingredienti:[{n:"Riso Carnaroli",q:"320g",c:"ğŸ¥«"},{n:"Funghi porcini (freschi o secchi)",q:"300g",c:"ğŸ„"},{n:"Cipolla",q:"1",c:"ğŸ¥¬"},{n:"Vino bianco",q:"100ml",c:"ğŸ·"},{n:"Brodo",q:"1,2L",c:"ğŸ¥«"},{n:"Burro",q:"60g",c:"ğŸ¥›"},{n:"Parmigiano",q:"80g",c:"ğŸ¥›"},{n:"Prezzemolo",q:"q.b.",c:"ğŸ¥¬"}], porzioni:4},

  // CARNE
  "pollo arrosto":         {ingredienti:[{n:"Pollo intero",q:"1,5kg",c:"ğŸ¥©"},{n:"Rosmarino",q:"3 rametti",c:"ğŸ¥¬"},{n:"Aglio",q:"4 spicchi",c:"ğŸ¥¬"},{n:"Limone",q:"1",c:"ğŸ‹"},{n:"Olio extravergine",q:"4 cucchiai",c:"ğŸ¥«"},{n:"Sale grosso",q:"q.b.",c:"ğŸ§‚"},{n:"Pepe",q:"q.b.",c:"ğŸ§‚"},{n:"Patate",q:"600g",c:"ğŸ¥¬"}], porzioni:4},
  "pollo al limone":       {ingredienti:[{n:"Petto di pollo",q:"600g",c:"ğŸ¥©"},{n:"Limoni",q:"2",c:"ğŸ‹"},{n:"Aglio",q:"2 spicchi",c:"ğŸ¥¬"},{n:"Farina",q:"3 cucchiai",c:"ğŸ¥«"},{n:"Burro",q:"30g",c:"ğŸ¥›"},{n:"Olio",q:"3 cucchiai",c:"ğŸ¥«"},{n:"Prezzemolo",q:"q.b.",c:"ğŸ¥¬"},{n:"Sale e pepe",q:"q.b.",c:"ğŸ§‚"}], porzioni:4},
  "cotoletta":             {ingredienti:[{n:"Fette di vitello o pollo",q:"4",c:"ğŸ¥©"},{n:"Uova",q:"2",c:"ğŸ¥›"},{n:"Pangrattato",q:"150g",c:"ğŸ¥«"},{n:"Farina",q:"50g",c:"ğŸ¥«"},{n:"Burro",q:"80g",c:"ğŸ¥›"},{n:"Sale",q:"q.b.",c:"ğŸ§‚"},{n:"Limone",q:"1",c:"ğŸ‹"}], porzioni:4},
  "bistecca":              {ingredienti:[{n:"Bistecca (fiorentina/controfiletto)",q:"800g",c:"ğŸ¥©"},{n:"Sale grosso",q:"q.b.",c:"ğŸ§‚"},{n:"Pepe nero",q:"q.b.",c:"ğŸ§‚"},{n:"Rosmarino",q:"2 rametti",c:"ğŸ¥¬"},{n:"Olio extravergine",q:"2 cucchiai",c:"ğŸ¥«"},{n:"Burro",q:"20g",c:"ğŸ¥›"}], porzioni:2},
  "hamburger":             {ingredienti:[{n:"Carne macinata di manzo",q:"500g",c:"ğŸ¥©"},{n:"Panini hamburger",q:"4",c:"ğŸ¥«"},{n:"Lattuga",q:"4 foglie",c:"ğŸ¥¬"},{n:"Pomodori",q:"2",c:"ğŸ¥¬"},{n:"Cipolla rossa",q:"1",c:"ğŸ¥¬"},{n:"Formaggio cheddar",q:"4 fette",c:"ğŸ¥›"},{n:"Sale e pepe",q:"q.b.",c:"ğŸ§‚"},{n:"Ketchup/maionese",q:"q.b.",c:"ğŸ¥«"}], porzioni:4},
  "polpette":              {ingredienti:[{n:"Carne macinata mista",q:"500g",c:"ğŸ¥©"},{n:"Pane raffermo",q:"100g",c:"ğŸ¥«"},{n:"Latte",q:"100ml",c:"ğŸ¥›"},{n:"Uova",q:"2",c:"ğŸ¥›"},{n:"Parmigiano",q:"50g",c:"ğŸ¥›"},{n:"Prezzemolo",q:"q.b.",c:"ğŸ¥¬"},{n:"Aglio",q:"1 spicchio",c:"ğŸ¥¬"},{n:"Sale e pepe",q:"q.b.",c:"ğŸ§‚"},{n:"Pomodori pelati",q:"400g",c:"ğŸ¥«"}], porzioni:4},
  "ragÃ¹":                  {ingredienti:[{n:"Carne macinata mista",q:"400g",c:"ğŸ¥©"},{n:"Pomodori pelati",q:"400g",c:"ğŸ¥«"},{n:"Cipolla",q:"1",c:"ğŸ¥¬"},{n:"Carota",q:"1",c:"ğŸ¥¬"},{n:"Sedano",q:"1 costa",c:"ğŸ¥¬"},{n:"Vino rosso",q:"100ml",c:"ğŸ·"},{n:"Olio",q:"3 cucchiai",c:"ğŸ¥«"},{n:"Latte",q:"50ml",c:"ğŸ¥›"},{n:"Sale",q:"q.b.",c:"ğŸ§‚"}], porzioni:4},

  // PESCE
  "salmone":               {ingredienti:[{n:"Filetti di salmone",q:"600g",c:"ğŸŸ"},{n:"Limone",q:"1",c:"ğŸ‹"},{n:"Olio extravergine",q:"3 cucchiai",c:"ğŸ¥«"},{n:"Aneto o prezzemolo",q:"q.b.",c:"ğŸ¥¬"},{n:"Aglio",q:"1 spicchio",c:"ğŸ¥¬"},{n:"Sale e pepe",q:"q.b.",c:"ğŸ§‚"}], porzioni:4},
  "baccalÃ ":               {ingredienti:[{n:"BaccalÃ  giÃ  ammollato",q:"600g",c:"ğŸŸ"},{n:"Pomodori pelati",q:"400g",c:"ğŸ¥«"},{n:"Olive nere",q:"80g",c:"ğŸ¥¬"},{n:"Capperi",q:"2 cucchiai",c:"ğŸ¥¬"},{n:"Aglio",q:"2 spicchi",c:"ğŸ¥¬"},{n:"Prezzemolo",q:"q.b.",c:"ğŸ¥¬"},{n:"Olio",q:"4 cucchiai",c:"ğŸ¥«"}], porzioni:4},

  // PIZZA
  "pizza":                 {ingredienti:[{n:"Farina 00",q:"500g",c:"ğŸ¥«"},{n:"Lievito di birra fresco",q:"12g",c:"ğŸ¥«"},{n:"Acqua tiepida",q:"300ml",c:"ğŸ’§"},{n:"Sale",q:"10g",c:"ğŸ§‚"},{n:"Olio extravergine",q:"2 cucchiai",c:"ğŸ¥«"},{n:"Pomodori pelati",q:"400g",c:"ğŸ¥«"},{n:"Mozzarella fior di latte",q:"300g",c:"ğŸ¥›"},{n:"Basilico",q:"q.b.",c:"ğŸ¥¬"}], porzioni:4},
  "pizza margherita":      {ingredienti:[{n:"Farina 00",q:"500g",c:"ğŸ¥«"},{n:"Lievito di birra fresco",q:"12g",c:"ğŸ¥«"},{n:"Acqua tiepida",q:"300ml",c:"ğŸ’§"},{n:"Sale",q:"10g",c:"ğŸ§‚"},{n:"Olio extravergine",q:"2 cucchiai",c:"ğŸ¥«"},{n:"Pomodori San Marzano",q:"400g",c:"ğŸ¥«"},{n:"Mozzarella di bufala",q:"250g",c:"ğŸ¥›"},{n:"Basilico fresco",q:"10 foglie",c:"ğŸ¥¬"}], porzioni:4},

  // DOLCI
  "tiramisÃ¹":              {ingredienti:[{n:"Mascarpone",q:"500g",c:"ğŸ¥›"},{n:"Uova",q:"4",c:"ğŸ¥›"},{n:"Zucchero",q:"100g",c:"ğŸ§‚"},{n:"Savoiardi",q:"300g",c:"ğŸ§"},{n:"CaffÃ¨ espresso",q:"300ml",c:"â˜•"},{n:"Cacao amaro",q:"3 cucchiai",c:"ğŸ§"},{n:"Marsala (opzionale)",q:"2 cucchiai",c:"ğŸ·"}], porzioni:8},
  "panna cotta":           {ingredienti:[{n:"Panna fresca",q:"500ml",c:"ğŸ¥›"},{n:"Zucchero",q:"80g",c:"ğŸ§‚"},{n:"Gelatina in fogli",q:"8g",c:"ğŸ§"},{n:"Vaniglia",q:"1 bacca",c:"ğŸ§"},{n:"Frutti di bosco",q:"200g (per salsa)",c:"ğŸ“"}], porzioni:6},
  "torta al cioccolato":   {ingredienti:[{n:"Cioccolato fondente",q:"200g",c:"ğŸ«"},{n:"Burro",q:"150g",c:"ğŸ¥›"},{n:"Zucchero",q:"180g",c:"ğŸ§‚"},{n:"Uova",q:"4",c:"ğŸ¥›"},{n:"Farina",q:"100g",c:"ğŸ¥«"},{n:"Cacao amaro",q:"30g",c:"ğŸ«"},{n:"Lievito",q:"1 bustina",c:"ğŸ§"},{n:"Sale",q:"1 pizzico",c:"ğŸ§‚"}], porzioni:8},
  "cheesecake":            {ingredienti:[{n:"Biscotti Digestive",q:"200g",c:"ğŸ§"},{n:"Burro fuso",q:"100g",c:"ğŸ¥›"},{n:"Formaggio spalmabile (Philadelphia)",q:"600g",c:"ğŸ¥›"},{n:"Zucchero",q:"150g",c:"ğŸ§‚"},{n:"Uova",q:"3",c:"ğŸ¥›"},{n:"Panna fresca",q:"100ml",c:"ğŸ¥›"},{n:"Succo di limone",q:"1",c:"ğŸ‹"},{n:"Vaniglia",q:"1 cucchiaino",c:"ğŸ§"}], porzioni:8},
  "crostata":              {ingredienti:[{n:"Farina",q:"300g",c:"ğŸ¥«"},{n:"Burro freddo",q:"150g",c:"ğŸ¥›"},{n:"Zucchero",q:"100g",c:"ğŸ§‚"},{n:"Uova",q:"2",c:"ğŸ¥›"},{n:"Marmellata",q:"300g",c:"ğŸ§"},{n:"Scorza di limone",q:"1",c:"ğŸ‹"},{n:"Sale",q:"1 pizzico",c:"ğŸ§‚"}], porzioni:8},
  "pancakes":              {ingredienti:[{n:"Farina",q:"200g",c:"ğŸ¥«"},{n:"Latte",q:"250ml",c:"ğŸ¥›"},{n:"Uova",q:"2",c:"ğŸ¥›"},{n:"Zucchero",q:"30g",c:"ğŸ§‚"},{n:"Lievito per dolci",q:"1 bustina",c:"ğŸ§"},{n:"Burro fuso",q:"30g",c:"ğŸ¥›"},{n:"Sale",q:"1 pizzico",c:"ğŸ§‚"},{n:"Sciroppo d'acero",q:"q.b.",c:"ğŸ§"}], porzioni:4},
  "muffin":                {ingredienti:[{n:"Farina",q:"250g",c:"ğŸ¥«"},{n:"Zucchero",q:"150g",c:"ğŸ§‚"},{n:"Latte",q:"120ml",c:"ğŸ¥›"},{n:"Uova",q:"2",c:"ğŸ¥›"},{n:"Olio di semi",q:"80ml",c:"ğŸ¥«"},{n:"Lievito",q:"1 bustina",c:"ğŸ§"},{n:"Gocce di cioccolato",q:"100g",c:"ğŸ«"},{n:"Sale",q:"1 pizzico",c:"ğŸ§‚"}], porzioni:12},
  "biscotti":              {ingredienti:[{n:"Farina",q:"300g",c:"ğŸ¥«"},{n:"Burro morbido",q:"150g",c:"ğŸ¥›"},{n:"Zucchero",q:"120g",c:"ğŸ§‚"},{n:"Uova",q:"1",c:"ğŸ¥›"},{n:"Vaniglia",q:"1 cucchiaino",c:"ğŸ§"},{n:"Lievito",q:"1/2 bustina",c:"ğŸ§"},{n:"Sale",q:"1 pizzico",c:"ğŸ§‚"}], porzioni:30},
  "gelato":                {ingredienti:[{n:"Latte intero",q:"500ml",c:"ğŸ¥›"},{n:"Panna fresca",q:"200ml",c:"ğŸ¥›"},{n:"Tuorli",q:"4",c:"ğŸ¥›"},{n:"Zucchero",q:"150g",c:"ğŸ§‚"},{n:"Vaniglia",q:"1 bacca",c:"ğŸ§"}], porzioni:6},

  // ZUPPE E MINESTRE
  "minestrone":            {ingredienti:[{n:"Patate",q:"2",c:"ğŸ¥¬"},{n:"Carote",q:"2",c:"ğŸ¥¬"},{n:"Zucchine",q:"2",c:"ğŸ¥¬"},{n:"Fagioli borlotti",q:"200g",c:"ğŸ¥«"},{n:"Piselli",q:"100g",c:"ğŸ¥¬"},{n:"Pomodori pelati",q:"200g",c:"ğŸ¥«"},{n:"Cipolla",q:"1",c:"ğŸ¥¬"},{n:"Sedano",q:"2 coste",c:"ğŸ¥¬"},{n:"Brodo vegetale",q:"1,5L",c:"ğŸ¥«"},{n:"Olio",q:"4 cucchiai",c:"ğŸ¥«"},{n:"Pasta o riso",q:"100g",c:"ğŸ¥«"}], porzioni:6},
  "zuppa di lenticchie":   {ingredienti:[{n:"Lenticchie rosse",q:"300g",c:"ğŸ¥«"},{n:"Cipolla",q:"1",c:"ğŸ¥¬"},{n:"Carota",q:"2",c:"ğŸ¥¬"},{n:"Sedano",q:"2 coste",c:"ğŸ¥¬"},{n:"Pomodori pelati",q:"200g",c:"ğŸ¥«"},{n:"Curcuma",q:"1 cucchiaino",c:"ğŸ§‚"},{n:"Cumino",q:"1 cucchiaino",c:"ğŸ§‚"},{n:"Brodo",q:"1L",c:"ğŸ¥«"},{n:"Olio",q:"3 cucchiai",c:"ğŸ¥«"}], porzioni:4},
  "ribollita":             {ingredienti:[{n:"Cavolo nero",q:"300g",c:"ğŸ¥¬"},{n:"Fagioli cannellini",q:"400g",c:"ğŸ¥«"},{n:"Pane raffermo toscano",q:"200g",c:"ğŸ¥«"},{n:"Patate",q:"2",c:"ğŸ¥¬"},{n:"Pomodori pelati",q:"200g",c:"ğŸ¥«"},{n:"Cipolla",q:"1",c:"ğŸ¥¬"},{n:"Carota",q:"1",c:"ğŸ¥¬"},{n:"Sedano",q:"2 coste",c:"ğŸ¥¬"},{n:"Olio extravergine",q:"6 cucchiai",c:"ğŸ¥«"}], porzioni:6},

  // UOVA
  "frittata":              {ingredienti:[{n:"Uova",q:"6",c:"ğŸ¥›"},{n:"Parmigiano",q:"40g",c:"ğŸ¥›"},{n:"Sale e pepe",q:"q.b.",c:"ğŸ§‚"},{n:"Olio o burro",q:"2 cucchiai",c:"ğŸ¥«"},{n:"Ripieno a scelta (verdure/prosciutto)",q:"200g",c:"ğŸ¥¬"}], porzioni:4},
  "uova strapazzate":      {ingredienti:[{n:"Uova",q:"4",c:"ğŸ¥›"},{n:"Burro",q:"20g",c:"ğŸ¥›"},{n:"Panna",q:"2 cucchiai",c:"ğŸ¥›"},{n:"Sale e pepe",q:"q.b.",c:"ğŸ§‚"},{n:"Erba cipollina",q:"q.b.",c:"ğŸ¥¬"}], porzioni:2},

  // VERDURE E CONTORNI
  "melanzane alla parmigiana":{ingredienti:[{n:"Melanzane",q:"1kg",c:"ğŸ¥¬"},{n:"Pomodori pelati",q:"600g",c:"ğŸ¥«"},{n:"Mozzarella",q:"250g",c:"ğŸ¥›"},{n:"Parmigiano",q:"80g",c:"ğŸ¥›"},{n:"Basilico",q:"q.b.",c:"ğŸ¥¬"},{n:"Olio per friggere",q:"q.b.",c:"ğŸ¥«"},{n:"Sale",q:"q.b.",c:"ğŸ§‚"}], porzioni:6},
  "insalata caprese":      {ingredienti:[{n:"Pomodori maturi",q:"4",c:"ğŸ¥¬"},{n:"Mozzarella di bufala",q:"250g",c:"ğŸ¥›"},{n:"Basilico fresco",q:"1 mazzetto",c:"ğŸ¥¬"},{n:"Olio extravergine",q:"3 cucchiai",c:"ğŸ¥«"},{n:"Sale grosso",q:"q.b.",c:"ğŸ§‚"},{n:"Pepe",q:"q.b.",c:"ğŸ§‚"}], porzioni:4},
  "patate al forno":       {ingredienti:[{n:"Patate",q:"1kg",c:"ğŸ¥¬"},{n:"Rosmarino",q:"3 rametti",c:"ğŸ¥¬"},{n:"Aglio",q:"3 spicchi",c:"ğŸ¥¬"},{n:"Olio extravergine",q:"4 cucchiai",c:"ğŸ¥«"},{n:"Sale grosso",q:"q.b.",c:"ğŸ§‚"},{n:"Pepe",q:"q.b.",c:"ğŸ§‚"}], porzioni:4},

  // PANE
  "pane":                  {ingredienti:[{n:"Farina 0",q:"500g",c:"ğŸ¥«"},{n:"Lievito di birra fresco",q:"15g",c:"ğŸ¥«"},{n:"Acqua tiepida",q:"320ml",c:"ğŸ’§"},{n:"Sale",q:"10g",c:"ğŸ§‚"},{n:"Olio extravergine",q:"2 cucchiai",c:"ğŸ¥«"}], porzioni:1},
  "focaccia":              {ingredienti:[{n:"Farina 00",q:"500g",c:"ğŸ¥«"},{n:"Lievito di birra fresco",q:"15g",c:"ğŸ¥«"},{n:"Acqua tiepida",q:"350ml",c:"ğŸ’§"},{n:"Olio extravergine",q:"6 cucchiai",c:"ğŸ¥«"},{n:"Sale",q:"10g",c:"ğŸ§‚"},{n:"Rosmarino",q:"q.b.",c:"ğŸ¥¬"},{n:"Sale grosso",q:"q.b.",c:"ğŸ§‚"}], porzioni:6},
};

// Cerca la ricetta migliore nel testo inserito
function trovaRicetta(input) {
  const testo = input.toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"") // rimuovi accenti
    .replace(/[Ã Ã¡Ã¢Ã£]/g,"a").replace(/[Ã¨Ã©Ãª]/g,"e").replace(/[Ã¬Ã­Ã®]/g,"i")
    .replace(/[Ã²Ã³Ã´]/g,"o").replace(/[Ã¹ÃºÃ»]/g,"u");

  // Alias per gestire varianti
  const alias = {
    "carbonara":["carbonara","carb"],
    "amatriciana":["amatriciana","amatrix"],
    "cacio e pepe":["cacio e pepe","cacio"],
    "pasta al pomodoro":["pomodoro","al sugo","sugo di pomodoro","pasta semplice"],
    "pasta al pesto":["pesto","al pesto"],
    "pasta e fagioli":["pasta e fagioli","pasta fagioli"],
    "spaghetti alle vongole":["vongole","alle vongole"],
    "lasagne":["lasagne","lasagna"],
    "pasta al forno":["pasta al forno","forno"],
    "risotto ai funghi":["risotto ai funghi","funghi"],
    "risotto":["risotto"],
    "pollo arrosto":["pollo arrosto","arrosto"],
    "pollo al limone":["pollo al limone","pollo limone"],
    "cotoletta":["cotoletta","milanese"],
    "bistecca":["bistecca","fiorentina","tagliata"],
    "hamburger":["hamburger","burger"],
    "polpette":["polpette","polpetta"],
    "ragu":["ragu","bolognese","al ragu"],
    "salmone":["salmone"],
    "baccala":["baccala","stoccafisso"],
    "pizza margherita":["margherita"],
    "pizza":["pizza"],
    "tiramisu":["tiramisu"],
    "panna cotta":["panna cotta","pannacotta"],
    "torta al cioccolato":["torta al cioccolato","torta cioccolato","dolce cioccolato"],
    "cheesecake":["cheesecake","cheese cake"],
    "crostata":["crostata","crostata marmellata"],
    "pancakes":["pancakes","pancake"],
    "muffin":["muffin"],
    "biscotti":["biscotti","biscotto","cookies"],
    "gelato":["gelato"],
    "minestrone":["minestrone","minestra"],
    "zuppa di lenticchie":["lenticchie","zuppa lenticchie"],
    "ribollita":["ribollita"],
    "frittata":["frittata"],
    "uova strapazzate":["uova strapazzate","strapazzate"],
    "melanzane alla parmigiana":["parmigiana","melanzane parmigiana"],
    "insalata caprese":["caprese","insalata caprese"],
    "patate al forno":["patate al forno","patate"],
    "pane":["pane fatto in casa","pane"],
    "focaccia":["focaccia"],
  };

  // Cerca match
  for(const [chiave, varianti] of Object.entries(alias)){
    for(const v of varianti){
      if(testo.includes(v)){
        // Trova la ricetta giusta nel DB
        const nomeDB = Object.keys(RICETTE_DB).find(k=>k===chiave||k.includes(chiave.split(" ")[0]));
        if(nomeDB && RICETTE_DB[nomeDB]) return {nome:nomeDB, ricetta:RICETTE_DB[nomeDB]};
      }
    }
  }
  return null;
}

function generaListaSpesaOffline(piatti){
  const righe = piatti.split(/[\n,]+/).map(r=>r.trim()).filter(r=>r.length>1);
  const listaUnificata = [];
  const ricetteTrovate = [];
  const nonTrovate = [];

  for(const riga of righe){
    const match = trovaRicetta(riga);
    if(match){
      ricetteTrovate.push(match.nome);
      for(const ing of match.ricetta.ingredienti){
        const esistente = listaUnificata.find(i=>i.nome.toLowerCase()===ing.n.toLowerCase());
        if(!esistente) listaUnificata.push({nome:ing.n, quantita:ing.q, categoria:ing.c});
      }
    } else {
      nonTrovate.push(riga);
    }
  }

  // Se non trova niente usa ricette di base
  if(listaUnificata.length===0){
    return {
      lista:[
        {nome:"Ingrediente principale",quantita:"400g",categoria:"ğŸ¥©"},
        {nome:"Olio extravergine",quantita:"q.b.",categoria:"ğŸ¥«"},
        {nome:"Sale e pepe",quantita:"q.b.",categoria:"ğŸ§‚"},
        {nome:"Aglio",quantita:"2 spicchi",categoria:"ğŸ¥¬"},
      ],
      suggerimenti:[{nome:"Scrivi il nome del piatto",motivo:"Es: pasta carbonara, pizza, tiramisÃ¹"}],
      ricetteTrovate:[],
      nonTrovate:righe
    };
  }

  const suggerimenti = [];
  if(nonTrovate.length>0) suggerimenti.push({nome:"Ricetta non trovata: "+nonTrovate.join(", "), motivo:"Prova a scrivere il nome per esteso"});
  suggerimenti.push({nome:"Acqua minerale",motivo:"Sempre utile"});
  if(!listaUnificata.find(i=>i.nome.toLowerCase().includes("olio")))
    suggerimenti.push({nome:"Olio extravergine",motivo:"Base di quasi tutte le ricette"});

  return {lista:listaUnificata, suggerimenti, ricetteTrovate, nonTrovate};
}

// â”€â”€ METEO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function useMeteo(){
  const [meteo,setMeteo]=useState(null);
  useEffect(()=>{
    if(!navigator.geolocation){return;}
    navigator.geolocation.getCurrentPosition(async pos=>{
      try{
        const {latitude:lat,longitude:lon}=pos.coords;
        const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`);
        const d=await r.json();
        const temp=Math.round(d.current.temperature_2m);
        const code=d.current.weather_code;
        const icon=code<=1?"â˜€ï¸":code<=3?"â›…":code<=48?"ğŸŒ«ï¸":code<=67?"ğŸŒ§ï¸":code<=77?"ğŸŒ¨ï¸":code<=82?"ğŸŒ§ï¸":"â›ˆï¸";
        setMeteo({temp,icon});
      }catch{}
    },()=>{},{timeout:5000});
  },[]);
  return meteo;
}

// â”€â”€ SWIPEABLE CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function SwipeCalendar({year,month,events,alerts,onDay,onMonthChange}){
  const containerRef=useRef(null);
  const startX=useRef(null);
  const startY=useRef(null);
  const currentX=useRef(0);
  const isDragging=useRef(false);
  const hasMoved=useRef(false);
  const [offset,setOffset]=useState(0);
  const [animating,setAnimating]=useState(false);
  const W=useRef(375);

  useEffect(()=>{if(containerRef.current)W.current=containerRef.current.offsetWidth;},[]);

  const onTouchStart=e=>{
    if(animating)return;
    startX.current=e.touches[0].clientX;
    startY.current=e.touches[0].clientY;
    isDragging.current=false;
    hasMoved.current=false;
  };
  const onTouchMove=e=>{
    if(startX.current===null)return;
    const dx=e.touches[0].clientX-startX.current;
    const dy=Math.abs(e.touches[0].clientY-startY.current);
    if(!isDragging.current){
      if(dy>Math.abs(dx)||Math.abs(dx)<8)return;
      isDragging.current=true;
    }
    e.preventDefault();
    hasMoved.current=Math.abs(dx)>12;
    currentX.current=dx;
    setOffset(dx);
  };
  const onTouchEnd=e=>{
    if(!isDragging.current){startX.current=null;return;}
    const dx=currentX.current;
    const threshold=W.current*0.28;
    setAnimating(true);
    if(dx<-threshold){
      setOffset(-W.current);
      setTimeout(()=>{const n=addMonths(year,month,1);onMonthChange(n.year,n.month);setOffset(0);setAnimating(false);},280);
    } else if(dx>threshold){
      setOffset(W.current);
      setTimeout(()=>{const n=addMonths(year,month,-1);onMonthChange(n.year,n.month);setOffset(0);setAnimating(false);},280);
    } else {
      setOffset(0);
      setTimeout(()=>setAnimating(false),280);
    }
    startX.current=null;
    isDragging.current=false;
    currentX.current=0;
  };

  // Only fire onDay if swipe did NOT move significantly
  const handleDayClick=useCallback((key)=>{
    if(!hasMoved.current&&!animating) onDay(key);
  },[animating]);

  const prev=addMonths(year,month,-1);
  const next=addMonths(year,month,1);

  return (
    <div ref={containerRef} style={{overflow:"hidden",touchAction:"pan-y"}}
      onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
      <div style={{display:"flex",width:"300%",transform:`translateX(calc(-33.333% + ${offset}px))`,transition:animating?"transform 0.28s cubic-bezier(0.25,0.46,0.45,0.94)":"none",willChange:"transform"}}>
        <div style={{width:"33.333%",flexShrink:0}}><MonthGrid year={prev.year} month={prev.month} events={events} alerts={alerts} onDay={handleDayClick}/></div>
        <div style={{width:"33.333%",flexShrink:0}}><MonthGrid year={year} month={month} events={events} alerts={alerts} onDay={handleDayClick}/></div>
        <div style={{width:"33.333%",flexShrink:0}}><MonthGrid year={next.year} month={next.month} events={events} alerts={alerts} onDay={handleDayClick}/></div>
      </div>
    </div>
  );
}

function MonthGrid({year,month,events,alerts,onDay}){
  const {dark}=React.useContext(ThemeCtx);
  const fd=firstDay(year,month),td=daysIn(year,month);
  const getDay=k=>events[k]||[];
  return (
    <div style={{padding:"0 4px"}}>
      <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",marginBottom:"4px"}}>
        {DAYS.map((d,i)=><div key={i} style={{textAlign:"center",fontSize:"11px",fontWeight:"600",color:i>=5?"#FF9500":dark?"rgba(255,255,255,0.3)":"rgba(60,60,67,0.38)",padding:"3px 0"}}>{d}</div>)}
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",rowGap:"1px"}}>
        {Array.from({length:fd},(_,i)=><div key={`e${i}`}/>)}
        {Array.from({length:td},(_,i)=>{
          const day=i+1,key=fmt(year,month,day);
          const evs=getDay(key),isT=key===todayStr,isW=(fd+i)%7>=5;
          const isPast=key<todayStr;
          const cats=[...new Set(evs.map(e=>e.category))].slice(0,3);
          const hasAl=alerts.some(a=>a.day===key);
          const diff=daysBetween(key);
          return (
            <div key={key} onClick={()=>onDay(key)}
              style={{aspectRatio:"1",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",cursor:"pointer",position:"relative",borderRadius:"50%",WebkitTapHighlightColor:"transparent"}}>
              {isT&&<div style={{position:"absolute",inset:"8%",borderRadius:"50%",background:"#FF3B30"}}/>}
              {hasAl&&!isT&&<div style={{position:"absolute",inset:"8%",borderRadius:"50%",border:"1.5px solid #FF3B30"}}/>}
              <div style={{fontSize:"15px",fontWeight:isT?"600":"400",color:isT?"#fff":isPast?(dark?"rgba(255,255,255,0.18)":"rgba(60,60,67,0.22)"):isW?"#FF9500":dark?"#fff":"#1C1C1E",position:"relative",zIndex:1,lineHeight:1,marginBottom:cats.length?"3px":"0"}}>{day}</div>
              {cats.length>0&&<div style={{display:"flex",gap:"2px",position:"relative",zIndex:1}}>{cats.map(cid=><div key={cid} style={{width:"4px",height:"4px",borderRadius:"50%",background:isT?"rgba(255,255,255,0.85)":getCat(cid).color}}/>)}</div>}
              {/* Countdown badge for verifiche */}
              {!isT&&diff>0&&diff<=5&&evs.some(e=>e.category==="verifica")&&(
                <div style={{position:"absolute",top:"-1px",right:"-1px",background:"#FF3B30",borderRadius:"6px",padding:"1px 3px",fontSize:"8px",fontWeight:"700",color:"#fff",zIndex:2,lineHeight:1}}>{diff}g</div>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}

// â”€â”€ GEMINI KEY SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function GeminiSetup({onDone,onClose,dark}){
  const [key,setKey]=useState(getGeminiKey());
  const [testing,setTesting]=useState(false);
  const [err,setErr]=useState("");
  const bg=dark?"#1C1C1E":"#F2F2F7";
  const card=dark?"#2C2C2E":"#fff";
  const txt=dark?"#fff":"#1C1C1E";
  const sub=dark?"rgba(255,255,255,0.4)":"rgba(60,60,67,0.45)";

  const test=async()=>{
    if(!key.trim())return;
    setTesting(true);setErr("");
    try{
      await callAI("Rispondi solo con: OK");
      saveGeminiKey(key.trim());
      onDone();
    }catch(e){
      if(e.message==="NO_KEY")
        setErr("âŒ Inserisci la chiave prima.");
      else if(e.message.startsWith("RETE:"))
        setErr("âŒ Errore di rete â€” controlla la connessione internet.");
      else if(e.message.startsWith("GEMINI:"))
        setErr("âŒ "+e.message.replace("GEMINI: ",""));
      else
        setErr("âŒ "+e.message);
    }
    setTesting(false);
  };

  return (
    <div style={{padding:"0 16px 16px"}}>
      <div style={{background:card,borderRadius:"16px",padding:"16px",marginBottom:"14px"}}>
        <div style={{fontSize:"15px",fontWeight:"700",color:txt,marginBottom:"6px"}}>ğŸ”‘ Configura Gemini AI</div>
        <div style={{fontSize:"13px",color:sub,lineHeight:1.5,marginBottom:"14px"}}>
          Per usare il Ripasso AI e la Lista Spesa ti serve una chiave gratuita di Google Gemini.
        </div>
        <div style={{background:dark?"rgba(0,122,255,0.15)":"rgba(0,122,255,0.08)",borderRadius:"12px",padding:"12px",marginBottom:"14px"}}>
          <div style={{fontSize:"13px",fontWeight:"600",color:"#007AFF",marginBottom:"6px"}}>Come ottenerla (2 min):</div>
          <div style={{fontSize:"13px",color:txt,lineHeight:1.7}}>
            1. Vai su <span style={{fontWeight:"600"}}>aistudio.google.com</span>{"\n"}
            2. Accedi con Google{"\n"}
            3. Clicca <span style={{fontWeight:"600"}}>"Get API Key"</span> â†’ <span style={{fontWeight:"600"}}>"Create API key"</span>{"\n"}
            4. Copia la chiave e incollala qui sotto
          </div>
        </div>
        <input
          value={key}
          onChange={e=>setKey(e.target.value)}
          placeholder="AIzaSy..."
          style={{width:"100%",padding:"12px 14px",border:`1.5px solid ${err?"#FF3B30":dark?"rgba(255,255,255,0.1)":"rgba(60,60,67,0.15)"}`,borderRadius:"12px",fontSize:"14px",fontFamily:"monospace",color:txt,background:dark?"rgba(255,255,255,0.05)":"#fff",outline:"none",display:"block",userSelect:"text"}}
        />
        {err&&<div style={{fontSize:"12px",color:"#FF3B30",marginTop:"8px"}}>{err}</div>}
      </div>
      <button onClick={test} disabled={!key.trim()||testing} style={{width:"100%",padding:"14px",borderRadius:"14px",border:"none",background:key.trim()?"#007AFF":"rgba(60,60,67,0.1)",color:key.trim()?"#fff":"rgba(60,60,67,0.3)",fontFamily:"inherit",fontSize:"15px",fontWeight:"600",cursor:key.trim()?"pointer":"default",marginBottom:"8px",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"}}>
        {testing?<><span className="pulse">â³</span>Verifico la chiaveâ€¦</>:"Salva e continua â†’"}
      </button>
      <button onClick={onClose} style={{width:"100%",padding:"12px",borderRadius:"14px",border:"none",background:"transparent",color:sub,fontFamily:"inherit",fontSize:"14px",cursor:"pointer"}}>Annulla</button>
    </div>
  );
}

// â”€â”€ AI PANEL: ESERCIZI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ DATABASE CONTENUTI PER MATERIA (PDF) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CONTENUTI_DB = {
  matematica: {
    icona:"ğŸ“",
    sezioni:[
      {titolo:"Algebra â€” Equazioni",contenuto:`EQUAZIONI DI PRIMO GRADO
Forma: ax + b = 0  â†’  x = -b/a

Regole fondamentali:
â€¢ Puoi aggiungere/sottrarre lo stesso numero da entrambi i membri
â€¢ Puoi moltiplicare/dividere entrambi i membri per lo stesso numero (â‰ 0)
â€¢ Tutto ciÃ² che passa da un membro cambia segno

Esempio: 3x - 6 = 9
         3x = 9 + 6 = 15
         x = 15/3 = 5   âœ“ Verifica: 3(5)-6=9 âœ“

EQUAZIONI DI SECONDO GRADO
Forma: axÂ² + bx + c = 0

Formula quadratica: x = (-b Â± âˆš(bÂ²-4ac)) / 2a
Discriminante: Î” = bÂ² - 4ac
â€¢ Î” > 0  â†’  2 soluzioni reali distinte
â€¢ Î” = 0  â†’  1 soluzione reale doppia
â€¢ Î” < 0  â†’  nessuna soluzione reale

Esempio: xÂ² - 5x + 6 = 0
Î” = 25 - 24 = 1  â†’  x = (5Â±1)/2  â†’  xâ‚=3, xâ‚‚=2`},
      {titolo:"Geometria â€” Formule Area e Perimetro",contenuto:`FIGURE PIANE
Quadrato:    P = 4l       A = lÂ²
Rettangolo:  P = 2(b+h)   A = bÃ—h
Triangolo:   P = a+b+c    A = (bÃ—h)/2
Cerchio:     C = 2Ï€r      A = Ï€rÂ²    (Ï€ â‰ˆ 3.14159)
Trapezio:    P = a+b+c+d  A = ((B+b)Ã—h)/2
Rombo:       P = 4l       A = (dâ‚Ã—dâ‚‚)/2
Poligono reg.:P = nÃ—l     A = (PÃ—a)/2 (a=apotema)

TEOREMA DI PITAGORA
In un triangolo rettangolo: aÂ² + bÂ² = cÂ²
dove c Ã¨ l'ipotenusa (il lato piÃ¹ lungo)

Esempio: cateti 3 e 4  â†’  c = âˆš(9+16) = âˆš25 = 5`},
      {titolo:"Funzioni e Grafici",contenuto:`FUNZIONE LINEARE: y = mx + q
â€¢ m = pendenza (coefficiente angolare)
â€¢ q = intercetta (dove taglia l'asse y)
â€¢ Se m>0: crescente | Se m<0: decrescente

FUNZIONE QUADRATICA: y = axÂ² + bx + c
â€¢ Parabola con vertice in V = (-b/2a, f(-b/2a))
â€¢ Se a>0: parabola aperta verso l'alto (min)
â€¢ Se a<0: parabola aperta verso il basso (max)

FUNZIONI GONIOMETRICHE
â€¢ sinÂ²x + cosÂ²x = 1
â€¢ sin(x)/cos(x) = tan(x)
Valori notevoli:
  0Â°: sin=0, cos=1
  30Â°: sin=1/2, cos=âˆš3/2
  45Â°: sin=cos=âˆš2/2
  60Â°: sin=âˆš3/2, cos=1/2
  90Â°: sin=1, cos=0`},
      {titolo:"ProbabilitÃ  e Statistica",contenuto:`PROBABILITÃ€
P(A) = casi favorevoli / casi totali
â€¢ 0 â‰¤ P(A) â‰¤ 1
â€¢ P(A) + P(Ä€) = 1 (evento complementare)
â€¢ P(AâˆªB) = P(A) + P(B) - P(Aâˆ©B)
â€¢ Se A e B indipendenti: P(Aâˆ©B) = P(A)Ã—P(B)

STATISTICA
Media aritmetica: xÌ„ = (xâ‚+xâ‚‚+...+xâ‚™)/n
Moda: valore che appare piÃ¹ spesso
Mediana: valore centrale dopo ordinamento

COMBINATORIA
Permutazioni: P(n) = n!
Combinazioni: C(n,k) = n! / (k! Ã— (n-k)!)
Esempio: C(5,2) = 5!/(2!Ã—3!) = 10`}
    ]
  },
  chimica: {
    icona:"âš—ï¸",
    sezioni:[
      {titolo:"Tavola Periodica e Atomo",contenuto:`STRUTTURA DELL'ATOMO
â€¢ Protoni (pâº): carica positiva â€” nel nucleo
â€¢ Neutroni (nâ°): carica nulla â€” nel nucleo
â€¢ Elettroni (eâ»): carica negativa â€” negli orbitali

Numero atomico (Z) = numero di protoni
Numero di massa (A) = protoni + neutroni
Isotopi = stesso Z, diverso A

TAVOLA PERIODICA
Organizzata per Z crescente
Periodi (righe): 1â†’7  â€” indica i livelli energetici
Gruppi (colonne): 1â†’18 â€” indica valenza

Metalli (sinistra): conducono, lucidi, malleabili
Non metalli (destra): isolanti, fragili
Metalloidi (diagonale): proprietÃ  intermedie

Elementi fondamentali da ricordare:
H(1), He(2), Li(3), C(6), N(7), O(8),
Na(11), Mg(12), Al(13), Si(14), P(15),
S(16), Cl(17), Ar(18), K(19), Ca(20), Fe(26), Cu(29), Zn(30), Ag(47), Au(79)`},
      {titolo:"Legami Chimici",contenuto:`LEGAME IONICO
Tra metallo e non metallo
Trasferimento completo di elettroni
Esempio: Naâº + Clâ» â†’ NaCl (sale da cucina)

LEGAME COVALENTE
Tra non metalli â€” condivisione di elettroni
Polare: elettroni condivisi in modo asimmetrico (Hâ‚‚O)
Apolare: condivisione simmetrica (Hâ‚‚, Oâ‚‚, Nâ‚‚)

LEGAME METALLICO
Tra metalli â€” "mare di elettroni"
Spiega conducibilitÃ  elettrica e termica

FORZE INTERMOLECOLARI
â€¢ Legami idrogeno (i piÃ¹ forti): N-H, O-H, F-H
â€¢ Forze di Van der Waals (deboli): tra molecole apolari
â€¢ Spiegano punti di ebollizione e fusione`},
      {titolo:"Reazioni Chimiche e Stechiometria",contenuto:`BILANCIAMENTO
Legge di conservazione della massa: la massa totale non cambia
Regola: usa i coefficienti (NON i pedici)

Esempio: Hâ‚‚ + Oâ‚‚ â†’ Hâ‚‚O
Bilanciata: 2Hâ‚‚ + Oâ‚‚ â†’ 2Hâ‚‚O

Tipi di reazione:
â€¢ Sintesi: A + B â†’ AB
â€¢ Decomposizione: AB â†’ A + B
â€¢ Scambio semplice: A + BC â†’ AC + B
â€¢ Scambio doppio: AB + CD â†’ AD + CB
â€¢ Ossidoriduzione: cambiano stati di ossidazione

MOLE E STECHIOMETRIA
1 mole = 6.022Ã—10Â²Â³ particelle (N. di Avogadro)
n (mol) = massa (g) / massa molare (g/mol)
Massa molare = somma masse atomiche

Esempio: Hâ‚‚O â†’ M = 2(1) + 16 = 18 g/mol
In 36g di Hâ‚‚O: n = 36/18 = 2 moli`},
      {titolo:"Acidi, Basi e pH",contenuto:`ACIDI
Rilasciano Hâº in soluzione acquosa (teoria Arrhenius)
pH < 7
Esempi: HCl (acido cloridrico), Hâ‚‚SOâ‚„ (solforico), CHâ‚ƒCOOH (acetico)

BASI
Rilasciano OHâ» in soluzione acquosa
pH > 7
Esempi: NaOH (soda caustica), Ca(OH)â‚‚ (calce)

pH
pH = -log[Hâº]
â€¢ pH < 7: soluzione acida
â€¢ pH = 7: soluzione neutra (acqua pura)
â€¢ pH > 7: soluzione basica

Scala da 0 (acido forte) a 14 (base forte)
Ogni unitÃ  = 10 volte piÃ¹ acido/basico

NEUTRALIZZAZIONE
Acido + Base â†’ Sale + Acqua
HCl + NaOH â†’ NaCl + Hâ‚‚O`}
    ]
  },
  fisica: {
    icona:"âš¡",
    sezioni:[
      {titolo:"Cinematica â€” Moto e VelocitÃ ",contenuto:`GRANDEZZE FONDAMENTALI
Spazio: s [m]    Tempo: t [s]    VelocitÃ : v [m/s]    Accelerazione: a [m/sÂ²]

MOTO RETTILINEO UNIFORME (MRU)
v = costante, a = 0
Spazio: s = v Ã— t
Grafico s-t: retta | Grafico v-t: retta orizzontale

MOTO RETTILINEO UNIFORMEMENTE ACCELERATO (MRUA)
v = vâ‚€ + aÃ—t
s = vâ‚€t + Â½atÂ²
vÂ² = vâ‚€Â² + 2as
Grafico v-t: retta obliqua | Grafico s-t: parabola

CADUTA LIBERA (caso speciale MRUA con a=g)
g â‰ˆ 9.8 m/sÂ² (verso il basso)
v = gÃ—t    |    h = Â½gtÂ²    |    vÂ² = 2gh

Conversioni utili:
1 km/h = 1/3.6 m/s
72 km/h = 20 m/s`},
      {titolo:"Dinamica â€” Forze e Leggi di Newton",contenuto:`1Â° LEGGE (INERZIA)
Un corpo rimane in quiete o in moto rettilineo uniforme
se la forza risultante Ã¨ zero.

2Â° LEGGE (FONDAMENTALE)
F = m Ã— a
F [N = kgÃ—m/sÂ²]    m [kg]    a [m/sÂ²]
Se F raddoppia â†’ a raddoppia
Se m raddoppia â†’ a dimezza

3Â° LEGGE (AZIONE-REAZIONE)
Ad ogni azione corrisponde una reazione uguale e contraria.

FORZE IMPORTANTI
Peso: P = mÃ—g  (verso il basso)
Forza normale: N = P (su piano orizzontale)
Attrito statico: fs â‰¤ Î¼sÃ—N
Attrito dinamico: fd = Î¼dÃ—N
Forza elastica (Hooke): F = -kÃ—x

LAVORO ED ENERGIA
Lavoro: L = FÃ—sÃ—cos(Î¸)  [J = NÃ—m]
Energia cinetica: Ec = Â½mvÂ²
Energia potenziale: Ep = mgh
Conservazione energia: Ec + Ep = costante`},
      {titolo:"ElettricitÃ  â€” Corrente e Circuiti",contenuto:`GRANDEZZE ELETTRICHE
Tensione V [Volt]    Corrente I [Ampere]    Resistenza R [Ohm]

LEGGE DI OHM
V = R Ã— I     â†’     I = V/R     â†’     R = V/I

RESISTENZE IN SERIE
Rtot = Râ‚ + Râ‚‚ + Râ‚ƒ + ...
Stessa corrente in tutto il circuito
Tensioni si sommano: Vtot = Vâ‚ + Vâ‚‚ + ...

RESISTENZE IN PARALLELO
1/Rtot = 1/Râ‚ + 1/Râ‚‚ + ...
(2 resistenze uguali R â†’ Rtot = R/2)
Stessa tensione ai capi
Correnti si sommano: Itot = Iâ‚ + Iâ‚‚ + ...

POTENZA ED ENERGIA
Potenza: P = VÃ—I = IÂ²Ã—R = VÂ²/R  [Watt]
Energia: E = PÃ—t  [Joule] o [kWh]
1 kWh = 3.600.000 J

CAMPO ELETTRICO
F = kÃ—qâ‚Ã—qâ‚‚/rÂ²  (Legge di Coulomb)
k = 9Ã—10â¹ NÃ—mÂ²/CÂ²`},
      {titolo:"Termodinamica e Ottica",contenuto:`TEMPERATURA E CALORE
Temperatura: misura energia cinetica media
Calore: Q = mÃ—cÃ—Î”T  (c = calore specifico)

Conversioni: T[K] = T[Â°C] + 273
Calore specifico acqua: c = 4186 J/(kgÃ—K)

1Â° PRINCIPIO TERMODINAMICA
Î”U = Q - L
(variazione energia interna = calore assorbito - lavoro compiuto)

2Â° PRINCIPIO
Il calore non puÃ² passare spontaneamente dal corpo freddo al caldo

OTTICA
Riflessione: angolo incidenza = angolo riflessione
Rifrazione: nâ‚Ã—sin(Î¸â‚) = nâ‚‚Ã—sin(Î¸â‚‚)
Indice di rifrazione: n = c/v (c = 3Ã—10â¸ m/s)
Lenti convergenti (convesse): f > 0
Lenti divergenti (concave): f < 0
Formula lenti: 1/f = 1/p + 1/q`}
    ]
  },
  storia: {
    icona:"ğŸ›ï¸",
    sezioni:[
      {titolo:"Evo Antico e Medioevo",contenuto:`CIVILTÃ€ ANTICHE
Mesopotamia (3500 a.C.): prima scrittura (cuneiforme), Sumeri, Babilonesi, Hammurabi
Egitto: faraoni, geroglifici, piramidi (2560 a.C. Cheope)
Grecia: democrazia ateniese (Pericle 461 a.C.), filosofia (Socrate, Platone, Aristotele), Alessandro Magno (336 a.C.)
Roma: Repubblica (509 a.C.) â†’ Impero (27 a.C. Augusto) â†’ Caduta Occidente (476 d.C.)

MEDIOEVO (476-1492)
Alto Medioevo: feudalesimo, Carlo Magno (800), invasioni normanne
Basso Medioevo: Crociate (1096-1291), Comuni italiani, Magna Carta (1215)
Fine Medioevo: Peste Nera (1348), Scisma d'Occidente, Umanesimo
Date chiave:
â€¢ 476: Caduta Roma Occidentale (inizio Medioevo)
â€¢ 800: Incoronazione Carlo Magno
â€¢ 1066: Conquista normanna dell'Inghilterra
â€¢ 1215: Magna Carta
â€¢ 1453: Caduta Costantinopoli (fine Medioevo)`},
      {titolo:"EtÃ  Moderna â€” Rinascimento e Rivoluzioni",contenuto:`RINASCIMENTO (XIV-XVI sec.)
Firenze: Medici come mecenati
Arte: Leonardo da Vinci, Michelangelo, Raffaello
Scienza: Copernico (sistema eliocentrico, 1543), Galileo
1492: Colombo scopre l'America
1517: Riforma protestante (Lutero, 95 tesi)

RIVOLUZIONI DEL XVIII SEC.
Rivoluzione Americana (1776): Dichiarazione d'Indipendenza
Rivoluzione Francese (1789-1799):
  â€¢ Cause: disuguaglianza, crisi finanziaria, illuminismo
  â€¢ Fasi: Assemblea Nazionale, Terrore (Robespierre), Direttorio
  â€¢ 1789: presa della Bastiglia, Dichiarazione dei Diritti

NAPOLEONE (1799-1815)
Primo Console â†’ Imperatore (1804)
Codice Napoleonico | Campagne in Europa
Sconfitta a Waterloo (1815), esilio a Sant'Elena

RIVOLUZIONE INDUSTRIALE (XVIII-XIX)
Inghilterra â†’ poi Europa
Macchina a vapore (Watt, 1769), fabbriche, proletariato
Conseguenze: urbanizzazione, capitalismo, movimenti operai`},
      {titolo:"XIX Secolo â€” Nazioni e Risorgimento",contenuto:`RISORGIMENTO ITALIANO (1815-1861)
Mazzini: Giovine Italia, ideali repubblicani
Cavour: Piemonte come guida, diplomazia, alleanza con Francia
Garibaldi: Spedizione dei Mille (1860), conquista Sud
1861: UnitÃ  d'Italia, Vittorio Emanuele II primo re
1866: Venezia annessa | 1870: Roma capitale

UNIFICAZIONE TEDESCA
Bismarck (Prussia): "ferro e sangue"
Guerre contro Danimarca (1864), Austria (1866), Francia (1870)
1871: Proclamazione Impero Tedesco (Secondo Reich)

IMPERIALISMO (fine XIX)
Europa colonizza Africa e Asia
Spartizione dell'Africa (Conferenza di Berlino, 1884)
Contraddizioni che porteranno alla WWI`},
      {titolo:"XX Secolo â€” Guerre Mondiali e Dopoguerra",contenuto:`PRIMA GUERRA MONDIALE (1914-1918)
Cause: nazionalismo, imperialismo, alleanze, assassinio Francesco Ferdinando (28 giugno 1914)
Schieramenti: Intesa (Francia, UK, Russia, poi USA) vs Triplice Alleanza (Germania, Austria, Italia*)
*Italia entra con Intesa nel 1915 (Patto di Londra)
1917: Rivoluzione russa, USA entrano in guerra
1918: Armistizio | Trattato di Versailles (1919): pesa sulla Germania

TOTALITARISMI (anni '20-'30)
Fascismo in Italia: Mussolini, marcia su Roma (1922)
Nazismo in Germania: Hitler cancelliere (1933), Kristallnacht (1938)
Stalinismo in URSS: collettivizzazione, purghe

SECONDA GUERRA MONDIALE (1939-1945)
1939: invasione Polonia â†’ UK e Francia dichiarano guerra
1940: caduta Francia, Battaglia d'Inghilterra
1941: Operazione Barbarossa (URSS), Pearl Harbor (USA)
1943: caduta Mussolini, armistizio italiano
1944: sbarco in Normandia (6 giugno)
1945: maggio: resa Germania | agosto: bombe atomiche Giappone
Olocausto: 6 milioni di ebrei sterminati

GUERRA FREDDA (1947-1991)
USA (NATO) vs URSS (Patto di Varsavia)
Blocco di Berlino (1948), Guerra di Corea (1950-53)
Crisi dei missili cubani (1962), Vietnam (1955-75)
1989: caduta Muro di Berlino | 1991: dissoluzione URSS`}
    ]
  },
  scienze: {
    icona:"ğŸ”¬",
    sezioni:[
      {titolo:"La Cellula",contenuto:`CELLULA PROCARIOTA (batteri)
â€¢ Nessun nucleo membranoso
â€¢ DNA circolare nel citoplasma
â€¢ Dimensioni: 1-10 Î¼m
â€¢ Esempio: Escherichia coli

CELLULA EUCARIOTA (animali, piante, funghi)
â€¢ Nucleo con membrana nucleare
â€¢ Organuli specializzati
â€¢ Dimensioni: 10-100 Î¼m

ORGANULI PRINCIPALI
Nucleo: contiene DNA, controlla la cellula
Membrana cellulare: regola scambi (permeabilitÃ  selettiva)
Mitocondri: produzione energia (ATP) â€” "centrale energetica"
Ribosomi: sintesi proteica
Reticolo endoplasmatico: trasporto sostanze
Apparato di Golgi: elabora e spedisce proteine
Lisosomi: digestione cellulare (solo animali)
Vacuolo centrale: accumulo acqua (solo piante, grande)
Cloroplasti: fotosintesi (solo piante, verdi per clorofilla)
Parete cellulare: struttura rigida (solo piante, fungi, batteri)`},
      {titolo:"Fotosintesi e Respirazione",contenuto:`FOTOSINTESI CLOROFILLIANA
6COâ‚‚ + 6Hâ‚‚O + energia luminosa â†’ Câ‚†Hâ‚â‚‚Oâ‚† + 6Oâ‚‚
Avviene nei cloroplasti
Fase luminosa: cattura luce, produce ATP e NADPH
Ciclo di Calvin: usa ATP, fissa COâ‚‚ in glucosio

RESPIRAZIONE CELLULARE AEROBICA
Câ‚†Hâ‚â‚‚Oâ‚† + 6Oâ‚‚ â†’ 6COâ‚‚ + 6Hâ‚‚O + 38 ATP
Avviene nei mitocondri
Glicolisi (citoplasma) â†’ Ciclo di Krebs â†’ Fosforilazione ossidativa
Resa: 38 molecole di ATP per molecola di glucosio

CONFRONTO
Fotosintesi: usa COâ‚‚, produce Oâ‚‚ e glucosio (piante, alghe, diurna)
Respirazione: usa Oâ‚‚ e glucosio, produce COâ‚‚ (tutti gli organismi, continua)
Le due reazioni si "bilanciano" nel ciclo del carbonio`},
      {titolo:"Genetica â€” DNA e Mendel",contenuto:`DNA
Doppia elica di nucleotidi (adenina-timina, guanina-citosina)
Gene = sequenza di DNA che codifica una proteina
Cromosoma = DNA compattato con proteine (istoni)
Uomo: 46 cromosomi (23 coppie), di cui 2 sessuali (XX femmina, XY maschio)

REPLICAZIONE â†’ TRASCRIZIONE â†’ TRADUZIONE
DNA si replica (copia identica) prima della divisione
DNA â†’ RNA messaggero (trascrizione nel nucleo)
RNA â†’ Proteina (traduzione nei ribosomi)

MENDEL â€” LEGGI DELL'EREDITARIETÃ€
1Âª Legge (Dominanza): in F1 si esprime solo il carattere dominante
2Âª Legge (Segregazione): in F2 rapporto 3 dominante : 1 recessivo
3Âª Legge (Assortimento indipendente): geni su cromosomi diversi si trasmettono indipendentemente

Aa (eterozigote dominante)
AA (omozigote dominante) 
aa (omozigote recessivo â€” esprime carattere recessivo)

Esempio piselli: G (giallo, dominante) g (verde, recessivo)
  P: GG Ã— gg  â†’  F1: tutti Gg (giallo)
  F1Ã—F1: GgÃ—Gg  â†’  F2: GG, Gg, Gg, gg (3 giallo : 1 verde)`},
      {titolo:"Evoluzione ed Ecosistemi",contenuto:`TEORIA DELL'EVOLUZIONE (Darwin, 1859)
Selezione naturale: sopravvivono gli individui piÃ¹ adatti all'ambiente
VariabilitÃ : individui della stessa specie sono diversi
EreditarietÃ : caratteri si trasmettono ai figli
Tempo: milioni di anni per formare nuove specie

PROVE DELL'EVOLUZIONE
Fossili | Omologie anatomiche | DNA | Biogeografia | Embriologia comparata

ECOSISTEMA
Bioma: grande area con clima e organismi caratteristici
ComunitÃ : tutte le specie in un'area
Popolazione: individui della stessa specie
Catena alimentare: Produttori â†’ Consumatori â†’ Decompositori
Produttori: piante (fotosintesi)
Consumatori I: erbivori | Consumatori II: carnivori
Decompositori: batteri e funghi

CICLI BIOGEOCHIMICI
Ciclo del carbonio: fotosintesi â†” respirazione â†” decomposizione
Ciclo dell'acqua: evaporazione â†’ precipitazione â†’ ruscellamento
Ciclo dell'azoto: fissazione batterica â†’ nitrificazione â†’ denitrificazione`}
    ]
  },
  inglese: {
    icona:"ğŸ‡¬ğŸ‡§",
    sezioni:[
      {titolo:"Tempi Verbali â€” Schema Completo",contenuto:`PRESENT SIMPLE: azione abituale/veritÃ 
(+) I work  He works  (-) I don't  He doesn't  (?) Do I? Does he?
Avverbi: always, usually, often, sometimes, never

PRESENT CONTINUOUS: azione in corso ora
(+) I am working  He is working  (-) I'm not working  (?) Are you working?
Avverbi: now, at the moment, currently

PAST SIMPLE: azione completata nel passato
Verbi regolari: +ed (worked, played, walked)
Verbi irregolari: goâ†’went, eatâ†’ate, haveâ†’had, seeâ†’saw, makeâ†’made
Avverbi: yesterday, last year, ago, in 2010

PRESENT PERFECT: azione passata con legame al presente
(+) I have worked  He has worked  (-) I haven't  He hasn't  (?) Have you?
Avverbi: just, already, yet, ever, never, since, for

PAST CONTINUOUS: azione in corso in un momento passato
(+) I was working  (-) I wasn't working  (?) Were you working?
Uso: "While I was studying, he called"

FUTURE: WILL vs GOING TO
Will: decisione spontanea, previsione senza prove
Going to: piano giÃ  deciso, previsione con prove
"I will help you!" | "I'm going to travel next summer (I've bought the ticket)"

CONDITIONALS
Zero: If + present, present  â†’ veritÃ  generale
First: If + present, will  â†’ condizione reale futura
Second: If + past, would  â†’ condizione irreale presente
Third: If + past perfect, would have  â†’ condizione irreale passata`},
      {titolo:"Grammatica â€” Regole Essenziali",contenuto:`PASSIVE VOICE
Presente: am/is/are + past participle
Passato: was/were + past participle
"The book is read by students" | "The letter was written by her"

REPORTED SPEECH
Presentiâ†’Passati: isâ†’was, areâ†’were, willâ†’would, canâ†’could
"I am happy" â†’ He said he was happy
"I will come" â†’ She said she would come
Parole di tempo: nowâ†’then, todayâ†’that day, tomorrowâ†’the next day

GERUND vs INFINITIVE
Gerund (-ing): after prepositions, as subject, enjoy/like/hate/avoid/suggest
Infinitive (to+verb): want/need/decide/hope/plan/promise/seem

RELATIVE CLAUSES
Who: per persone  Which: per cose  That: persone o cose
Where: luoghi  Whose: possesso  When: tempo
Defining: "The man who called is my brother"
Non-defining (virgole): "My brother, who lives in Rome, called"

QUESTION TAGS
Positive statement â†’ negative tag: "You like pizza, don't you?"
Negative statement â†’ positive tag: "She isn't coming, is she?"`},
      {titolo:"Vocabolario â€” False Friends e Phrasal Verbs",contenuto:`FALSE FRIENDS (parole ingannevoli)
actually = in realtÃ  (NON attualmente = currently)
eventually = alla fine (NON eventualmente = possibly)
sensible = sensato (NON sensibile = sensitive)
library = biblioteca (NON libreria = bookshop)
factory = fabbrica (NON fattoria = farm)
sympathetic = comprensivo (NON simpatico = nice/friendly)
argument = discussione/litigio (NON argomento = topic/subject)
pretend = fingere (NON pretendere = demand/expect)

PHRASAL VERBS COMUNI
give up = arrendersi, smettere
take off = decollare, togliersi (vestiti)
look up = cercare (dizionario), guardare in su
put off = rimandare, procrastinare
turn on/off = accendere/spegnere
run out of = esaurire
find out = scoprire
bring up = crescere (un figlio), sollevare (argomento)
get on = andare d'accordo, salire (mezzo)
carry on = continuare
come across = imbattersi in
go through = attraversare, esaminare

CONNETTIVI ESSENZIALI
Aggiunta: furthermore, moreover, in addition, besides
Contrasto: however, nevertheless, on the other hand, although
Causa: because, since, as, due to, owing to
Risultato: therefore, thus, consequently, as a result
Esempio: for instance, for example, such as`}
    ]
  },
  filosofia: {
    icona:"ğŸ¤”",
    sezioni:[
      {titolo:"Filosofia Antica â€” Da Talete a Platone",contenuto:`PRE-SOCRATICI (VII-V sec. a.C.)
Problema: qual Ã¨ il principio (archÃ¨) di tutto?
Talete: acqua | Anassimene: aria | Eraclito: fuoco (e logos)
Eraclito: "panta rei" (tutto scorre), dialettica degli opposti
Parmenide: l'Essere Ã¨ immobile, immutabile (opposto a Eraclito)
Pitagora: i numeri come principio di tutto

SOCRATE (470-399 a.C.)
Metodo maieutico: fare domande per far emergere la veritÃ 
"So di non sapere" â€” ironia socratica
"Conosci te stesso" â€” ricerca interiore
Condannato a morte per empietÃ  e corruzione dei giovani

PLATONE (428-348 a.C.)
Teoria delle Idee: il mondo sensibile Ã¨ copia del mondo delle Idee (iperurania)
Anima: immortale, caduta nel corpo, ricorda le Idee (reminiscenza)
Stato ideale: filosofi-re, guerrieri, produttori
Mito della caverna: gli uomini vedono solo ombre della realtÃ 
Opere: Repubblica, Fedone, Simposio, Timeo`},
      {titolo:"Aristotele e Filosofia Ellenistica",contenuto:`ARISTOTELE (384-322 a.C.)
Critica a Platone: le Idee sono NELLA cosa, non separate
Logica: sillogismo ("Tutti gli uomini sono mortali; Socrate Ã¨ uomo; ergo Socrate Ã¨ mortale")
Metafisica: sostanza, forma e materia, atto e potenza
Etica: virtÃ¹ come "giusto mezzo" tra eccesso e difetto
Politica: l'uomo Ã¨ "animale politico"; migliore governo = repubblica
Opere: Organon, Metafisica, Etica Nicomachea, Politica, Poetica

FILOSOFIA ELLENISTICA (IV-I sec. a.C.)
Epicureismo (Epicuro): il fine Ã¨ la felicitÃ  = assenza di dolore (atarassia)
    "Carpe diem" â€” godere il momento, filosofia del giardino
Stoicismo (Zenone): virtÃ¹ come unico bene; accettare ciÃ² che non dipende da noi
    Logos cosmico â€” tutto Ã¨ razionale e necessario
Scetticismo (Pirrone): sospensione del giudizio = pace interiore
Neoplatonismo (Plotino): l'Uno come principio, emanazione`},
      {titolo:"Filosofia Moderna â€” Cartesio, Kant, Hegel",contenuto:`CARTESIO (1596-1650) â€” RAZIONALISMO
Dubbio metodico: mette in dubbio tutto per trovare una certezza
"Cogito ergo sum" = "Penso dunque sono" (prima certezza indubitabile)
Dualismo: res cogitans (mente) e res extensa (corpo) â€” problema mente-corpo
Metodo deduttivo: dalla ragione si ricavano veritÃ  certe

EMPIRISMO
Locke: la mente Ã¨ tabula rasa, tutta la conoscenza viene dall'esperienza
Hume: critica alla causalitÃ , scetticismo sul sÃ© e sul mondo esterno

KANT (1724-1804) â€” CRITICISMO
Critica della Ragion Pura: come Ã¨ possibile la conoscenza?
Fenomeno (cosa come appare) vs Noumeno (cosa in sÃ©, inconoscibile)
Spazio e tempo: forme a priori dell'intuizione
Critica della Ragion Pratica: etica
Imperativo categorico: "Agisci solo secondo quella massima che puoi volere sia legge universale"
Critica del Giudizio: bello e sublime, teleologia della natura

HEGEL (1770-1831) â€” IDEALISMO ASSOLUTO
Dialettica: Tesi â†’ Antitesi â†’ Sintesi (Aufhebung)
Lo Spirito si realizza nella storia attraverso contraddizioni
Spirito soggettivo â†’ oggettivo (diritto, moralitÃ , eticitÃ ) â†’ assoluto (arte, religione, filosofia)
"CiÃ² che Ã¨ razionale Ã¨ reale, ciÃ² che Ã¨ reale Ã¨ razionale"`},
      {titolo:"Filosofia Contemporanea â€” Nietzsche, Marx, Esistenzialismo",contenuto:`MARX (1818-1883)
Materialismo storico: la storia Ã¨ guidata dalle condizioni materiali (economiche)
Struttura (economia) determina la sovrastruttura (politica, cultura, religione)
Lotta di classe: borghesia vs proletariato
"La religione Ã¨ l'oppio dei popoli"
Comunismo: abolizione proprietÃ  privata, societÃ  senza classi
Opere: Manifesto del Partito Comunista (1848), Il Capitale

NIETZSCHE (1844-1900)
Morte di Dio: il nichilismo moderno, crollo dei valori tradizionali
Oltreuomo (Ãœbermensch): chi crea nuovi valori al di lÃ  del bene e del male
VolontÃ  di potenza: istinto creativo, non sopraffazione
Eterno ritorno: tutto si ripete infinitamente â€” accettarlo con amor fati
Critica alla morale: morale del padrone vs morale del gregge
Opere: CosÃ¬ parlÃ² Zarathustra, Al di lÃ  del bene e del male

ESISTENZIALISMO (XX sec.)
Kierkegaard: padre dell'es. â€” tre stadi: estetico, etico, religioso
Sartre: "L'esistenza precede l'essenza" â€” libertÃ  totale e angoscia
    "L'uomo Ã¨ condannato ad essere libero"
Heidegger: Essere-nel-mondo, autenticitÃ  vs inautenticitÃ , essere-per-la-morte
Camus: assurdo della vita, rivolta come risposta`}
    ]
  },
  italiano: {
    icona:"ğŸ“–",
    sezioni:[
      {titolo:"Grammatica â€” Analisi del Testo",contenuto:`PARTI DEL DISCORSO
Sostantivo: nome di persone, cose, idee (comune/proprio, concreto/astratto)
Articolo: determinativo (il/la/lo/i/le/gli) | indeterminativo (un/uno/una)
Aggettivo: qualificativo, possessivo, dimostrativo, indefinito, numerale, interrogativo
Pronome: personale, relativo (che/cui/il quale), dimostrativo, indefinito
Verbo: modi finiti (indicativo/congiuntivo/condizionale/imperativo) e infiniti (infinito/participio/gerundio)
Avverbio: di modo, tempo, luogo, quantitÃ , affermazione, negazione
Preposizione: semplici (di, a, da, in, con, su, per, tra, fra) e articolate
Congiunzione: coordinanti (e, ma, perÃ², quindi, oppure) e subordinanti (che, perchÃ©, quando, se, sebbene)

ANALISI LOGICA
Soggetto: di chi si parla
Predicato verbale: cosa fa il soggetto
Predicato nominale: essere + nome/aggettivo
Complemento oggetto: risponde a "chi?" "che cosa?"
Complemento di specificazione: "di" + nome
Complemento di termine: "a" + nome (risponde a "a chi?")
Complemento d'agente: "da" + persona (con passivo)
Complemento di luogo: stato in luogo, moto a/da/per luogo
Apposizione: nome che affianca un altro nome`},
      {titolo:"Letteratura Italiana â€” Dalle Origini all'Ottocento",contenuto:`ORIGINI (X-XIII sec.)
Francesco d'Assisi: Cantico delle Creature (1224) â€” prima lirica in volgare
Scuola Siciliana (Federico II): prima poesia d'amore in italiano
Dolce Stilnovo: Guinizzelli, Cavalcanti â€” amore spiritualizzato, donna angelicata

TRECENTO (XIV sec.)
Dante Alighieri (1265-1321): Divina Commedia (100 canti: 34 Inferno, 33 Purgatorio, 33 Paradiso), Vita Nova, De Monarchia
Francesco Petrarca (1304-1374): Canzoniere (366 componimenti, amore per Laura), fondatore dell'umanesimo
Giovanni Boccaccio (1313-1375): Decameron (100 novelle, 10 giorni, 10 narratori)

QUATTROCENTO-CINQUECENTO
Umanesimo e Rinascimento: ritorno ai classici, fiducia nell'uomo
Ariosto: Orlando Furioso (poema cavalleresco)
Machiavelli: Il Principe (realismo politico, "il fine giustifica i mezzi")
Tasso: Gerusalemme Liberata (poema epico religioso)

SEICENTO-SETTECENTO
Barocco: stile ornato, metafore ardite (Marino â€” "meraviglia")
Illuminismo: Beccaria (Dei delitti e delle pene), Parini, Goldoni
Alfieri: tragedie neoclassiche

OTTOCENTO
Neoclassicismo: Foscolo â€” Sepolcri, Ultime lettere di Jacopo Ortis
Romanticismo: Manzoni â€” Promessi Sposi (1827, poi 1840), Inni Sacri, Adelchi
Leopardi: Zibaldone, Canti (L'Infinito, A Silvia, La Ginestra), pessimismo cosmico`},
      {titolo:"Figure Retoriche e Analisi del Testo",contenuto:`FIGURE RETORICHE PRINCIPALI
Similitudine: paragone esplicito con "come" â€” "Era veloce come il vento"
Metafora: paragone implicito â€” "Il vento era un pugnale"
Personificazione: dare qualitÃ  umane a oggetti/animali
Apostrofe: rivolgersi a qualcuno/qualcosa assente
Anafora: ripetizione di parola all'inizio di versi/frasi
Allitterazione: ripetizione di suoni/consonanti â€” "Soffi senza sosta, sole scomparso"
Assonanza: ripetizione di suoni vocalici
Iperbole: esagerazione â€” "Ti ho aspettato un'eternitÃ "
Ossimoro: unione di termini opposti â€” "silenzio assordante"
Chiasmo: schema incrociato A-B-B-A
Sineddoche: parte per il tutto o viceversa â€” "100 teste di bestiame"
Metonimia: sostituzione per vicinanza â€” "bere un bicchiere" (vino)
Perifrasi: giro di parole per indicare qualcosa
Eufemismo: attenuare qualcosa di spiacevole

ANALISI DEL TESTO POETICO
1. Parafrasi â€” 2. Struttura metrica (endecasillabo, ottonario...)
3. Schema rime (ABAB, ABBA, AABB...) â€” 4. Figure retoriche
5. Temi e significati â€” 6. Contesto storico-letterario`}
    ]
  },
  latino: {
    icona:"ğŸº",
    sezioni:[
      {titolo:"Morfologia â€” Declinazioni",contenuto:`1Âª DECLINAZIONE (femminile, tema -a)
     Sing.  Plur.
Nom: -a     -ae
Gen: -ae    -arum
Dat: -ae    -is
Acc: -am    -as
Abl: -a     -is
Es: puella (ragazza)

2Âª DECLINAZIONE (maschile -us/-er, neutro -um)
     Masc.Sing.  Masc.Plur.  Neut.Sing.  Neut.Plur.
Nom: -us         -i          -um         -a
Gen: -i          -orum       -i          -orum
Dat: -o          -is         -o          -is
Acc: -um         -os         -um         -a
Abl: -o          -is         -o          -is
Es: dominus (padrone), bellum (guerra)

3Âª DECLINAZIONE (vari temi)
Nom: vario  (-or, -o, -x, -s, -ns, -rs...)
Gen: -is    (la terminazione chiave!)
Es: miles militis (soldato), rex regis (re), corpus corporis

4Âª DECLINAZIONE (tema -u)
Nom Sing: -us | Nom Plur: -us
Gen Sing: -us | Gen Plur: -uum
Dat/Abl Sing: -ui/-u | Dat/Abl Plur: -ibus
Acc Sing: -um | Acc Plur: -us

5Âª DECLINAZIONE (tema -e)
Nom/Acc Sing: -es | Gen Sing: -ei | Dat/Abl Sing: -ei/-e
Nom/Acc Plur: -es | Gen Plur: -erum | Dat/Abl Plur: -ebus
Es: res rei (cosa), dies diei (giorno)`},
      {titolo:"Morfologia â€” Coniugazioni Verbali",contenuto:`ESSE (essere) â€” INDICATIVO
Presente: sum, es, est, sumus, estis, sunt
Imperfetto: eram, eras, erat, eramus, eratis, erant
Futuro: ero, eris, erit, erimus, eritis, erunt
Perfetto: fui, fuisti, fuit, fuimus, fuistis, fuerunt

1Âª CONIUGAZIONE (-are): amare
Pres.: amo, amas, amat, amamus, amatis, amant
Imp.: amabam, amabas, amabat...
Fut.: amabo, amabis, amabit...
Perf.: amavi, amavisti, amavit...

2Âª CONIUGAZIONE (-ere): monere
Pres.: moneo, mones, monet, monemus, monetis, monent
Imp.: monebam... | Fut.: monebo...

3Âª CONIUGAZIONE (-ere breve): legere
Pres.: lego, legis, legit, legimus, legitis, legunt

4Âª CONIUGAZIONE (-ire): audire
Pres.: audio, audis, audit, audimus, auditis, audiunt

FORMA PASSIVA: aggiunta di desinenze passive
Pres. 1Âª pers. sing.: -or (amor = sono amato)
Pres. 3Âª pers. sing.: -tur (amatur = Ã¨ amato)
Pres. 3Âª pers. plur.: -ntur (amantur = sono amati)`},
      {titolo:"Sintassi â€” Proposizioni e Costruzioni",contenuto:`USO DEI CASI
Nominativo: soggetto e predicato nominale
Genitivo: complemento di specificazione, partitivo
Dativo: complemento di termine, vantaggio/svantaggio
Accusativo: complemento oggetto, moto a luogo, durata
Ablativo: separazione, provenienza, modo, mezzo, agente (con da/ab), ablativo assoluto
Vocativo: allocuzione diretta

ABLATIVO ASSOLUTO
Participio + sostantivo/pronome all'ablativo
Traduzione: "dopo che...", "mentre...", "poichÃ©...", "sebbene..."
Es: "Sole oriente, milites profecti sunt" = "Al sorgere del sole, i soldati partirono"

PROPOSIZIONE INFINITIVA (cum accusativo)
Dopo verbi di dire, pensare, sentire
Soggetto all'accusativo + verbo all'infinito
Es: "Dico Marcum venire" = "Dico che Marco viene"

CUM NARRATIVO
cum + congiuntivo imperfetto/piuccheperfetto
Valore causale o temporale
Es: "Cum Caesar venisset, hostes fugerunt"

CONSECUTIO TEMPORUM
Ind. Presente nel reggente â†’ Cong. Presente (contemporaneo) o Perfetto (anteriore)
Ind. Passato nel reggente â†’ Cong. Imperfetto (contemporaneo) o Piucch. (anteriore)`}
    ]
  },
  geografia: {
    icona:"ğŸŒ",
    sezioni:[
      {titolo:"Cartografia e Strumenti",contenuto:`LA CARTA GEOGRAFICA
Rappresentazione in piano della superficie terrestre
Scala: rapporto tra distanza sulla carta e realtÃ 
â€¢ Grande scala (1:10.000): molto dettagliata, area piccola
â€¢ Piccola scala (1:1.000.000): poco dettagliata, area grande

COORDINATE GEOGRAFICHE
Latitudine: distanza angolare dall'Equatore (0Â° a 90Â° N/S)
Longitudine: distanza angolare dal Meridiano di Greenwich (0Â° a 180Â° E/W)

TIPI DI CARTE
Fisica: rilievi (colori: blu=mare, verde=pianure, marrone=monti)
Politica: confini degli Stati
Tematica: un fenomeno specifico (clima, popolazione, economia)
Topografica: scala grande, rilievi con curve di livello

PROIEZIONI CARTOGRAFICHE
Impossibile rappresentare la sfera su un piano senza distorsioni
Mercatore: conforme (angoli giusti), deforma le aree ai poli
Peters: equivalente (aree giuste), deforma le forme
Problema: nessuna proiezione Ã¨ perfetta`},
      {titolo:"Clima e Ambienti Naturali",contenuto:`FATTORI DEL CLIMA
Latitudine: piÃ¹ ci si allontana dall'equatore, piÃ¹ freddo
Altitudine: ogni 100m si perde circa 0,6Â°C
Distanza dal mare: il mare mitiga le temperature (clima oceanico vs continentale)
Correnti marine: corrente del Golfo riscalda l'Europa
Venti: portano umiditÃ  o secchezza a seconda dell'origine

ZONE CLIMATICHE
Equatoriale (0Â°-5Â°): caldo e umido tutto l'anno, foresta tropicale
Tropicale (5Â°-23Â°): stagione secca e piovosa, savana
Subtropicale (23Â°-35Â°): deserti caldi (Sahara, Arabia), anticiclone subtropicale
Mediterraneo (30Â°-45Â°): estate secca, inverno piovoso, macchia mediterranea
Temperato oceanico: piogge distribuite, inverni miti (Europa Ovest)
Continentale: estati calde, inverni rigidi, steppe
Subartico/Boreale: taiga (foresta conifera), inverni lunghi
Polare: tundra/calotta glaciale, temperature <0Â°C quasi sempre

BIOMI PRINCIPALI
Foresta pluviale tropicale: massima biodiversitÃ 
Savana: erbosa con alberi sparsi
Deserto: meno di 250mm pioggia/anno
Foresta temperata: latifoglie decidue
Taiga: conifera sempreverde
Tundra: assenza di alberi, permafrost`},
      {titolo:"Popolazione e Urbanizzazione",contenuto:`DEMOGRAFIA
Popolazione mondiale: ~8 miliardi (2024)
Tasso di natalitÃ : nati per 1000 abitanti/anno
Tasso di mortalitÃ : morti per 1000 abitanti/anno
Tasso di crescita naturale = natalitÃ  - mortalitÃ 
Tasso di feconditÃ  totale (TFT): figli per donna
Per mantenere popolazione: TFT â‰¥ 2,1

DISTRIBUZIONE DELLA POPOLAZIONE
DensitÃ  = popolazione / superficie (ab/kmÂ²)
Zone densamente popolate: Asia meridionale e orientale, Europa, costa Est USA
Zone poco popolate: Sahara, Siberia, Amazzonia, Australia centrale

TRANSIZIONE DEMOGRAFICA
Fase 1: alta natalitÃ  + alta mortalitÃ  = pop. stabile (paesi preindustriali)
Fase 2: alta natalitÃ  + mortalitÃ  cala = boom demografico
Fase 3: natalitÃ  cala + mortalitÃ  bassa = crescita rallenta
Fase 4: bassa natalitÃ  + bassa mortalitÃ  = pop. stabile o in calo (Europa)

URBANIZZAZIONE
In aumento globale: dal 30% (1950) al 57% (2023)
Megalopoli: cittÃ  >10 milioni (Tokyo 37M, Delhi 32M, Shanghai 29M)
Push factors: povertÃ  rurale, siccitÃ  â†’ Pull factors: lavoro, servizi
Problemi: periferie degradate, inquinamento, traffico, gestione rifiuti`}
    ]
  }
};

// â”€â”€ CLAUDE API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CLAUDE_KEY = "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";
async function callClaude(prompt, maxTokens=1500){
  try{
    const res = await fetch("https://api.anthropic.com/v1/messages",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "x-api-key": CLAUDE_KEY,
        "anthropic-version":"2023-06-01",
        "anthropic-dangerous-direct-browser-access":"true"
      },
      body:JSON.stringify({
        model:"claude-haiku-4-5-20251001",
        max_tokens: maxTokens,
        messages:[{role:"user", content: prompt}]
      })
    });
    const d = await res.json();
    if(d.error) throw new Error(d.error.message);
    return d.content?.[0]?.text || "";
  }catch(e){
    throw e;
  }
}

// Genera HTML del PDF da scaricare nel browser (fallback locale)
function generaHTMLPdf(event) {
  const materia = event.materia || "altra";
  const argomento = event.argomento || "";
  const titolo = event.title || "Studio";
  const db = CONTENUTI_DB[materia];

  const mat = MATERIE ? MATERIE.find(m=>m.id===materia) : null;
  const matLabel = mat ? mat.label : materia;
  const oggi = new Date().toLocaleDateString('it-IT', {day:'numeric',month:'long',year:'numeric'});

  // Seleziona sezioni rilevanti
  let sezioni = [];
  if(db) {
    if(argomento) {
      // Cerca sezione piÃ¹ pertinente
      const lower = argomento.toLowerCase();
      const match = db.sezioni.filter(s =>
        s.titolo.toLowerCase().includes(lower) ||
        s.contenuto.toLowerCase().includes(lower)
      );
      sezioni = match.length > 0 ? match : db.sezioni;
    } else {
      sezioni = db.sezioni;
    }
  }

  // Se non c'Ã¨ DB per questa materia, crea sezione generica
  if(sezioni.length === 0) {
    sezioni = [{
      titolo: argomento || matLabel,
      contenuto: `Ripassa i tuoi appunti su questo argomento.\n\nPunti chiave da studiare:\nâ€¢ Definizioni principali\nâ€¢ Regole e formule\nâ€¢ Esempi pratici\nâ€¢ Esercizi del libro`
    }];
  }

  const colori = {
    matematica:"#2C3E7A", chimica:"#1A6B3C", fisica:"#7A2C2C",
    storia:"#7A5A2C", scienze:"#1A6B5A", inglese:"#2C5A7A",
    geografia:"#3D7A2C", filosofia:"#5A2C7A", italiano:"#7A2C5A",
    latino:"#6B3D1A", informatica:"#1A3D6B", arte:"#7A4A1A",
    musica:"#4A1A7A", ed_fisica:"#1A7A4A", altra:"#3D3D3D"
  };
  const colore = colori[materia] || "#333";

  const sezioniHTML = sezioni.map((s,i) => `
    <div class="sezione">
      <div class="sezione-header">${i+1}. ${s.titolo}</div>
      <div class="contenuto">${s.contenuto.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>').replace(/([A-Z][A-Z ]{3,}:)/g,'<strong>$1</strong>')}</div>
    </div>
  `).join('');

  return `<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>${titolo} â€” ${matLabel}</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: 'Inter', Arial, sans-serif; color: #1a1a1a; background: #fff; }
  .copertina { background: linear-gradient(135deg, ${colore}, ${colore}99); color: white; padding: 60px 50px; min-height: 200px; }
  .copertina .emoji { font-size: 48px; margin-bottom: 16px; }
  .copertina h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; letter-spacing: -0.5px; }
  .copertina .sub { font-size: 16px; opacity: 0.85; margin-bottom: 4px; }
  .copertina .data { font-size: 13px; opacity: 0.65; margin-top: 12px; }
  .contenuto-wrap { padding: 40px 50px; }
  .sezione { margin-bottom: 32px; break-inside: avoid; }
  .sezione-header { background: ${colore}15; border-left: 4px solid ${colore}; padding: 10px 16px; font-size: 15px; font-weight: 700; color: ${colore}; margin-bottom: 12px; border-radius: 0 8px 8px 0; }
  .contenuto { font-size: 13.5px; line-height: 1.75; color: #2a2a2a; padding: 0 4px; white-space: pre-wrap; font-family: 'Inter', monospace; }
  .contenuto strong { color: ${colore}; }
  .footer { margin-top: 40px; border-top: 1px solid #eee; padding: 16px 0; text-align: center; font-size: 11px; color: #999; }
  @media print { .no-print { display:none; } body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
</style>
</head>
<body>
<div class="copertina">
  <div class="emoji">${db ? db.icona : "ğŸ“š"}</div>
  <h1>${argomento || matLabel}</h1>
  <div class="sub">Materia: ${matLabel}${event.tipoVerifica ? ' â€” ' + event.tipoVerifica : ''}</div>
  <div class="data">Generato il ${oggi} â€¢ Il Mio Anno</div>
</div>
<div class="contenuto-wrap">
  ${sezioniHTML}
  <div class="footer">Scheda di ripasso generata da Il Mio Anno â€¢ Studiare bene! ğŸ’ª</div>
</div>
</body>
</html>`;
}

function EserciziPanel({event,onClose}){
  const {dark}=React.useContext(ThemeCtx);
  const [step,setStep]=useState("scelta"); // scelta | quiz-setup | loading | quiz | pdf
  const [livello,setLivello]=useState(3);
  const [domande,setDomande]=useState([]);
  const [vis,setVis]=useState(false);
  useEffect(()=>{requestAnimationFrame(()=>setVis(true))},[]);
  const close=()=>{setVis(false);setTimeout(onClose,320)};
  const bg=dark?"#1C1C1E":"#F2F2F7";
  const card=dark?"#2C2C2E":"#fff";
  const txt=dark?"#fff":"#1C1C1E";
  const sub=dark?"rgba(255,255,255,0.4)":"rgba(60,60,67,0.45)";
  const livelli=["ğŸ˜´ Per niente","ğŸ˜Ÿ Poco","ğŸ˜ Abbastanza","ğŸ˜Š Bene","ğŸ”¥ Pronto!"];
  const livelloLabel=["Facile","Facile","Medio","Difficile","Difficile"];

  const [pdfLoading,setPdfLoading]=useState(false);
  const apriPdf=async()=>{
    setPdfLoading(true);
    const mat=MATERIE?MATERIE.find(m=>m.id===(event.materia||"altra")):null;
    const matLabel=mat?mat.label:(event.materia||"questa materia");
    const arg=event.argomento||"";
    const tipo=event.tipoVerifica||"Verifica";
    const oggi=new Date().toLocaleDateString('it-IT',{day:'numeric',month:'long',year:'numeric'});
    const colori={matematica:"#2C3E7A",chimica:"#1A6B3C",fisica:"#7A2C2C",storia:"#7A5A2C",scienze:"#1A6B5A",inglese:"#2C5A7A",geografia:"#3D7A2C",filosofia:"#5A2C7A",italiano:"#7A2C5A",latino:"#6B3D1A",informatica:"#1A3D6B",arte:"#7A4A1A",musica:"#4A1A7A",ed_fisica:"#1A7A4A",altra:"#3D3D3D"};
    const colore=colori[event.materia||"altra"]||"#333";
    try{
      const prompt=`Sei un professore italiano esperto di ${matLabel}. Crea una guida di studio COMPLETA e DETTAGLIATA su: "${arg||matLabel}".

Struttura il contenuto con sezioni chiare. Includi:
1. Introduzione e panoramica dell'argomento
2. Concetti fondamentali con spiegazioni chiare
3. Regole, formule o strutture principali (usa simboli testuali per le formule, es: x^2, H2O)
4. Esempi concreti risolti passo per passo
5. Errori comuni da evitare
6. Punti chiave da ricordare per la ${tipo}

Scrivi in italiano, sii preciso e completo. Usa intestazioni con ### per le sezioni. Non usare HTML, solo testo con ### per i titoli e - per le liste.`;

      const testo = await callClaude(prompt, 2000);
      
      // Converti markdown semplice in HTML
      const html2 = testo
        .split('\n')
        .map(r=>{
          if(r.startsWith('### ')) return `<h3>${r.slice(4)}</h3>`;
          if(r.startsWith('## '))  return `<h2>${r.slice(3)}</h2>`;
          if(r.startsWith('# '))   return `<h2>${r.slice(2)}</h2>`;
          if(r.startsWith('- '))   return `<li>${r.slice(2)}</li>`;
          if(r.startsWith('* '))   return `<li>${r.slice(2)}</li>`;
          if(r.match(/^\d+\. /)) return `<li>${r.replace(/^\d+\. /,'')}</li>`;
          if(r.trim()==='')       return '<br>';
          return `<p>${r}</p>`;
        })
        .join('\n')
        .replace(/(<li>.*<\/li>\n?)+/g, m=>`<ul>${m}</ul>`);

      const htmlFull=`<!DOCTYPE html><html lang="it"><head><meta charset="UTF-8"><title>${arg||matLabel}</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Inter',Arial,sans-serif;color:#1a1a1a;background:#fff}
  .cover{background:linear-gradient(135deg,${colore},${colore}99);color:#fff;padding:50px;min-height:180px}
  .cover h1{font-size:26px;font-weight:700;margin-bottom:8px}
  .cover .sub{font-size:15px;opacity:.85}
  .cover .data{font-size:12px;opacity:.6;margin-top:10px}
  .body{padding:40px 50px;max-width:800px}
  h2{font-size:17px;font-weight:700;color:${colore};border-left:4px solid ${colore};padding:8px 14px;background:${colore}12;margin:24px 0 10px;border-radius:0 6px 6px 0}
  h3{font-size:15px;font-weight:600;color:#333;margin:18px 0 8px}
  p{font-size:14px;line-height:1.75;color:#2a2a2a;margin:4px 0}
  ul{padding-left:20px;margin:8px 0}
  li{font-size:14px;line-height:1.7;color:#2a2a2a;margin:3px 0}
  br{display:block;margin:4px 0}
  .footer{margin-top:40px;border-top:1px solid #eee;padding:16px 0;text-align:center;font-size:11px;color:#999}
  .btn{position:fixed;top:16px;right:16px;padding:10px 20px;background:${colore};color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.2)}
  @media print{.btn{display:none};body{-webkit-print-color-adjust:exact;print-color-adjust:exact}}
</style></head><body>
<button class="btn" onclick="window.print()">ğŸ“„ Salva PDF</button>
<div class="cover"><h1>ğŸ“š ${arg||matLabel}</h1><div class="sub">${tipo} di ${matLabel}</div><div class="data">Generato il ${oggi} con Claude AI â€¢ Il Mio Anno</div></div>
<div class="body">${html2}<div class="footer">Scheda generata da Claude AI â€¢ Buono studio! ğŸ’ª</div></div>
</body></html>`;
      const blob=new Blob([htmlFull],{type:"text/html"});
      window.open(URL.createObjectURL(blob),"_blank");
    }catch(e){
      // Fallback locale
      const html=generaHTMLPdf(event);
      const blob=new Blob([html],{type:"text/html"});
      window.open(URL.createObjectURL(blob),"_blank");
    }finally{
      setPdfLoading(false);
    }
  };

  const avviaQuiz=async()=>{
    setStep("loading");
    const mat=MATERIE?MATERIE.find(m=>m.id===(event.materia||"altra")):null;
    const matLabel=mat?mat.label:(event.materia||"questa materia");
    const arg=event.argomento||"";
    const diff=livello<=2?"molto facili, per chi Ã¨ agli inizi":livello===3?"di media difficoltÃ ":livello===4?"difficili":"molto difficili e approfondite";
    try{
      const prompt=`Sei un professore italiano di ${matLabel}. Crea esattamente 5 domande a risposta multipla ${diff} su "${arg||matLabel}".

Rispondi SOLO con JSON valido (niente altro, niente backtick, niente markdown):
[{"d":"Domanda?","r":["Risposta A","Risposta B","Risposta C","Risposta D"],"c":"Risposta A"},...]

Regole:
- Le domande devono riguardare specificatamente "${arg||matLabel}"
- Le risposte sbagliate devono essere plausibili
- La risposta corretta "c" deve essere identica a una delle risposte in "r"
- Varia il tipo: definizioni, calcoli, esempi, applicazioni`;

      const raw=await callClaude(prompt,800);
      const clean=raw.replace(/\`\`\`json|\`\`\`/g,"").replace(/^[^[]+/,"").replace(/[^\]]+$/,"").trim();
      const parsed=JSON.parse(clean);
      setDomande(parsed.map(q=>({domanda:q.d,risposte:[...q.r].sort(()=>Math.random()-0.5),corretta:q.c,scelta:null})));
      setStep("quiz");
    }catch(e){
      // Fallback locale
      const pool=QUIZ_DB[event.materia||"altra"]||QUIZ_DB.altra;
      let filtrate=livello<=2?pool.filter(q=>q.lv===1):livello===3?pool.filter(q=>q.lv<=2):pool.filter(q=>q.lv>=2);
      if(filtrate.length<3) filtrate=pool;
      setDomande([...filtrate].sort(()=>Math.random()-0.5).slice(0,5).map(q=>({domanda:q.d,risposte:[...q.r].sort(()=>Math.random()-0.5),corretta:q.c,scelta:null})));
      setStep("quiz");
    }
  };

  const rispondi=(i,r)=>setDomande(prev=>prev.map((d,j)=>j===i?{...d,scelta:r}:d));
  const punteggio=domande.filter(d=>d.scelta===d.corretta).length;
  const tutteRisposte=domande.length>0&&domande.every(d=>d.scelta!==null);

  return (
    <div onClick={e=>e.target===e.currentTarget&&close()} style={{position:"fixed",inset:0,zIndex:600,background:vis?"rgba(0,0,0,0.5)":"rgba(0,0,0,0)",backdropFilter:"blur(8px)",transition:"background 0.3s",display:"flex",flexDirection:"column",justifyContent:"flex-end"}}>
      <div style={{background:bg,borderRadius:"20px 20px 0 0",maxHeight:"92vh",display:"flex",flexDirection:"column",transform:vis?"translateY(0)":"translateY(100%)",transition:"transform 0.4s cubic-bezier(0.32,0.72,0,1)",paddingBottom:"env(safe-area-inset-bottom,24px)"}}>
        <div style={{display:"flex",justifyContent:"center",padding:"10px 0 0"}}><div style={{width:"36px",height:"4px",background:dark?"rgba(255,255,255,0.15)":"rgba(60,60,67,0.15)",borderRadius:"2px"}}/></div>
        <div style={{padding:"14px 20px 10px",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0}}>
          <div>
            <div style={{fontSize:"20px",fontWeight:"700",color:txt}}>ğŸ§  Ripasso</div>
            <div style={{fontSize:"13px",color:sub,marginTop:"2px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"240px"}}>{event.title}</div>
          </div>
          <button onClick={close} style={{background:dark?"rgba(255,255,255,0.1)":"rgba(60,60,67,0.1)",border:"none",borderRadius:"50%",width:"30px",height:"30px",cursor:"pointer",color:sub,fontSize:"18px",display:"flex",alignItems:"center",justifyContent:"center"}}>Ã—</button>
        </div>

        <div style={{overflowY:"auto",flex:1,padding:"0 16px 16px"}}>

          {/* SCELTA MODALITÃ€ */}
          {step==="scelta"&&(
            <div style={{animation:"fadeUp 0.2s ease"}}>
              <div style={{fontSize:"14px",fontWeight:"600",color:sub,marginBottom:"12px",textAlign:"center",textTransform:"uppercase",letterSpacing:"0.05em"}}>Scegli come studiare</div>
              {/* PDF */}
              <div onClick={()=>!pdfLoading&&apriPdf()} style={{background:card,borderRadius:"16px",padding:"18px",marginBottom:"10px",cursor:pdfLoading?"default":"pointer",display:"flex",alignItems:"center",gap:"14px",border:`2px solid ${dark?"rgba(255,255,255,0.08)":"rgba(0,0,0,0.06)"}`,opacity:pdfLoading?0.7:1}}>
                <div style={{width:"46px",height:"46px",borderRadius:"12px",background:"rgba(255,59,48,0.12)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"22px",flexShrink:0}}>ğŸ“„</div>
                <div style={{flex:1}}>
                  <div style={{fontSize:"16px",fontWeight:"700",color:txt,marginBottom:"3px"}}>Scheda PDF</div>
                  <div style={{fontSize:"13px",color:sub}}>Regole, formule ed esempi su {event.argomento||"questa materia"}</div>
                </div>
                <div style={{fontSize:"20px",color:sub}}>â€º</div>
              </div>
              {/* QUIZ */}
              <div onClick={()=>setStep("quiz-setup")} style={{background:card,borderRadius:"16px",padding:"18px",marginBottom:"10px",cursor:"pointer",display:"flex",alignItems:"center",gap:"14px",border:`2px solid ${dark?"rgba(255,255,255,0.08)":"rgba(0,0,0,0.06)"}`}}>
                <div style={{width:"46px",height:"46px",borderRadius:"12px",background:"rgba(0,122,255,0.12)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"22px",flexShrink:0}}>ğŸ¯</div>
                <div style={{flex:1}}>
                  <div style={{fontSize:"16px",fontWeight:"700",color:txt,marginBottom:"3px"}}>Quiz a risposta multipla</div>
                  <div style={{fontSize:"13px",color:sub}}>5 domande sulla materia, difficoltÃ  adattiva</div>
                </div>
                <div style={{fontSize:"20px",color:sub}}>â€º</div>
              </div>
              {/* ENTRAMBI */}
              <div onClick={()=>{apriPdf();setStep("quiz-setup");}} style={{background:"rgba(255,59,48,0.08)",borderRadius:"16px",padding:"14px 18px",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",border:"2px solid rgba(255,59,48,0.2)"}}>
                <span style={{fontSize:"18px"}}>âœ¨</span>
                <span style={{fontSize:"14px",fontWeight:"600",color:"#FF3B30"}}>Apri PDF e poi fai il quiz</span>
              </div>
            </div>
          )}

          {/* QUIZ SETUP */}
          {step==="quiz-setup"&&(
            <div style={{animation:"fadeUp 0.2s ease"}}>
              <div style={{background:card,borderRadius:"16px",padding:"16px",marginBottom:"12px"}}>
                <div style={{fontSize:"14px",fontWeight:"600",color:txt,marginBottom:"4px"}}>Come ti senti preparato?</div>
                <div style={{fontSize:"12px",color:sub,marginBottom:"12px"}}>La difficoltÃ  si adatta al tuo livello</div>
                <div style={{display:"flex",flexDirection:"column",gap:"8px"}}>
                  {livelli.map((l,i)=>(
                    <div key={i} onClick={()=>setLivello(i+1)} style={{padding:"12px 16px",borderRadius:"12px",border:`2px solid ${livello===i+1?"#FF3B30":"transparent"}`,background:livello===i+1?"rgba(255,59,48,0.1)":dark?"rgba(255,255,255,0.05)":"rgba(60,60,67,0.04)",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px"}}>
                      <span style={{fontSize:"20px"}}>{l.split(" ")[0]}</span>
                      <div style={{flex:1}}>
                        <div style={{fontSize:"15px",fontWeight:livello===i+1?"600":"400",color:livello===i+1?"#FF3B30":txt}}>{l.split(" ").slice(1).join(" ")}</div>
                        <div style={{fontSize:"11px",color:sub}}>Domande {livelloLabel[i]}</div>
                      </div>
                      {livello===i+1&&<div style={{width:"20px",height:"20px",borderRadius:"50%",background:"#FF3B30",display:"flex",alignItems:"center",justifyContent:"center"}}><span style={{color:"#fff",fontSize:"12px"}}>âœ“</span></div>}
                    </div>
                  ))}
                </div>
              </div>
              <div style={{display:"flex",gap:"8px"}}>
                <button onClick={()=>setStep("scelta")} style={{flex:1,padding:"14px",borderRadius:"14px",border:`2px solid ${dark?"rgba(255,255,255,0.1)":"rgba(60,60,67,0.1)"}`,background:"transparent",color:txt,fontFamily:"inherit",fontSize:"15px",fontWeight:"600",cursor:"pointer"}}>â† Indietro</button>
                <button onClick={avviaQuiz} style={{flex:2,padding:"14px",borderRadius:"14px",border:"none",background:"#FF3B30",color:"#fff",fontFamily:"inherit",fontSize:"15px",fontWeight:"600",cursor:"pointer"}}>Inizia quiz âœ¨</button>
              </div>
            </div>
          )}

          {step==="loading"&&(
            <div style={{textAlign:"center",padding:"60px 0"}}>
              <div style={{fontSize:"44px",marginBottom:"16px"}} className="pulse">ğŸ§ </div>
              <div style={{fontSize:"15px",fontWeight:"600",color:txt}}>Preparo le domandeâ€¦</div>
            </div>
          )}

          {step==="quiz"&&(
            <div style={{animation:"fadeUp 0.2s ease"}}>
              <div style={{background:dark?"rgba(255,59,48,0.12)":"rgba(255,59,48,0.08)",borderRadius:"10px",padding:"8px 12px",marginBottom:"12px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                <span style={{fontSize:"12px",color:"#FF3B30",fontWeight:"600"}}>ğŸ¯ Quiz â€” {livelloLabel[livello-1]}</span>
                <span style={{fontSize:"12px",color:"#FF3B30",fontWeight:"600"}}>{domande.filter(d=>d.scelta!==null).length}/{domande.length}</span>
              </div>
              {domande.map((d,i)=>(
                <div key={i} style={{background:card,borderRadius:"16px",padding:"16px",marginBottom:"12px"}}>
                  <div style={{fontSize:"11px",fontWeight:"700",color:sub,marginBottom:"6px"}}>DOMANDA {i+1}</div>
                  <div style={{fontSize:"15px",fontWeight:"600",color:txt,marginBottom:"14px",lineHeight:1.5}}>{d.domanda}</div>
                  <div style={{display:"flex",flexDirection:"column",gap:"8px"}}>
                    {d.risposte.map((r,j)=>{
                      const risp=d.scelta; const isC=r===d.corretta; const isS=r===risp;
                      let bgR=dark?"rgba(255,255,255,0.06)":"rgba(60,60,67,0.06)";
                      let bord="2px solid transparent"; let colR=txt;
                      if(risp!==null){if(isC){bgR="rgba(52,199,89,0.15)";bord="2px solid #34C759";colR="#34C759";}else if(isS){bgR="rgba(255,59,48,0.12)";bord="2px solid #FF3B30";colR="#FF3B30";}}
                      return (
                        <div key={j} onClick={()=>risp===null&&rispondi(i,r)} style={{padding:"11px 14px",borderRadius:"12px",border:bord,background:bgR,cursor:risp===null?"pointer":"default",display:"flex",alignItems:"center",gap:"10px",transition:"all 0.15s"}}>
                          <div style={{width:"24px",height:"24px",borderRadius:"50%",background:risp!==null?(isC?"#34C759":isS?"#FF3B30":dark?"rgba(255,255,255,0.08)":"rgba(0,0,0,0.06)"):"rgba(0,122,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,fontSize:"11px",fontWeight:"700",color:risp!==null?(isC||isS?"#fff":"#888"):"#007AFF"}}>
                            {risp!==null?(isC?"âœ“":isS?"âœ—":String.fromCharCode(65+j)):String.fromCharCode(65+j)}
                          </div>
                          <span style={{fontSize:"14px",color:colR,fontWeight:(isS||isC)&&risp!==null?"600":"400",flex:1,lineHeight:1.3}}>{r}</span>
                        </div>
                      );
                    })}
                  </div>
                  {d.scelta!==null&&<div style={{marginTop:"10px",padding:"8px 12px",borderRadius:"10px",background:d.scelta===d.corretta?"rgba(52,199,89,0.1)":"rgba(255,59,48,0.08)"}}><span style={{fontSize:"13px",fontWeight:"600",color:d.scelta===d.corretta?"#34C759":"#FF3B30"}}>{d.scelta===d.corretta?"âœ… Corretto!":"âŒ Risposta esatta: "+d.corretta}</span></div>}
                </div>
              ))}
              {tutteRisposte&&(
                <div style={{background:card,borderRadius:"16px",padding:"20px",marginBottom:"12px",textAlign:"center",border:`2px solid ${punteggio===domande.length?"#34C759":punteggio>=domande.length*0.6?"#FF9500":"#FF3B30"}`}}>
                  <div style={{fontSize:"40px",marginBottom:"8px"}}>{punteggio===domande.length?"ğŸ†":punteggio>=domande.length*0.6?"â­":"ğŸ’ª"}</div>
                  <div style={{fontSize:"26px",fontWeight:"700",color:txt}}>{punteggio}/{domande.length}</div>
                  <div style={{fontSize:"14px",color:sub,marginTop:"4px"}}>{punteggio===domande.length?"Perfetto! Sei pronto! ğŸ¯":punteggio>=domande.length*0.6?"Bene! Ripassa i punti sbagliati":"Studia ancora, poi riprova!"}</div>
                </div>
              )}
              <div style={{display:"flex",gap:"8px"}}>
                <button onClick={()=>{setDomande([]);setStep("quiz-setup");}} style={{flex:1,padding:"13px",borderRadius:"14px",border:`2px solid ${dark?"rgba(255,255,255,0.1)":"rgba(60,60,67,0.1)"}`,background:"transparent",color:txt,fontFamily:"inherit",fontSize:"14px",fontWeight:"600",cursor:"pointer"}}>â†º Nuovo quiz</button>
                <button onClick={()=>setStep("scelta")} style={{flex:1,padding:"13px",borderRadius:"14px",border:`2px solid ${dark?"rgba(255,255,255,0.1)":"rgba(60,60,67,0.1)"}`,background:"transparent",color:txt,fontFamily:"inherit",fontSize:"14px",fontWeight:"600",cursor:"pointer"}}>ğŸ“„ PDF</button>
                <button onClick={close} style={{flex:1,padding:"13px",borderRadius:"14px",border:"none",background:"#FF3B30",color:"#fff",fontFamily:"inherit",fontSize:"14px",fontWeight:"600",cursor:"pointer"}}>Fine ğŸ¯</button>
              </div>
            </div>
          )}

        </div>
      </div>
    </div>
  );
}


function ListaSpesaPanel({event,onClose,onSaveNote}){
  const {dark}=React.useContext(ThemeCtx);
  const [piatti,setPiatti]=useState("");
  const [step,setStep]=useState("input");
  const [lista,setLista]=useState({lista:[],suggerimenti:[]});
  const [loadMsg,setLoadMsg]=useState("");
  const [vis,setVis]=useState(false);
  useEffect(()=>{requestAnimationFrame(()=>setVis(true))},[]);
  const close=()=>{setVis(false);setTimeout(onClose,320)};
  const bg=dark?"#1C1C1E":"#F2F2F7";
  const card=dark?"#2C2C2E":"#fff";
  const txt=dark?"#fff":"#1C1C1E";
  const sub=dark?"rgba(255,255,255,0.4)":"rgba(60,60,67,0.45)";

  const genera=async()=>{
    if(!piatti.trim())return;
    setStep("loading");
    setLoadMsg("ğŸ§  Claude sta pensando alla ricettaâ€¦");
    try{
      const prompt=`Sei un cuoco italiano esperto. L'utente vuole cucinare: "${piatti}".

Crea la lista della spesa COMPLETA e PRECISA con tutti gli ingredienti necessari.

Rispondi SOLO con JSON valido, senza markdown, senza backtick:
{
  "lista":[
    {"nome":"nome ingrediente","quantita":"quantitÃ  precisa","categoria":"emoji categoria"},
    ...
  ],
  "suggerimenti":[
    {"nome":"ingrediente opzionale","motivo":"perchÃ© aggiungerlo"},
    ...
  ]
}

Regole:
- Includi TUTTI gli ingredienti reali della ricetta (niente ingredienti inventati o generici)
- Le quantitÃ  devono essere precise per 4 persone
- Categorie emoji: ğŸ¥© carne/pesce, ğŸ¥¬ verdure/frutta, ğŸ¥› latticini/uova, ğŸ¥« dispensa/scatolette, ğŸŒ¾ cereali/farina, ğŸ§‚ spezie/condimenti
- Massimo 3 suggerimenti utili`;

      setLoadMsg("ğŸ“ Preparo la listaâ€¦");
      const raw = await callClaude(prompt, 600);
      const clean = raw.replace(/```json|```/g,"").trim();
      const parsed = JSON.parse(clean);
      setLista(parsed);
      setStep("lista");
    }catch(e){
      // Fallback locale
      setLoadMsg("ğŸ“š Uso ricettario localeâ€¦");
      await new Promise(r=>setTimeout(r,300));
      setLista(generaListaSpesaOffline(piatti));
      setStep("lista");
    }
  };

  const [checked,setChecked]=useState({});
  const toggle=n=>setChecked(p=>({...p,[n]:!p[n]}));
  const nChecked=Object.values(checked).filter(Boolean).length;

  return (
    <div onClick={e=>e.target===e.currentTarget&&close()} style={{position:"fixed",inset:0,zIndex:600,background:vis?"rgba(0,0,0,0.5)":"rgba(0,0,0,0)",backdropFilter:"blur(8px)",transition:"background 0.3s",display:"flex",flexDirection:"column",justifyContent:"flex-end"}}>
      <div style={{background:bg,borderRadius:"20px 20px 0 0",maxHeight:"90vh",display:"flex",flexDirection:"column",transform:vis?"translateY(0)":"translateY(100%)",transition:"transform 0.4s cubic-bezier(0.32,0.72,0,1)",paddingBottom:"env(safe-area-inset-bottom,24px)"}}>
        <div style={{display:"flex",justifyContent:"center",padding:"10px 0 0"}}><div style={{width:"36px",height:"4px",background:dark?"rgba(255,255,255,0.15)":"rgba(60,60,67,0.15)",borderRadius:"2px"}}/></div>
        <div style={{padding:"14px 20px 10px",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0}}>
          <div>
            <div style={{fontSize:"20px",fontWeight:"700",color:txt}}>ğŸ›’ Lista della spesa</div>
            <div style={{fontSize:"13px",color:sub,marginTop:"2px"}}>{step==="lista"&&lista.ricetteTrovate?.length>0?`ğŸ“– ${lista.ricetteTrovate.join(", ")}`:"Ingredienti precisi per le tue ricette"}</div>
          </div>
          <button onClick={close} style={{background:dark?"rgba(255,255,255,0.1)":"rgba(60,60,67,0.1)",border:"none",borderRadius:"50%",width:"30px",height:"30px",cursor:"pointer",color:sub,fontSize:"18px",display:"flex",alignItems:"center",justifyContent:"center"}}>Ã—</button>
        </div>

        <div style={{overflowY:"auto",flex:1,padding:"0 16px 16px"}}>

          {step==="input"&&(
            <div style={{animation:"fadeUp 0.2s ease"}}>
              <div style={{background:card,borderRadius:"16px",padding:"16px",marginBottom:"16px"}}>
                <div style={{fontSize:"14px",fontWeight:"600",color:txt,marginBottom:"4px"}}>Cosa vuoi cucinare? ğŸ³</div>
                <div style={{fontSize:"12px",color:sub,marginBottom:"10px"}}>Scrivi il nome del piatto (es: pasta carbonara, tiramisÃ¹, pizza margherita)</div>
                <textarea value={piatti} onChange={e=>setPiatti(e.target.value)} placeholder={"Es: pasta alla carbonara, tiramisÃ¹\noppure: cena completa con primo e dolceâ€¦"} style={{width:"100%",minHeight:"90px",border:"none",background:dark?"rgba(255,255,255,0.06)":"rgba(60,60,67,0.06)",borderRadius:"12px",padding:"12px",fontSize:"15px",fontFamily:"inherit",color:txt,outline:"none",resize:"none",display:"block",boxSizing:"border-box"}}/>
              </div>
              <button onClick={genera} disabled={!piatti.trim()} style={{width:"100%",padding:"15px",borderRadius:"14px",border:"none",background:piatti.trim()?"#34C759":"rgba(60,60,67,0.1)",color:piatti.trim()?"#fff":sub,fontFamily:"inherit",fontSize:"16px",fontWeight:"600",cursor:piatti.trim()?"pointer":"default",transition:"all 0.2s"}}>
                Genera lista ğŸ›’
              </button>
            </div>
          )}

          {step==="loading"&&(
            <div style={{textAlign:"center",padding:"50px 0"}}>
              <div style={{fontSize:"40px",marginBottom:"16px"}} className="pulse">ğŸ›’</div>
              <div style={{fontSize:"15px",fontWeight:"600",color:txt,marginBottom:"6px"}}>{loadMsg}</div>
              <div style={{fontSize:"12px",color:sub}}>Qualche secondoâ€¦</div>
            </div>
          )}

          {step==="lista"&&lista.lista&&(
            <div style={{animation:"fadeUp 0.2s ease"}}>
              <div style={{background:card,borderRadius:"16px",overflow:"hidden",marginBottom:"12px"}}>
                <div style={{padding:"12px 16px",borderBottom:`1px solid ${dark?"rgba(255,255,255,0.08)":"rgba(60,60,67,0.08)"}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                  <span style={{fontSize:"13px",fontWeight:"700",color:sub,letterSpacing:"0.04em"}}>DA COMPRARE</span>
                  <span style={{fontSize:"12px",color:sub}}>{nChecked}/{lista.lista.length}</span>
                </div>
                {lista.lista.map((item,i)=>(
                  <div key={i} onClick={()=>toggle(item.nome)} style={{padding:"11px 16px",display:"flex",alignItems:"center",gap:"12px",borderBottom:i<lista.lista.length-1?`1px solid ${dark?"rgba(255,255,255,0.06)":"rgba(60,60,67,0.06)"}`:"none",cursor:"pointer",background:checked[item.nome]?(dark?"rgba(255,255,255,0.02)":"rgba(0,0,0,0.01)"):"transparent",transition:"background 0.1s"}}>
                    <div style={{width:"22px",height:"22px",borderRadius:"50%",border:`2px solid ${checked[item.nome]?"#34C759":"rgba(60,60,67,0.25)"}`,background:checked[item.nome]?"#34C759":"transparent",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"all 0.15s"}}>
                      {checked[item.nome]&&<span style={{color:"#fff",fontSize:"12px",fontWeight:"700"}}>âœ“</span>}
                    </div>
                    <span style={{fontSize:"22px",flexShrink:0}}>{item.categoria}</span>
                    <div style={{flex:1}}>
                      <span style={{fontSize:"15px",fontWeight:"500",color:checked[item.nome]?sub:txt,textDecoration:checked[item.nome]?"line-through":"none"}}>{item.nome}</span>
                    </div>
                    <span style={{fontSize:"12px",color:sub,flexShrink:0}}>{item.quantita}</span>
                  </div>
                ))}
              </div>

              {lista.suggerimenti?.length>0&&(
                <div style={{marginBottom:"12px"}}>
                  <div style={{fontSize:"11px",fontWeight:"700",color:sub,letterSpacing:"0.05em",marginBottom:"8px",paddingLeft:"4px"}}>POTRESTI AGGIUNGERE</div>
                  <div style={{background:card,borderRadius:"16px",overflow:"hidden"}}>
                    {lista.suggerimenti.map((s,i)=>(
                      <div key={i} onClick={()=>toggle("sg_"+s.nome)} style={{padding:"11px 16px",display:"flex",alignItems:"center",gap:"12px",borderBottom:i<lista.suggerimenti.length-1?`1px solid ${dark?"rgba(255,255,255,0.06)":"rgba(60,60,67,0.06)"}`:"none",cursor:"pointer"}}>
                        <div style={{width:"22px",height:"22px",borderRadius:"50%",border:`2px solid ${checked["sg_"+s.nome]?"#34C759":"rgba(52,199,89,0.4)"}`,background:checked["sg_"+s.nome]?"#34C759":"rgba(52,199,89,0.08)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
                          {checked["sg_"+s.nome]?<span style={{color:"#fff",fontSize:"12px"}}>âœ“</span>:<span style={{color:"#34C759",fontSize:"14px"}}>+</span>}
                        </div>
                        <div style={{flex:1}}>
                          <div style={{fontSize:"14px",fontWeight:"500",color:txt}}>{s.nome}</div>
                          <div style={{fontSize:"11px",color:sub,marginTop:"1px"}}>{s.motivo}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {nChecked>0&&nChecked===lista.lista.length&&(
                <div style={{background:"rgba(52,199,89,0.12)",border:"1px solid rgba(52,199,89,0.3)",borderRadius:"12px",padding:"12px 16px",marginBottom:"12px",textAlign:"center"}}>
                  <div style={{fontSize:"22px",marginBottom:"4px"}}>ğŸ‰</div>
                  <div style={{fontSize:"14px",fontWeight:"700",color:"#34C759"}}>Hai preso tutto!</div>
                </div>
              )}

              <div style={{display:"flex",gap:"8px"}}>
                <button onClick={()=>{setStep("input");setChecked({});setPiatti("");}} style={{flex:1,padding:"13px",borderRadius:"14px",border:`2px solid ${dark?"rgba(255,255,255,0.1)":"rgba(60,60,67,0.1)"}`,background:"transparent",color:txt,fontFamily:"inherit",fontSize:"14px",fontWeight:"600",cursor:"pointer"}}>â†º Nuova lista</button>
                <button onClick={close} style={{flex:1,padding:"13px",borderRadius:"14px",border:"none",background:"#34C759",color:"#fff",fontFamily:"inherit",fontSize:"14px",fontWeight:"600",cursor:"pointer"}}>âœ“ Fatto!</button>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// â”€â”€ NOTE VOCALI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function VoiceNoteBtn({onNote}){
  const {dark}=React.useContext(ThemeCtx);
  const [recording,setRecording]=useState(false);
  const [supported]=useState(()=>'SpeechRecognition' in window||'webkitSpeechRecognition' in window);
  const recRef=useRef(null);

  const start=()=>{
    if(!supported)return alert("Il riconoscimento vocale non Ã¨ supportato su questo browser.");
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    const rec=new SR();
    rec.lang="it-IT";
    rec.continuous=false;
    rec.interimResults=false;
    rec.onresult=e=>{const text=e.results[0][0].transcript;onNote(text);};
    rec.onend=()=>setRecording(false);
    rec.onerror=()=>setRecording(false);
    recRef.current=rec;
    rec.start();
    setRecording(true);
  };
  const stop=()=>{recRef.current?.stop();setRecording(false);};

  if(!supported)return null;
  return (
    <button onClick={recording?stop:start} style={{background:recording?"#FF3B30":"rgba(60,60,67,0.08)",border:"none",borderRadius:"20px",padding:"7px 14px",cursor:"pointer",fontFamily:"inherit",fontSize:"13px",fontWeight:"600",color:recording?"#fff":dark?"#fff":"#1C1C1E",display:"flex",alignItems:"center",gap:"6px",transition:"all 0.2s"}}>
      {recording?<><span className="pulse">ğŸ”´</span>Stop</>:<><span>ğŸ¤</span>Voce</>}
    </button>
  );
}

// â”€â”€ ALERTS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AlertsPanel({alerts,onClose,onGo}){
  const {dark}=React.useContext(ThemeCtx);
  const [vis,setVis]=useState(false);
  useEffect(()=>{requestAnimationFrame(()=>setVis(true))},[]);
  const close=()=>{setVis(false);setTimeout(onClose,320)};
  const US={urgent:{color:"#FF3B30",label:"URGENTE"},high:{color:"#FF9500",label:"IMPORTANTE"},medium:{color:"#FFCC00",label:"ATTENZIONE"},low:{color:"#007AFF",label:"PROMEMORIA"}};
  return (
    <div onClick={e=>e.target===e.currentTarget&&close()} style={{position:"fixed",inset:0,zIndex:500,background:vis?"rgba(0,0,0,0.4)":"rgba(0,0,0,0)",transition:"background 0.3s",display:"flex",flexDirection:"column",justifyContent:"flex-end"}}>
      <div style={{background:"#1C1C1E",borderRadius:"20px 20px 0 0",maxHeight:"88vh",display:"flex",flexDirection:"column",transform:vis?"translateY(0)":"translateY(100%)",transition:"transform 0.4s cubic-bezier(0.32,0.72,0,1)",paddingBottom:"env(safe-area-inset-bottom,24px)"}}>
        <div style={{display:"flex",justifyContent:"center",padding:"10px 0 0"}}><div style={{width:"36px",height:"4px",background:"rgba(255,255,255,0.15)",borderRadius:"2px"}}/></div>
        <div style={{padding:"16px 20px 14px",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
          <div>
            <div style={{fontSize:"22px",fontWeight:"700",color:"#fff",letterSpacing:"-0.5px"}}>Promemoria</div>
            <div style={{fontSize:"13px",color:"rgba(255,255,255,0.35)",marginTop:"2px"}}>{alerts.length} avvisi</div>
          </div>
          <button onClick={close} style={{background:"rgba(255,255,255,0.1)",border:"none",borderRadius:"50%",width:"30px",height:"30px",cursor:"pointer",color:"rgba(255,255,255,0.5)",fontSize:"16px",display:"flex",alignItems:"center",justifyContent:"center"}}>Ã—</button>
        </div>
        <div style={{overflowY:"auto",flex:1,padding:"0 16px 16px",display:"flex",flexDirection:"column",gap:"8px"}}>
          {alerts.map((a,i)=>{
            const s=US[a.u],[,am,ad]=a.day.split("-");
            const dl=a.d===0?"Oggi":a.d===1?"Domani":`${parseInt(ad)} ${MONTHS_S[parseInt(am)-1]}`;
            return (
              <div key={i} className="tap" onClick={()=>{onGo(a.day);close();}} style={{background:"#2C2C2E",borderRadius:"14px",padding:"14px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:"14px"}}>
                <div style={{width:"40px",height:"40px",borderRadius:"12px",background:s.color+"20",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"20px",flexShrink:0}}>{a.icon}</div>
                <div style={{flex:1,minWidth:0}}>
                  <div style={{display:"flex",gap:"6px",alignItems:"center",marginBottom:"3px"}}>
                    <span style={{fontSize:"10px",fontWeight:"700",color:s.color,letterSpacing:"0.05em"}}>{s.label}</span>
                    <span style={{fontSize:"11px",color:"rgba(255,255,255,0.3)"}}>Â· {dl}</span>
                  </div>
                  <div style={{fontWeight:"600",fontSize:"14px",color:"#fff",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{a.e.title}</div>
                  <div style={{fontSize:"12px",color:"rgba(255,255,255,0.35)",marginTop:"2px"}}>{a.msg}</div>
                </div>
                <span style={{color:"rgba(255,255,255,0.2)",fontSize:"16px"}}>â€º</span>
              </div>
            );
          })}
        </div>
        <div style={{padding:"0 16px"}}><button onClick={close} style={{width:"100%",padding:"15px",borderRadius:"14px",border:"none",background:"#007AFF",color:"#fff",fontFamily:"inherit",fontSize:"16px",fontWeight:"600",cursor:"pointer"}}>OK</button></div>
      </div>
    </div>
  );
}

// â”€â”€ MODAL EVENTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Modal({dayKey,onClose,onSave,editEvent}){
  const {dark}=React.useContext(ThemeCtx);
  const [step,setStep]=useState(editEvent?"details":"category");
  const [cat,setCat]=useState(editEvent?.category||null);
  const [materia,setMat]=useState(editEvent?.materia||null);
  const [cMat,setCMat]=useState(editEvent?.customMateria||"");
  const [arg,setArg]=useState(editEvent?.argomento||"");
  const [tipo,setTipo]=useState(editEvent?.tipoVerifica||"");
  const [name,setName]=useState(editEvent?.personName||"");
  const [age,setAge]=useState(editEvent?.personAge||"");
  const [sugg,setSugg]=useState(editEvent?.selectedSugg||null);
  const [ctitle,setCtitle]=useState(editEvent?.customTitle||"");
  const [time,setTime]=useState(editEvent?.time||"");
  const [note,setNote]=useState(editEvent?.note||"");
  const [vis,setVis]=useState(false);
  useEffect(()=>{requestAnimationFrame(()=>setVis(true))},[]);
  const close=()=>{setVis(false);setTimeout(onClose,320)};
  const C=CATS.find(c=>c.id===cat);
  const [,km,kd]=dayKey.split("-");
  const bg=dark?"#1C1C1E":"#F2F2F7";
  const card=dark?"#2C2C2E":"#fff";
  const txt=dark?"#fff":"#1C1C1E";
  const sub=dark?"rgba(255,255,255,0.4)":"rgba(60,60,67,0.45)";
  const steps=cat==="verifica"?["category","materia","argomento","details"]:cat==="compleanno"?["category","compleanno","details"]:["category","suggerimenti","details"];
  const si=steps.indexOf(step);

  const SUGG_MAP={
    commissione:[{label:"Fare la spesa",emoji:"ğŸ›’"},{label:"Farmacia",emoji:"ğŸ’Š"},{label:"Pagare bollette",emoji:"ğŸ’°"},{label:"Posta",emoji:"ğŸ“®"},{label:"Ritirare pacco",emoji:"ğŸ“¦"},{label:"Banca / ATM",emoji:"ğŸ¦"},{label:"Meccanico",emoji:"ğŸ”§"},{label:"Shopping",emoji:"ğŸ›ï¸"},{label:"Veterinario",emoji:"ğŸ¾"},{label:"Referti medici",emoji:"ğŸ“‹"},{label:"Altro",emoji:"âœï¸"}],
    appuntamento:[{label:"Medico",emoji:"ğŸ‘¨â€âš•ï¸"},{label:"Dentista",emoji:"ğŸ¦·"},{label:"Specialista",emoji:"ğŸ¥"},{label:"Fisioterapia",emoji:"ğŸ’†"},{label:"Analisi sangue",emoji:"ğŸ©¸"},{label:"Oculista",emoji:"ğŸ‘ï¸"},{label:"Colloquio scuola",emoji:"ğŸ«"},{label:"Riunione",emoji:"ğŸ’¼"},{label:"Colloquio lavoro",emoji:"ğŸ‘”"},{label:"Parrucchiere",emoji:"âœ‚ï¸"},{label:"Altro",emoji:"âœï¸"}],
    todo:[{label:"Studiare",emoji:"ğŸ“š"},{label:"Fare sport",emoji:"ğŸƒ"},{label:"Chiamare qualcuno",emoji:"ğŸ“"},{label:"Pulire casa",emoji:"ğŸ§¹"},{label:"Lavanderia",emoji:"ğŸ‘•"},{label:"Cucinare",emoji:"ğŸ³"},{label:"Leggere",emoji:"ğŸ“–"},{label:"Organizzare",emoji:"ğŸ—‚ï¸"},{label:"Meditare",emoji:"ğŸ§˜"},{label:"Progetto",emoji:"ğŸ’¡"},{label:"Altro",emoji:"âœï¸"}],
  };

  const buildTitle=()=>{
    if(cat==="verifica"){const m=MATERIE.find(x=>x.id===materia);const ml=materia==="altra"?cMat:m?.label;return arg?`${m?.emoji||"ğŸ“š"} ${tipo||"Verifica"} ${ml} â€” ${arg}`:`${m?.emoji||"ğŸ“š"} ${tipo||"Verifica"} di ${ml}`;}
    if(cat==="compleanno")return `ğŸ‚ Compleanno di ${name}${age?` (${age} anni)`:""}`;
    return sugg==="Altro"?ctitle:(sugg||"");
  };
  const ok=()=>{
    if(step==="argomento")return materia!=="altra"||cMat.trim();
    if(step==="compleanno")return name.trim();
    if(step==="suggerimenti")return sugg&&(sugg!=="Altro"||ctitle.trim());
    return true;
  };
  const save=()=>{const t=buildTitle();if(!t.trim())return;onSave({id:editEvent?.id||Date.now(),category:cat,title:t,time,note,materia,customMateria:cMat,argomento:arg,tipoVerifica:tipo,personName:name,personAge:age,selectedSugg:sugg,customTitle:ctitle});close();};
  const go=s=>setStep(s);

  return (
    <div onClick={e=>e.target===e.currentTarget&&close()} style={{position:"fixed",inset:0,zIndex:400,background:vis?"rgba(0,0,0,0.4)":"rgba(0,0,0,0)",backdropFilter:"blur(8px)",transition:"all 0.3s",display:"flex",flexDirection:"column",justifyContent:"flex-end"}}>
      <div style={{background:bg,borderRadius:"20px 20px 0 0",maxHeight:"92vh",overflowY:"auto",paddingBottom:"env(safe-area-inset-bottom,20px)",transform:vis?"translateY(0)":"translateY(100%)",transition:"transform 0.4s cubic-bezier(0.32,0.72,0,1)"}}>
        <div style={{display:"flex",justifyContent:"center",padding:"10px 0 0"}}><div style={{width:"36px",height:"4px",background:dark?"rgba(255,255,255,0.15)":"rgba(60,60,67,0.15)",borderRadius:"2px"}}/></div>
        <div style={{padding:"14px 20px 10px",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
          <div>
            <div style={{fontSize:"12px",color:sub}}>{parseInt(kd)} {MONTHS[parseInt(km)-1]}</div>
            <div style={{fontSize:"20px",fontWeight:"700",color:txt,letterSpacing:"-0.3px",marginTop:"2px"}}>{C?`${C.emoji} ${C.label}`:"Nuovo evento"}</div>
          </div>
          <button onClick={close} style={{background:dark?"rgba(255,255,255,0.1)":"rgba(60,60,67,0.1)",border:"none",borderRadius:"50%",width:"30px",height:"30px",cursor:"pointer",color:sub,fontSize:"18px",display:"flex",alignItems:"center",justifyContent:"center"}}>Ã—</button>
        </div>
        {cat&&<div style={{display:"flex",gap:"3px",padding:"0 20px 12px"}}>{steps.map((s,i)=><div key={s} style={{height:"3px",flex:1,borderRadius:"2px",background:i<=si?(C?.color||"#007AFF"):dark?"rgba(255,255,255,0.1)":"rgba(60,60,67,0.1)",transition:"background 0.3s"}}/>)}</div>}

        <div style={{padding:"0 16px 20px"}}>
          {step==="category"&&<div style={{animation:"fadeUp 0.2s ease"}}>
            <div style={{fontSize:"13px",color:sub,marginBottom:"10px",paddingLeft:"4px"}}>Seleziona categoria</div>
            {CATS.map(c=>(
              <div key={c.id} className="tap" onClick={()=>{setCat(c.id);c.id==="verifica"?go("materia"):c.id==="compleanno"?go("compleanno"):go("suggerimenti")}} style={{background:card,borderRadius:"14px",padding:"14px 16px",marginBottom:"8px",display:"flex",alignItems:"center",gap:"14px",cursor:"pointer"}}>
                <div style={{width:"44px",height:"44px",borderRadius:"12px",background:c.bg,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"22px"}}>{c.emoji}</div>
                <div style={{flex:1}}>
                  <div style={{fontWeight:"600",fontSize:"16px",color:txt}}>{c.label}</div>
                  <div style={{fontSize:"12px",color:sub,marginTop:"2px"}}>
                    {c.id==="verifica"&&"Materia + esercizi AI"}{c.id==="compleanno"&&"Nome di chi festeggia"}
                    {c.id==="commissione"&&"Lista spesa AI inclusa"}{c.id==="appuntamento"&&"Medico, dentistaâ€¦"}
                    {c.id==="todo"&&"Cose da non dimenticare"}
                  </div>
                </div>
                <span style={{color:sub,fontSize:"20px"}}>â€º</span>
              </div>
            ))}
          </div>}

          {step==="materia"&&<div style={{animation:"fadeUp 0.18s ease"}}>
            <button onClick={()=>go("category")} style={{...BK,color:"#007AFF"}}>â€¹ Indietro</button>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"8px"}}>
              {MATERIE.map(m=>(
                <div key={m.id} className="tap" onClick={()=>{setMat(m.id);go("argomento")}} style={{background:materia===m.id?"#007AFF":card,borderRadius:"12px",padding:"12px 8px",cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",gap:"5px",transition:"all 0.15s"}}>
                  <span style={{fontSize:"22px"}}>{m.emoji}</span>
                  <span style={{fontSize:"11px",textAlign:"center",color:materia===m.id?"#fff":txt,fontWeight:"500",lineHeight:1.2}}>{m.label}</span>
                </div>
              ))}
            </div>
          </div>}

          {step==="argomento"&&<div style={{animation:"fadeUp 0.18s ease"}}>
            <button onClick={()=>go("materia")} style={{...BK,color:"#007AFF"}}>â€¹ Indietro</button>
            {materia==="altra"&&<div style={{background:card,borderRadius:"14px",padding:"4px 16px",marginBottom:"10px"}}><label style={{...LB,color:sub}}>Materia</label><input value={cMat} onChange={e=>setCMat(e.target.value)} placeholder="Es. Dirittoâ€¦" style={{...IP,color:txt}} autoFocus/></div>}
            <div style={{background:card,borderRadius:"14px",padding:"14px 16px",marginBottom:"10px"}}>
              <label style={{...LB,color:sub}}>Tipo di verifica</label>
              <div style={{display:"flex",gap:"6px",flexWrap:"wrap",marginTop:"8px"}}>{TIPI.map(t=><button key={t} onClick={()=>setTipo(tipo===t?"":t)} style={{padding:"7px 14px",borderRadius:"20px",fontFamily:"inherit",border:"none",background:tipo===t?"#FF3B30":dark?"rgba(255,255,255,0.08)":"rgba(60,60,67,0.08)",color:tipo===t?"#fff":txt,fontSize:"14px",fontWeight:"500",cursor:"pointer",transition:"all 0.15s"}}>{t}</button>)}</div>
            </div>
            <div style={{background:card,borderRadius:"14px",padding:"4px 16px",marginBottom:"8px"}}>
              <label style={{...LB,color:sub}}>Argomento <span style={{fontWeight:"400",opacity:0.5}}>(opzionale)</span></label>
              <input value={arg} onChange={e=>setArg(e.target.value)} placeholder="Es. Equazioni, Risorgimentoâ€¦" style={{...IP,color:txt}}/>
            </div>
            <div style={{display:"flex",gap:"8px",marginBottom:"16px",alignItems:"center"}}>
              <VoiceNoteBtn onNote={v=>setArg(v)}/>
              <span style={{fontSize:"12px",color:sub}}>Ditta l'argomento</span>
            </div>
            <button onClick={()=>ok()&&go("details")} style={{...BB,background:ok()?"#FF3B30":"rgba(60,60,67,0.1)",color:ok()?"#fff":sub}}>Continua</button>
          </div>}

          {step==="compleanno"&&<div style={{animation:"fadeUp 0.18s ease"}}>
            <button onClick={()=>go("category")} style={{...BK,color:"#007AFF"}}>â€¹ Indietro</button>
            <div style={{textAlign:"center",fontSize:"50px",margin:"8px 0 14px"}}>ğŸ‚</div>
            <div style={{background:card,borderRadius:"14px",padding:"4px 16px",marginBottom:"10px"}}><label style={{...LB,color:sub}}>Nome</label><input value={name} onChange={e=>setName(e.target.value)} placeholder="Es. Marcoâ€¦" style={{...IP,color:txt}} autoFocus/></div>
            <div style={{background:card,borderRadius:"14px",padding:"4px 16px",marginBottom:"16px"}}><label style={{...LB,color:sub}}>Quanti anni?</label><input value={age} onChange={e=>setAge(e.target.value)} placeholder="Es. 18â€¦" style={{...IP,color:txt}} type="number"/></div>
            <button onClick={()=>name.trim()&&go("details")} style={{...BB,background:name.trim()?"#FF9500":"rgba(60,60,67,0.1)",color:name.trim()?"#fff":sub}}>Continua</button>
          </div>}

          {step==="suggerimenti"&&<div style={{animation:"fadeUp 0.18s ease"}}>
            <button onClick={()=>go("category")} style={{...BK,color:"#007AFF"}}>â€¹ Indietro</button>
            <div style={{fontSize:"13px",color:sub,marginBottom:"10px",paddingLeft:"4px"}}>{cat==="commissione"&&"Cosa devi fare?"}{cat==="appuntamento"&&"Che tipo di appuntamento?"}{cat==="todo"&&"Cosa vuoi ricordarti?"}</div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"8px",marginBottom:"10px"}}>
              {SUGG_MAP[cat]?.map(s=>(
                <div key={s.label} className="tap" onClick={()=>setSugg(s.label)} style={{background:sugg===s.label?(C?.color||"#007AFF"):card,borderRadius:"12px",padding:"12px",cursor:"pointer",display:"flex",alignItems:"center",gap:"10px",transition:"all 0.15s"}}>
                  <span style={{fontSize:"20px"}}>{s.emoji}</span>
                  <span style={{fontSize:"13px",fontWeight:"500",color:sugg===s.label?"#fff":txt,lineHeight:1.2}}>{s.label}</span>
                </div>
              ))}
            </div>
            {sugg==="Altro"&&<div style={{background:card,borderRadius:"14px",padding:"4px 16px",marginBottom:"10px"}}><input value={ctitle} onChange={e=>setCtitle(e.target.value)} placeholder="Scrivi cosa devi fareâ€¦" style={{...IP,color:txt}} autoFocus/></div>}
            <button onClick={()=>ok()&&go("details")} style={{...BB,background:ok()?(C?.color||"#007AFF"):"rgba(60,60,67,0.1)",color:ok()?"#fff":sub}}>Continua</button>
          </div>}

          {step==="details"&&<div style={{animation:"fadeUp 0.18s ease"}}>
            <button onClick={()=>cat==="verifica"?go("argomento"):cat==="compleanno"?go("compleanno"):go("suggerimenti")} style={{...BK,color:"#007AFF"}}>â€¹ Indietro</button>
            <div style={{background:card,borderRadius:"14px",padding:"14px 16px",marginBottom:"10px",borderLeft:`4px solid ${C?.color||"#007AFF"}`}}>
              <div style={{fontSize:"11px",color:sub,fontWeight:"600",marginBottom:"4px",textTransform:"uppercase",letterSpacing:"0.04em"}}>{C?.label}</div>
              <div style={{fontWeight:"600",fontSize:"15px",color:txt}}>{buildTitle()}</div>
            </div>
            <div style={{background:card,borderRadius:"14px",padding:"4px 16px",marginBottom:"10px"}}><label style={{...LB,color:sub}}>Orario</label><input type="time" value={time} onChange={e=>setTime(e.target.value)} style={{...IP,color:txt}}/></div>
            <div style={{background:card,borderRadius:"14px",padding:"4px 16px",marginBottom:"8px"}}><label style={{...LB,color:sub}}>Note</label><textarea value={note} onChange={e=>setNote(e.target.value)} placeholder="Aggiungi dettagliâ€¦" style={{...IP,color:txt,height:"60px",resize:"none",paddingTop:"8px"}}/></div>
            <div style={{display:"flex",gap:"8px",marginBottom:"16px",alignItems:"center"}}>
              <VoiceNoteBtn onNote={v=>setNote(v)}/>
              <span style={{fontSize:"12px",color:sub}}>Ditta le note</span>
            </div>
            <button onClick={save} style={{...BB,background:C?.color||"#007AFF"}}>Salva evento</button>
          </div>}
        </div>
      </div>
    </div>
  );
}

// â”€â”€ DAY SHEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DaySheet({dayKey,events,onAdd,onEdit,onDel,onClose}){
  const {dark}=React.useContext(ThemeCtx);
  const [vis,setVis]=useState(false);
  const [aiEvent,setAiEvent]=useState(null);
  const [aiType,setAiType]=useState(null);
  const [,km,kd]=dayKey.split("-");
  const isT=dayKey===todayStr;
  const diff=daysBetween(dayKey);
  useEffect(()=>{requestAnimationFrame(()=>setVis(true))},[]);
  const close=()=>{setVis(false);setTimeout(onClose,320)};
  const bg=dark?"#1C1C1E":"#F2F2F7";
  const card=dark?"#2C2C2E":"#fff";
  const txt=dark?"#fff":"#1C1C1E";
  const sub=dark?"rgba(255,255,255,0.4)":"rgba(60,60,67,0.45)";
  return (
    <>
    <div onClick={e=>e.target===e.currentTarget&&close()} style={{position:"fixed",inset:0,zIndex:300,background:vis?"rgba(0,0,0,0.25)":"rgba(0,0,0,0)",transition:"background 0.3s",display:"flex",flexDirection:"column",justifyContent:"flex-end"}}>
      <div style={{background:bg,borderRadius:"20px 20px 0 0",maxHeight:"75vh",display:"flex",flexDirection:"column",transform:vis?"translateY(0)":"translateY(100%)",transition:"transform 0.4s cubic-bezier(0.32,0.72,0,1)",paddingBottom:"env(safe-area-inset-bottom,16px)"}}>
        <div style={{display:"flex",justifyContent:"center",padding:"10px 0 0"}}><div style={{width:"36px",height:"4px",background:dark?"rgba(255,255,255,0.15)":"rgba(60,60,67,0.15)",borderRadius:"2px"}}/></div>
        <div style={{padding:"12px 20px 12px",display:"flex",alignItems:"center",justifyContent:"space-between",borderBottom:`1px solid ${dark?"rgba(255,255,255,0.08)":"rgba(60,60,67,0.1)"}`}}>
          <div>
            <div style={{fontSize:"21px",fontWeight:"700",color:txt,letterSpacing:"-0.4px",display:"flex",alignItems:"center",gap:"8px"}}>
              {parseInt(kd)} {MONTHS[parseInt(km)-1]}
              {isT&&<span style={{fontSize:"12px",background:"#FF3B30",color:"#fff",padding:"2px 10px",borderRadius:"10px",fontWeight:"600"}}>oggi</span>}
            </div>
            <div style={{fontSize:"13px",color:sub,marginTop:"2px"}}>{events.length} {events.length===1?"evento":"eventi"}</div>
          </div>
          <button onClick={onAdd} style={{background:"#007AFF",color:"#fff",border:"none",borderRadius:"20px",padding:"8px 18px",fontSize:"14px",fontWeight:"600",cursor:"pointer",fontFamily:"inherit"}}>+ Aggiungi</button>
        </div>
        <div style={{overflowY:"auto",flex:1,padding:"12px 16px"}}>
          {events.length===0?(
            <div style={{textAlign:"center",padding:"32px 0"}}>
              <div style={{fontSize:"38px",marginBottom:"8px"}}>ğŸ“‹</div>
              <div style={{color:sub,fontSize:"15px",fontWeight:"500"}}>Nessun evento</div>
              <div style={{color:dark?"rgba(255,255,255,0.2)":"rgba(60,60,67,0.25)",fontSize:"13px",marginTop:"4px"}}>Tocca + Aggiungi</div>
            </div>
          ):(
            <div style={{background:card,borderRadius:"14px",overflow:"hidden"}}>
              {events.map((ev,i)=>{
                const c=getCat(ev.category);
                const evDiff=daysBetween(dayKey);
                const showAiBtn=ev.category==="verifica"||(ev.category==="commissione"&&ev.title?.includes("spesa"));
                return (
                  <div key={ev.id}>
                    <div style={{padding:"12px 14px",display:"flex",alignItems:"center",gap:"12px",borderBottom:`1px solid ${dark?"rgba(255,255,255,0.06)":"rgba(60,60,67,0.06)"}`}}>
                      <div style={{width:"10px",height:"10px",borderRadius:"50%",background:c.color,flexShrink:0}}/>
                      <div style={{flex:1,minWidth:0}}>
                        <div style={{fontWeight:"500",fontSize:"15px",color:txt,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{ev.title}</div>
                        <div style={{fontSize:"12px",color:sub,marginTop:"2px",display:"flex",alignItems:"center",gap:"6px"}}>
                          <span>{c.label}{ev.time?` Â· ${ev.time}`:""}</span>
                          {ev.category==="verifica"&&evDiff>0&&<span style={{background:"#FF3B30",color:"#fff",borderRadius:"6px",padding:"1px 5px",fontSize:"10px",fontWeight:"700"}}>-{evDiff}g</span>}
                        </div>
                      </div>
                      <button onClick={()=>onEdit(ev)} style={{background:"none",border:"none",cursor:"pointer",color:sub,fontSize:"15px",padding:"4px"}}>âœï¸</button>
                      <button onClick={()=>onDel(ev.id)} style={{background:"none",border:"none",cursor:"pointer",color:dark?"rgba(255,255,255,0.2)":"rgba(60,60,67,0.2)",fontSize:"20px",padding:"4px"}}>Ã—</button>
                    </div>
                    {/* AI buttons */}
                    {showAiBtn&&(
                      <div style={{padding:"8px 14px 10px",display:"flex",gap:"8px",borderBottom:i<events.length-1?`1px solid ${dark?"rgba(255,255,255,0.06)":"rgba(60,60,67,0.06)"}`:"none"}}>
                        {ev.category==="verifica"&&(
                          <button onClick={()=>{setAiEvent(ev);setAiType("esercizi");}} style={{padding:"6px 12px",borderRadius:"12px",border:"none",background:"rgba(255,59,48,0.1)",color:"#FF3B30",fontSize:"12px",fontWeight:"600",cursor:"pointer",fontFamily:"inherit",display:"flex",alignItems:"center",gap:"4px"}}>
                            ğŸ§  Ripasso AI
                          </button>
                        )}
                        {ev.category==="commissione"&&(ev.selectedSugg==="Fare la spesa"||ev.title?.toLowerCase().includes("spesa"))&&(
                          <button onClick={()=>{setAiEvent(ev);setAiType("spesa");}} style={{padding:"6px 12px",borderRadius:"12px",border:"none",background:"rgba(52,199,89,0.1)",color:"#34C759",fontSize:"12px",fontWeight:"600",cursor:"pointer",fontFamily:"inherit",display:"flex",alignItems:"center",gap:"4px"}}>
                            ğŸ›’ Lista spesa AI
                          </button>
                        )}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>
    </div>
    {aiEvent&&aiType==="esercizi"&&<EserciziPanel event={aiEvent} onClose={()=>setAiEvent(null)}/>}
    {aiEvent&&aiType==="spesa"&&<ListaSpesaPanel event={aiEvent} onClose={()=>setAiEvent(null)}/>}
    </>
  );
}

// â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App(){
  const [pref,setPref]=useState(loadPref);
  const [year,setYear]=useState(today.getFullYear());
  const [month,setMonth]=useState(today.getMonth());
  const [events,setEvents]=useState(loadEv);
  const [selDay,setSelDay]=useState(null);
  const [showModal,setShowModal]=useState(false);
  const [editEv,setEditEv]=useState(null);
  const [view,setView]=useState("month");
  const [fCat,setFCat]=useState(null);
  const [showAl,setShowAl]=useState(false);
  const meteo=useMeteo();
  const dark=pref.dark;

  const toggleDark=()=>{const np={...pref,dark:!dark};setPref(np);savePref(np);document.body.className=np.dark?"dark":"light";};
  useEffect(()=>{document.body.className=dark?"dark":"light";},[dark]);
  useEffect(()=>{saveEv(events)},[events]);
  useEffect(()=>{const a=getAlerts(events);if(a.length>0)setTimeout(()=>setShowAl(true),700);},[]);

  const alerts=getAlerts(events);
  const getDay=k=>events[k]||[];
  const handleSave=ev=>{setEvents(p=>{const d=p[selDay]||[];if(editEv)return{...p,[selDay]:d.map(e=>e.id===ev.id?ev:e)};return{...p,[selDay]:[...d,ev]};});};
  const delEv=(k,id)=>setEvents(p=>({...p,[k]:(p[k]||[]).filter(e=>e.id!==id)}));

  const bg=dark?"#000":"#fff";
  const bgSub=dark?"#1C1C1E":"#F2F2F7";
  const txt=dark?"#fff":"#1C1C1E";
  const sub=dark?"rgba(255,255,255,0.35)":"rgba(60,60,67,0.45)";
  const border=dark?"rgba(255,255,255,0.08)":"rgba(60,60,67,0.1)";
  const card=dark?"#1C1C1E":"#F2F2F7";

  const totM=Object.entries(events).filter(([k])=>k.startsWith(`${year}-${String(month+1).padStart(2,'0')}`)).flatMap(([,e])=>e).length;
  const allEv=Object.entries(events).flatMap(([day,evs])=>evs.map(e=>({...e,day}))).filter(e=>e.day.startsWith(String(year))).filter(e=>!fCat||e.category===fCat).sort((a,b)=>a.day.localeCompare(b.day));
  const upcoming=Object.entries(events).flatMap(([day,evs])=>evs.map(e=>({...e,day}))).filter(e=>e.day>=todayStr).sort((a,b)=>a.day.localeCompare(b.day)).slice(0,5);
  const wDays=Array.from({length:7},(_,i)=>{const d=new Date(),dow=d.getDay()===0?6:d.getDay()-1,dd=new Date(d);dd.setDate(d.getDate()-dow+i);return dd;});

  return (
    <ThemeCtx.Provider value={{dark,toggle:toggleDark}}>
    <div style={{fontFamily:"-apple-system,'SF Pro Text','Helvetica Neue',sans-serif",background:bg,height:"100vh",maxWidth:"430px",margin:"0 auto",display:"flex",flexDirection:"column",overflow:"hidden",transition:"background 0.3s,color 0.3s"}}>

      {/* HEADER */}
      <div style={{background:dark?"rgba(0,0,0,0.95)":"rgba(255,255,255,0.95)",backdropFilter:"blur(20px)",WebkitBackdropFilter:"blur(20px)",paddingTop:"env(safe-area-inset-top,44px)",flexShrink:0,borderBottom:`1px solid ${border}`}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"8px 16px 6px"}}>
          <div style={{display:"flex",alignItems:"center",gap:"6px"}}>
            <button className="tap" onClick={()=>{const n=addMonths(year,month,-1);setYear(n.year);setMonth(n.month);}} style={{background:"none",border:"none",cursor:"pointer",fontSize:"24px",color:"#007AFF",padding:"2px 6px",lineHeight:1}}>â€¹</button>
            {/* Meteo */}
            {meteo&&<div style={{fontSize:"13px",color:sub,display:"flex",alignItems:"center",gap:"3px"}}><span>{meteo.icon}</span><span>{meteo.temp}Â°</span></div>}
          </div>
          <button onClick={()=>{setYear(today.getFullYear());setMonth(today.getMonth());}} style={{background:"none",border:"none",cursor:"pointer",textAlign:"center",padding:"2px 8px"}}>
            <div style={{fontSize:"17px",fontWeight:"700",color:txt,letterSpacing:"-0.3px",lineHeight:1}}>{MONTHS[month]} {year}</div>
            {totM>0&&<div style={{fontSize:"11px",color:sub,marginTop:"1px"}}>{totM} eventi</div>}
          </button>
          <div style={{display:"flex",alignItems:"center",gap:"2px"}}>
            <button className="tap" onClick={toggleDark} style={{background:"none",border:"none",cursor:"pointer",padding:"2px 6px",fontSize:"18px"}}>{dark?"â˜€ï¸":"ğŸŒ™"}</button>
            <button className="tap" onClick={()=>setShowAl(true)} style={{background:"none",border:"none",cursor:"pointer",padding:"2px 6px",position:"relative"}}>
              <span style={{fontSize:"18px"}}>ğŸ””</span>
              {alerts.length>0&&<div style={{position:"absolute",top:"-2px",right:"2px",minWidth:"15px",height:"15px",background:"#FF3B30",borderRadius:"8px",fontSize:"9px",color:"#fff",fontWeight:"700",display:"flex",alignItems:"center",justifyContent:"center",padding:"0 3px",border:`1.5px solid ${bg}`}}>{alerts.length}</div>}
            </button>
            <button className="tap" onClick={()=>{const n=addMonths(year,month,1);setYear(n.year);setMonth(n.month);}} style={{background:"none",border:"none",cursor:"pointer",fontSize:"24px",color:"#007AFF",padding:"2px 6px",lineHeight:1}}>â€º</button>
          </div>
        </div>
        <div style={{display:"flex",padding:"0 16px"}}>
          {[["month","Calendario"],["list","Lista"]].map(([v,l])=>(
            <button key={v} onClick={()=>setView(v)} style={{flex:1,padding:"6px 0 8px",border:"none",background:"transparent",fontFamily:"inherit",fontSize:"13px",fontWeight:view===v?"600":"400",color:view===v?"#007AFF":sub,cursor:"pointer",borderBottom:view===v?"2px solid #007AFF":"2px solid transparent",transition:"all 0.2s"}}>{l}</button>
          ))}
        </div>
      </div>

      {/* CONTENT */}
      <div style={{flex:1,overflowY:"auto",paddingBottom:"80px"}}>
        {view==="month"&&(
          <div>
            <div style={{padding:"8px 8px 4px"}}>
              <SwipeCalendar year={year} month={month} events={events} alerts={alerts}
                onDay={setSelDay} onMonthChange={(y,m)=>{setYear(y);setMonth(m);}}/>
            </div>

            {upcoming.length>0&&(
              <div style={{padding:"0 12px",marginTop:"8px"}}>
                <div style={{fontSize:"11px",fontWeight:"600",color:sub,letterSpacing:"0.06em",marginBottom:"8px",paddingLeft:"4px"}}>PROSSIMI EVENTI</div>
                <div style={{background:dark?"#1C1C1E":"#F2F2F7",borderRadius:"14px",overflow:"hidden"}}>
                  {upcoming.map((ev,i)=>{
                    const c=getCat(ev.category),d=daysBetween(ev.day),[,em,ed]=ev.day.split("-");
                    return (
                      <div key={`${ev.day}-${ev.id}`} className="tap" onClick={()=>setSelDay(ev.day)} style={{padding:"10px 14px",display:"flex",alignItems:"center",gap:"12px",cursor:"pointer",borderBottom:i<upcoming.length-1?`1px solid ${border}`:"none",background:dark?"#2C2C2E":"#fff"}}>
                        <div style={{width:"32px",height:"32px",borderRadius:"8px",background:c.bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",flexShrink:0}}>
                          <div style={{fontSize:"13px",fontWeight:"700",color:c.color,lineHeight:1}}>{parseInt(ed)}</div>
                          <div style={{fontSize:"8px",color:c.color,fontWeight:"500"}}>{MONTHS_S[parseInt(em)-1]}</div>
                        </div>
                        <div style={{flex:1,minWidth:0}}>
                          <div style={{fontWeight:"500",fontSize:"14px",color:txt,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{ev.title}</div>
                          <div style={{fontSize:"11px",color:sub,marginTop:"1px",display:"flex",alignItems:"center",gap:"5px"}}>
                            {d===0?<span style={{color:c.color,fontWeight:"600"}}>Oggi</span>:d===1?<span style={{color:"#FF9500",fontWeight:"600"}}>Domani</span>:<span>{c.label}</span>}
                            {ev.time&&` Â· ${ev.time}`}
                            {ev.category==="verifica"&&d>0&&d<=15&&<span style={{background:"#FF3B30",color:"#fff",borderRadius:"5px",padding:"1px 5px",fontSize:"10px",fontWeight:"700"}}>-{d}g</span>}
                          </div>
                        </div>
                        <span style={{color:sub,fontSize:"14px"}}>â€º</span>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            <div style={{margin:"10px 12px 0",background:dark?"#1C1C1E":"#F2F2F7",borderRadius:"14px",padding:"12px 14px"}}>
              <div style={{fontSize:"10px",fontWeight:"600",color:sub,letterSpacing:"0.06em",marginBottom:"8px"}}>CATEGORIE</div>
              <div style={{display:"flex",flexWrap:"wrap",gap:"6px 18px"}}>
                {CATS.map(c=><div key={c.id} style={{display:"flex",alignItems:"center",gap:"5px"}}><div style={{width:"7px",height:"7px",borderRadius:"50%",background:c.color}}/><span style={{fontSize:"12px",color:sub}}>{c.label}</span></div>)}
              </div>
            </div>
          </div>
        )}

        {view==="list"&&(
          <div style={{padding:"12px"}}>
            <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"12px"}}>
              <button className="tap" onClick={()=>setYear(y=>y-1)} style={{background:"none",border:"none",fontSize:"22px",color:"#007AFF",cursor:"pointer",padding:"4px 10px"}}>â€¹</button>
              <span style={{fontSize:"17px",fontWeight:"700",color:txt}}>{year}</span>
              <button className="tap" onClick={()=>setYear(y=>y+1)} style={{background:"none",border:"none",fontSize:"22px",color:"#007AFF",cursor:"pointer",padding:"4px 10px"}}>â€º</button>
            </div>
            <div style={{display:"flex",gap:"6px",overflowX:"auto",paddingBottom:"4px",marginBottom:"12px"}}>
              <button onClick={()=>setFCat(null)} style={{padding:"5px 14px",borderRadius:"20px",border:"none",flexShrink:0,background:!fCat?"#007AFF":dark?"#2C2C2E":"#F2F2F7",color:!fCat?"#fff":sub,fontSize:"13px",fontWeight:"500",cursor:"pointer",fontFamily:"inherit"}}>Tutti</button>
              {CATS.map(c=><button key={c.id} onClick={()=>setFCat(fCat===c.id?null:c.id)} style={{padding:"5px 12px",borderRadius:"20px",border:"none",flexShrink:0,background:fCat===c.id?c.color:dark?"#2C2C2E":"#F2F2F7",color:fCat===c.id?"#fff":c.color,fontSize:"13px",fontWeight:"500",cursor:"pointer",fontFamily:"inherit"}}>{c.emoji} {c.label}</button>)}
            </div>
            {allEv.length===0?(
              <div style={{textAlign:"center",padding:"50px 0"}}><div style={{fontSize:"40px",marginBottom:"10px"}}>ğŸ“‹</div><div style={{color:sub,fontSize:"15px"}}>Nessun evento</div></div>
            ):(
              <div style={{background:dark?"#1C1C1E":"#fff",borderRadius:"14px",overflow:"hidden"}}>
                {allEv.map((ev,i)=>{
                  const c=getCat(ev.category),[,em,ed]=ev.day.split("-"),d=daysBetween(ev.day);
                  return (
                    <div key={`${ev.day}-${ev.id}`} style={{padding:"11px 14px",display:"flex",alignItems:"center",gap:"12px",borderBottom:i<allEv.length-1?`1px solid ${border}`:"none"}}>
                      <div style={{width:"32px",height:"32px",borderRadius:"8px",background:c.bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",flexShrink:0}}>
                        <div style={{fontSize:"13px",fontWeight:"700",color:c.color,lineHeight:1}}>{parseInt(ed)}</div>
                        <div style={{fontSize:"8px",color:c.color,fontWeight:"500"}}>{MONTHS_S[parseInt(em)-1]}</div>
                      </div>
                      <div style={{flex:1,minWidth:0}}>
                        <div style={{fontWeight:"500",fontSize:"14px",color:txt,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{ev.title}</div>
                        <div style={{fontSize:"11px",color:sub,marginTop:"1px",display:"flex",alignItems:"center",gap:"5px"}}>
                          <span>{c.label}{ev.time?` Â· ${ev.time}`:""}</span>
                          {ev.category==="verifica"&&d>0&&d<=15&&<span style={{background:"#FF3B30",color:"#fff",borderRadius:"5px",padding:"1px 5px",fontSize:"10px",fontWeight:"700"}}>-{d}g</span>}
                        </div>
                      </div>
                      <button onClick={()=>delEv(ev.day,ev.id)} style={{background:"none",border:"none",cursor:"pointer",color:sub,fontSize:"20px",padding:"4px"}}>Ã—</button>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        )}
      </div>

      {/* BOTTOM WEEK */}
      <div style={{position:"fixed",bottom:0,left:"50%",transform:"translateX(-50%)",width:"100%",maxWidth:"430px",background:dark?"rgba(0,0,0,0.95)":"rgba(255,255,255,0.95)",backdropFilter:"blur(20px)",WebkitBackdropFilter:"blur(20px)",borderTop:`1px solid ${border}`,padding:"6px 10px env(safe-area-inset-bottom,16px)",zIndex:150}}>
        <div style={{display:"flex",justifyContent:"space-between"}}>
          {wDays.map((d,i)=>{
            const key=fmt(d.getFullYear(),d.getMonth(),d.getDate()),evs=getDay(key),isT=key===todayStr,hasAl=alerts.some(a=>a.day===key);
            return (
              <div key={i} className="tap" onClick={()=>setSelDay(key)} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",padding:"3px 1px",cursor:"pointer",position:"relative"}}>
                {hasAl&&!isT&&<div style={{position:"absolute",top:"0",right:"4px",width:"5px",height:"5px",borderRadius:"50%",background:"#FF3B30"}}/>}
                <div style={{fontSize:"10px",fontWeight:"500",color:isT?"#FF3B30":sub,marginBottom:"3px"}}>{DAYS[i]}</div>
                <div style={{width:"30px",height:"30px",borderRadius:"50%",background:isT?"#FF3B30":"transparent",display:"flex",alignItems:"center",justifyContent:"center"}}>
                  <div style={{fontSize:"15px",fontWeight:isT?"700":"400",color:isT?"#fff":i>=5?"#FF9500":txt}}>{d.getDate()}</div>
                </div>
                <div style={{width:"4px",height:"4px",borderRadius:"50%",marginTop:"2px",background:evs.length>0?(isT?"rgba(255,255,255,0.8)":getCat(evs[0].category).color):"transparent"}}/>
              </div>
            );
          })}
        </div>
      </div>

      {showAl&&<AlertsPanel alerts={alerts} onClose={()=>setShowAl(false)} onGo={day=>{setSelDay(day);setMonth(parseInt(day.split("-")[1])-1);setYear(parseInt(day.split("-")[0]));setView("month");}}/>}
      {selDay&&!showModal&&!showAl&&<DaySheet dayKey={selDay} events={getDay(selDay)} onAdd={()=>{setEditEv(null);setShowModal(true)}} onEdit={ev=>{setEditEv(ev);setShowModal(true)}} onDel={id=>delEv(selDay,id)} onClose={()=>setSelDay(null)}/>}
      {showModal&&selDay&&<Modal dayKey={selDay} onClose={()=>setShowModal(false)} onSave={handleSave} editEvent={editEv}/>}
    </div>
    </ThemeCtx.Provider>
  );
}

const BK={background:"none",border:"none",cursor:"pointer",fontFamily:"inherit",fontSize:"15px",padding:"0 0 14px 0",display:"block"};
const LB={display:"block",fontSize:"11px",fontWeight:"600",padding:"10px 0 0",textTransform:"uppercase",letterSpacing:"0.05em"};
const IP={width:"100%",padding:"8px 0 12px",border:"none",fontSize:"16px",fontFamily:"inherit",outline:"none",background:"transparent",display:"block"};
const BB={width:"100%",padding:"15px",borderRadius:"14px",border:"none",fontFamily:"inherit",fontSize:"16px",fontWeight:"600",cursor:"pointer",transition:"all 0.15s",color:"#fff"};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
