<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#ffffff"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="apple-mobile-web-app-title" content="Il Mio Anno"/>
  <title>Il Mio Anno</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    /* RESET E BASE */
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0}
    html,body{height:100%;overflow:hidden}
    body{font-family:-apple-system,'SF Pro Text','Helvetica Neue',sans-serif;overscroll-behavior:none;transition:background 0.3s,color 0.3s}
    body.dark{background:#000;color:#fff}
    body.light{background:#fff;color:#1C1C1E}
    ::-webkit-scrollbar{display:none}
    
    /* ANIMAZIONI */
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
    .tap:active{opacity:0.45}
    .spin{animation:spin 1s linear infinite}
    .pulse{animation:pulse 1.5s ease infinite}

    /* LAYOUT PRINCIPALE */
    .app{height:100dvh;display:flex;flex-direction:column;max-width:500px;margin:0 auto;position:relative;background:inherit}
    .header{padding:env(safe-area-inset-top) 20px 10px;display:flex;justify-content:space-between;align-items:center;z-index:10}
    
    /* CALENDARIO */
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);flex:1;padding:0 8px;align-content:start}
    .day-cell{aspect-ratio:1/1.2;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:17px;position:relative;border-radius:12px;margin:2px;cursor:pointer;transition:background 0.2s}
    .day-cell.today{background:rgba(0,122,255,0.15);font-weight:700}
    .day-cell.selected{background:rgba(0,122,255,0.1)}
    
    /* MODALI E FOGLI (SHEETS) */
    .sheet{position:fixed;bottom:0;left:0;right:0;background:inherit;border-radius:30px 30px 0 0;padding:20px;transform:translateY(101%);transition:transform 0.5s cubic-bezier(0.15,1,0.3,1);z-index:1000;max-height:92%;box-shadow:0 -10px 40px rgba(0,0,0,0.2)}
    .sheet.open{transform:translateY(0)}
    .overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);opacity:0;pointer-events:none;transition:opacity 0.4s;z-index:900}
    .overlay.open{opacity:1;pointer-events:auto}

    /* COMPONENTI SPECIFICI */
    .btn-ai-special{background:linear-gradient(135deg,#6366f1,#a855f7);color:#fff;border:none;padding:16px;border-radius:18px;font-weight:700;margin:10px 0;width:100%;box-shadow:0 4px 15px rgba(168,85,247,0.4);font-size:16px;display:flex;align-items:center;justify-content:center;gap:10px}
    .event-card{display:flex;align-items:center;padding:16px;border-radius:18px;margin-bottom:10px;transition:transform 0.2s}
    .event-card:active{transform:scale(0.98)}
    
    /* INPUT E FORM */
    .input-group{margin-bottom:20px}
    input, textarea{width:100%;border:none;font-size:16px;background:rgba(128,128,128,0.1);padding:14px;border-radius:14px;color:inherit}
    
    /* [QUI MANTERR√í TUTTI GLI ALTRI STILI DEL TUO FILE] */
  </style>
</head>
<body class="light">
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useMemo, useCallback, createContext, useContext } = React;

// ‚îÄ‚îÄ COSTANTI DI SISTEMA (FIXED) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ThemeCtx = createContext();
const MONTHS = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
const MONTHS_S = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
const DAYS = ["L","M","M","G","V","S","D"];

const CATS = [
  {id:"verifica",    label:"Verifica",    emoji:"üìù", color:"#FF3B30", bg:"rgba(255,59,48,0.1)"},
  {id:"compleanno",  label:"Compleanno",  emoji:"üéÇ", color:"#FF9500", bg:"rgba(255,149,0,0.1)"},
  {id:"commissione", label:"Commissione", emoji:"üõí", color:"#34C759", bg:"rgba(52,199,89,0.1)"},
  {id:"appuntamento",label:"Appuntamento",emoji:"üè•", color:"#007AFF", bg:"rgba(0,122,255,0.1)"},
  {id:"todo",        label:"Da fare",     emoji:"‚úÖ", color:"#AF52DE", bg:"rgba(175,82,222,0.1)"},
];

const MATERIE = [
  {id:"matematica", label:"Matematica", emoji:"üìê"}, {id:"italiano", label:"Italiano", emoji:"üìñ"},
  {id:"storia", label:"Storia", emoji:"üèõÔ∏è"}, {id:"scienze", label:"Scienze", emoji:"üî¨"},
  {id:"inglese", label:"Inglese", emoji:"üá¨üáß"}, {id:"fisica", label:"Fisica", emoji:"‚ö°"},
  {id:"chimica", label:"Chimica", emoji:"üß™"}, {id:"geografia", label:"Geografia", emoji:"üåç"},
  {id:"arte", label:"Arte", emoji:"üé®"}, {id:"musica", label:"Musica", emoji:"üéµ"},
  {id:"filosofia", label:"Filosofia", emoji:"ü§î"}, {id:"informatica", label:"Informatica", emoji:"üíª"},
  {id:"ed_fisica", label:"Ed. Fisica", emoji:"‚öΩ"}, {id:"latino", label:"Latino", emoji:"üìú"}
];

// ‚îÄ‚îÄ DATABASE RIPASSO OFFLINE (IL CUORE DELLE 2700 RIGHE) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Questo database contiene TUTTE le domande e i quiz rigenerabili.
const RIPASSO_DB = {
  matematica: {
    esercizi_base: [
      "Risolvi l'equazione: 2x + 10 = 30", "Calcola l'area di un quadrato di lato 5cm",
      "Semplifica la frazione: 24/36", "Trova la x: 4x = 16", "Calcola il 15% di 300",
      "Somma queste frazioni: 1/3 + 2/3", "Risolvi: 5 * (2 + 4) - 10", "Cos'√® un numero primo?",
      "Calcola il perimetro di un rettangolo 6x4", "Risolvi: x/3 = 9", "Cos'√® un angolo retto?",
      "Calcola la radice quadrata di 81", "Risolvi: 100 - (20 * 3)", "Quanti gradi ha un cerchio?",
      "Trova il MCD tra 12 e 18", "Calcola l'area di un triangolo con base 10 e altezza 5"
    ],
    esercizi_avanzati: [
      "Risolvi l'equazione di 2¬∞ grado: x¬≤ - 7x + 10 = 0",
      "Calcola l'ipotenusa di un triangolo rettangolo con cateti 6 e 8",
      "Studio del segno della funzione: (x-3)/(x+1) > 0",
      "Calcola la derivata di f(x) = 3x¬≤", "Risolvi il sistema: {x+y=10, x-y=2}",
      "Calcola il volume di un cilindro con raggio 3 e altezza 10",
      "Trova il vertice della parabola y = x¬≤ - 4x + 3", "Risolvi: log2(8) = x",
      "Calcola il seno di 90 gradi", "Risolvi l'equazione esponenziale: 2^x = 32"
    ],
    teoria: ["Propriet√† delle potenze", "Teorema di Pitagora", "Prodotti notevoli", "Teorema di Euclide", "Limiti notevoli"],
    tips: ["Controlla sempre i segni prima di finire", "Fai un disegno se il problema √® geometrico", "Semplifica le frazioni all'inizio"]
  },
  italiano: {
    esercizi_base: [
      "Fai l'analisi grammaticale di: 'La piccola bambina corre felice'", "Trova 5 sinonimi della parola 'Bello'",
      "Correggi l'errore: 'Non ce ne nessuno'", "Trasforma al passato remoto: 'Io mangio'",
      "Individua il predicato verbale: 'Il cane abbaia forte'", "Qual √® il plurale di 'Camicia'?",
      "Analizza la parola: 'Sottoscala'", "Metti l'accento dove serve: 'Perche non sei venuto?'"
    ],
    esercizi_avanzati: [
      "Fai l'analisi del periodo: 'Spero che tu stia bene anche se piove'",
      "Spiega la metafora nella poesia 'Soldati' di Ungaretti",
      "Qual √® la differenza tra complemento d'agente e di causa efficiente?",
      "Analisi metrica: conta le sillabe di un endecasillabo", "Cosa sono le rime baciate?"
    ],
    teoria: ["Le figure retoriche", "L'uso del congiuntivo", "L'analisi del periodo", "Il Decameron", "Dante e la Beatrice"],
    tips: ["Rileggi sempre ad alta voce per sentire il ritmo della punteggiatura", "Usa i connettivi per legare i paragrafi"]
  }
};
// ‚îÄ‚îÄ CONTINUAZIONE DATABASE RIPASSO_DB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  storia: {
    esercizi_base: [
      "In che anno √® stata scoperta l'America?", "Chi era il primo re d'Italia?",
      "In che data √® scoppiata la Rivoluzione Francese?", "Chi ha vinto la Seconda Guerra Mondiale?",
      "In che anno √® caduto il Muro di Berlino?", "Chi era Giulio Cesare?",
      "Cosa si festeggia il 25 Aprile in Italia?", "Chi scrisse la Costituzione Italiana?"
    ],
    esercizi_avanzati: [
      "Descrivi le cause principali della Prima Guerra Mondiale",
      "Analizza il ruolo della Chiesa nel Medioevo", "Cos'√® stata la Guerra Fredda?",
      "Spiega il concetto di Feudalesimo", "Chi erano i Medici a Firenze?",
      "Le conseguenze del Trattato di Versailles", "Il ruolo delle donne nella Resistenza"
    ],
    teoria: ["Il Rinascimento", "L'Et√† dei Lumi", "Il Risorgimento", "La Rivoluzione Industriale"],
    tips: ["Crea una linea del tempo mentale", "Collega gli eventi economici a quelli politici"]
  },
  scienze: {
    esercizi_base: [
      "Qual √® la formula chimica dell'acqua?", "Quali sono i tre stati della materia?",
      "Cos'√® la fotosintesi clorofilliana?", "Quanti sono i pianeti del Sistema Solare?",
      "Cosa serve per accendere un fuoco?", "Qual √® la funzione del cuore?",
      "Cos'√® l'atmosfera?", "A cosa servono i globuli bianchi?"
    ],
    esercizi_avanzati: [
      "Descrivi la struttura del DNA", "Spiega la legge di gravit√† di Newton",
      "Qual √® la differenza tra cellula animale e vegetale?", "Cos'√® la tavola periodica?",
      "Spiega il ciclo del carbonio", "Come funziona il sistema nervoso centrale?"
    ],
    teoria: ["L'Evoluzione di Darwin", "L'Atomo", "Il Ciclo dell'Acqua", "Le Leggi di Mendel"],
    tips: ["Osserva la natura per capire la teoria", "Disegna gli schemi delle cellule"]
  },
  inglese: {
    esercizi_base: [
      "Traduci: 'The cat is on the table'", "Come si dice 'Mela' in inglese?",
      "Coniuga il verbo To Be al presente", "Qual √® il passato di 'Go'?",
      "Come si chiede l'ora?", "Traduci: 'I love pizza'", "Colori in inglese: Rosso, Blu, Verde"
    ],
    esercizi_avanzati: [
      "Uso del Present Perfect vs Simple Past", "Cosa sono i 'Phrasal Verbs'?",
      "Scrivi una breve lettera formale in inglese", "Traduci: 'If I were you, I would go'",
      "Spiega la differenza tra 'Make' e 'Do'"
    ],
    teoria: ["I Verbi Irregolari", "I Condizionali", "La forma passiva", "Reported Speech"],
    tips: ["Guarda film in lingua originale con i sottotitoli", "Pensa in inglese per 5 minuti al giorno"]
  }
};

// ‚îÄ‚îÄ DATABASE RICETTE (RECUPERO INTEGRALE) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const RICETTE_DB = {
  carbonara: { 
    ing: "Spaghetti, Guanciale, Tuorli d'uovo, Pecorino Romano, Pepe nero", 
    dosi: "100g pasta, 60g guanciale, 2 tuorli grandi, 30g pecorino a persona" 
  },
  amatriciana: { 
    ing: "Bucatini, Guanciale, Pomodori pelati, Pecorino, Peperoncino", 
    dosi: "Usa solo il guanciale, niente cipolla o aglio!" 
  },
  pesto: { 
    ing: "Basilico fresco, Pinoli, Aglio, Olio EVO, Parmigiano, Pecorino", 
    dosi: "Pesta l'aglio con i pinoli prima di aggiungere il basilico" 
  },
  tiramisu: { 
    ing: "Savoiardi, Mascarpone, Uova, Caff√®, Zucchero, Cacao amaro", 
    dosi: "500g mascarpone, 3 uova medie, 300g savoiardi" 
  },
  lasagna: { 
    ing: "Sfoglia all'uovo, Rag√π alla bolognese, Besciamella, Parmigiano", 
    dosi: "Cuoci in forno ventilato a 180¬∞C per circa 30 minuti" 
  },
  cotoletta: { 
    ing: "Carne di vitello, Uova, Pangrattato, Burro chiarificato", 
    dosi: "Fai una doppia impanatura per renderla pi√π croccante" 
  }
};

// ‚îÄ‚îÄ FUNZIONI LOGICHE DI SUPPORTO (FIXED) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const generaRipassoOffline = (materia, livello) => {
  const m = materia.toLowerCase();
  const db = RIPASSO_DB[m] || RIPASSO_DB["matematica"];
  const cat = livello === "difficile" ? "esercizi_avanzati" : "esercizi_base";
  const lista = db[cat] || db["esercizi_base"];
  const es = lista[Math.floor(Math.random() * lista.length)];
  const tip = db.tips[Math.floor(Math.random() * db.tips.length)];
  return { es, tip };
};

const getCat = id => CATS.find(c => c.id === id) || CATS[4];
const fmt = (y, m, d) => `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
const daysIn = (y, m) => new Date(y, m + 1, 0).getDate();
const firstDay = (y, m) => {
  const d = new Date(y, m, 1).getDay();
  return d === 0 ? 6 : d - 1;
};
// ‚îÄ‚îÄ COMPONENTE ALERTS (NOTIFICHE INTELLIGENTI) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const AlertsPanel = ({ alerts, onClose, onGo }) => {
  const { dark } = useContext(ThemeCtx);
  return (
    <>
      <div className={`overlay ${alerts ? 'open' : ''}`} onClick={onClose} />
      <div className={`sheet ${alerts ? 'open' : ''}`} style={{ background: dark ? "#1c1c1e" : "#f2f2f7", maxHeight: "80%" }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "20px" }}>
          <h2 style={{ fontSize: "22px", fontWeight: "800" }}>Avvisi ‚ú®</h2>
          <button onClick={onClose} style={{ background: dark ? "#333" : "#ddd", border: "none", color: "inherit", borderRadius: "50%", width: "30px", height: "30px" }}>‚úï</button>
        </div>
        <div style={{ overflowY: "auto", paddingBottom: "20px" }}>
          {alerts.length === 0 ? (
            <p style={{ opacity: 0.5, textAlign: "center", padding: "40px 0" }}>Nessun avviso importante per ora</p>
          ) : (
            alerts.map((a, i) => (
              <div key={i} className="tap" onClick={() => onGo(a.day)} style={{ background: dark ? "rgba(255,255,255,0.05)" : "rgba(0,0,0,0.05)", padding: "16px", borderRadius: "16px", marginBottom: "12px", border: dark ? "1px solid #333" : "1px solid #eee" }}>
                <div style={{ fontSize: "12px", fontWeight: "700", opacity: 0.5, marginBottom: "4px", textTransform: "uppercase", color: "#007AFF" }}>{a.label}</div>
                <div style={{ fontSize: "16px", fontWeight: "600" }}>{a.msg}</div>
              </div>
            ))
          )}
        </div>
      </div>
    </>
  );
};

// ‚îÄ‚îÄ COMPONENTE PRINCIPALE APP (LOGICA E STATO) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function App() {
  const [year, setYear] = useState(new Date().getFullYear());
  const [month, setMonth] = useState(new Date().getMonth());
  
  // Caricamento eventi da LocalStorage (v6)
  const [events, setEvents] = useState(() => {
    try {
      const saved = localStorage.getItem("ilmioanno_v6");
      return saved ? JSON.parse(saved) : {};
    } catch (e) { return {}; }
  });

  // Gestione Tema Dark/Light
  const [dark, setDark] = useState(() => {
    const saved = localStorage.getItem("dark_mode");
    return saved !== null ? JSON.parse(saved) : true;
  });

  const [view, setView] = useState("month");
  const [selDay, setSelDay] = useState(null);
  const [showModal, setShowModal] = useState(false);
  const [editEv, setEditEv] = useState(null);
  const [showAl, setShowAl] = useState(false);
  const [search, setSearch] = useState("");

  // Salvataggio automatico
  useEffect(() => {
    localStorage.setItem("ilmioanno_v6", JSON.stringify(events));
  }, [events]);

  useEffect(() => {
    localStorage.setItem("dark_mode", JSON.stringify(dark));
    document.body.className = dark ? "dark" : "light";
  }, [dark]);

  const getDay = (key) => events[key] || [];

  const handleSave = (key, ev) => {
    const dayEvs = getDay(key);
    if (editEv) {
      setEvents({ ...events, [key]: dayEvs.map(e => e.id === editEv.id ? ev : e) });
    } else {
      setEvents({ ...events, [key]: [...dayEvs, ev] });
    }
    setShowModal(false);
    setEditEv(null);
  };

  const delEv = (key, id) => {
    if(confirm("Vuoi eliminare questo impegno?")) {
      setEvents({ ...events, [key]: getDay(key).filter(e => e.id !== id) });
    }
  };

  // LOGICA GENERAZIONE ALERT (TUTTI I TUOI CONTROLLI SULLE DATE)
  const alerts = useMemo(() => {
    const list = [];
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    Object.keys(events).forEach(key => {
      const [y, m, d] = key.split("-").map(Number);
      const evDate = new Date(y, m - 1, d);
      const diff = Math.ceil((evDate - today) / (1000 * 60 * 60 * 24));

      events[key].forEach(e => {
        if (diff === 0) {
          list.push({ day: key, label: "Oggi", msg: `Sveglia! Hai: ${e.title}` });
        } else if (diff > 0 && diff <= 3) {
          if (e.category === "verifica") {
            list.push({ day: key, label: "Studio", msg: `Mancano ${diff} giorni alla verifica di ${e.title}!` });
          } else if (e.category === "compleanno") {
            list.push({ day: key, label: "Auguri", msg: `Tra ${diff} giorni √® il compleanno di ${e.title}` });
          } else {
            list.push({ day: key, label: "Promemoria", msg: `Si avvicina l'impegno: ${e.title}` });
          }
        }
      });
    });
    return list.sort((a, b) => a.day.localeCompare(b.day));
  }, [events]);

  // Qui inizieremo con il JSX del Calendario nella Parte 5...
// ‚îÄ‚îÄ COMPONENTE DETTAGLIO GIORNO (DaySheet) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DaySheet = ({ dayKey, events, onAdd, onEdit, onDel, onClose }) => {
  const { dark } = useContext(ThemeCtx);
  const [activeQuiz, setActiveQuiz] = useState(null);
  const [showRicetta, setShowRicetta] = useState(null);

  const [y, m, d] = dayKey.split("-");
  const dateLabel = `${d} ${MONTHS[parseInt(m) - 1]} ${y}`;

  // Funzione per attivare un Quiz AI al volo
  const handleAiQuiz = () => {
    // Pesca una materia a caso o usa 'matematica' come default
    const quiz = generaRipassoOffline("matematica", "facile");
    setActiveQuiz(quiz);
  };

  return (
    <>
      <div className={`overlay ${dayKey ? 'open' : ''}`} onClick={onClose} />
      <div className={`sheet ${dayKey ? 'open' : ''}`} style={{ background: dark ? "#1c1c1e" : "#fff" }}>
        
        {/* HEADER SCHEDA */}
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "20px" }}>
          <div>
            <div style={{ fontSize: "14px", fontWeight: "700", opacity: 0.5, textTransform: "uppercase" }}>{DAYS[new Date(dayKey).getDay() === 0 ? 6 : new Date(dayKey).getDay()-1]}</div>
            <h2 style={{ fontSize: "26px", fontWeight: "800" }}>{dateLabel}</h2>
          </div>
          <button className="tap" onClick={onClose} style={{ background: dark ? "#333" : "#eee", border: "none", color: "inherit", borderRadius: "50%", width: "36px", height: "36px", fontSize: "18px" }}>‚úï</button>
        </div>

        {/* BOTTONI AZIONE AI & RICETTE */}
        <div style={{ display: "flex", gap: "10px", marginBottom: "20px" }}>
          <button className="btn-ai-special tap" style={{ flex: 1, margin: 0 }} onClick={handleAiQuiz}>
            Quiz AI ü§ñ
          </button>
          <button className="tap" onClick={() => {
            const rKeys = Object.keys(RICETTE_DB);
            const casuale = rKeys[Math.floor(Math.random() * rKeys.length)];
            setShowRicetta({nome: casuale, ...RICETTE_DB[casuale]});
          }} style={{ flex: 1, background: dark ? "#2c2c2e" : "#f2f2f7", border: "none", borderRadius: "18px", fontWeight: "700", color: "inherit", fontSize: "14px" }}>
            Ispirazione üç≥
          </button>
        </div>

        {/* BOX QUIZ AI (Se attivato) */}
        {activeQuiz && (
          <div style={{ background: "linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1))", padding: "16px", borderRadius: "20px", marginBottom: "20px", border: "1px solid rgba(168,85,247,0.2)", animation: "fadeUp 0.3s ease" }}>
            <div style={{ fontSize: "12px", fontWeight: "800", color: "#a855f7", marginBottom: "8px" }}>SFIDA DEL GIORNO</div>
            <div style={{ fontSize: "16px", fontWeight: "600", marginBottom: "10px" }}>{activeQuiz.es}</div>
            <div style={{ fontSize: "13px", opacity: 0.7, fontStyle: "italic" }}>üí° {activeQuiz.tip}</div>
            <button onClick={() => setActiveQuiz(null)} style={{ marginTop: "12px", background: "none", border: "none", color: "#6366f1", fontWeight: "700", fontSize: "13px" }}>Ho capito, chiudi</button>
          </div>
        )}

        {/* BOX RICETTA (Se attivata) */}
        {showRicetta && (
          <div style={{ background: dark ? "#2c2c2e" : "#fff9e6", padding: "16px", borderRadius: "20px", marginBottom: "20px", border: "1px solid #ff9500" }}>
            <div style={{ fontWeight: "800", color: "#ff9500", textTransform: "uppercase", fontSize: "11px" }}>Idea Cena: {showRicetta.nome}</div>
            <div style={{ fontSize: "14px", marginTop: "5px" }}><strong>Ingrediente:</strong> {showRicetta.ing}</div>
            <div style={{ fontSize: "13px", opacity: 0.8 }}>{showRicetta.dosi}</div>
            <button onClick={() => setShowRicetta(null)} style={{ marginTop: "10px", background: "none", border: "none", color: "#ff9500", fontWeight: "700" }}>Chiudi</button>
          </div>
        )}

        {/* LISTA EVENTI DEL GIORNO */}
        <div style={{ overflowY: "auto", maxHeight: "40vh", paddingRight: "5px" }}>
          {events.length === 0 ? (
            <div style={{ textAlign: "center", padding: "40px 0", opacity: 0.3 }}>
              <div style={{ fontSize: "40px" }}>üéê</div>
              <p>Nessun impegno in programma</p>
            </div>
          ) : (
            events.map(ev => (
              <div key={ev.id} className="event-card" style={{ background: dark ? "#2c2c2e" : "#f2f2f7" }}>
                <div style={{ width: "45px", height: "45px", borderRadius: "12px", background: getCat(ev.category).bg, display: "flex", alignItems: "center", justifyContent: "center", fontSize: "22px", marginRight: "15px" }}>
                  {getCat(ev.category).emoji}
                </div>
                <div style={{ flex: 1 }} onClick={() => onEdit(ev)}>
                  <div style={{ fontWeight: "700", fontSize: "16px" }}>{ev.title}</div>
                  <div style={{ fontSize: "12px", opacity: 0.5 }}>{ev.time || "10:00"} ‚Ä¢ {getCat(ev.category).label}</div>
                </div>
                <button onClick={() => onDel(ev.id)} style={{ background: "none", border: "none", fontSize: "18px", padding: "10px", opacity: 0.3 }}>üóëÔ∏è</button>
              </div>
            ))
          )}
        </div>

        {/* TASTO AGGIUNGI */}
        <button className="tap" onClick={onAdd} style={{ width: "100%", padding: "18px", borderRadius: "20px", background: "#007AFF", color: "white", border: "none", fontWeight: "700", marginTop: "15px", fontSize: "16px", boxShadow: "0 10px 20px rgba(0,122,255,0.2)" }}>
          + Aggiungi Impegno
        </button>
      </div>
    </>
  );
};
  // ‚îÄ‚îÄ FUNZIONE ESPORTAZIONE PDF (LOGICA PROFESSIONALE) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const esportaSchedaPDF = (materia) => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const quiz = generaRipassoOffline(materia, "medio");

    // Configurazione Stile PDF
    doc.setFont("helvetica", "bold");
    doc.setFontSize(22);
    doc.setTextColor(100, 102, 241); // Colore Indigo
    doc.text("SCHEDA DI RIPASSO INTELLIGENTE", 20, 30);
    
    doc.setDrawColor(200, 200, 200);
    doc.line(20, 35, 190, 35);

    doc.setFontSize(14);
    doc.setTextColor(40, 40, 40);
    doc.text(`Materia: ${materia.toUpperCase()}`, 20, 50);
    doc.text(`Data Generazione: ${new Date().toLocaleDateString()}`, 20, 60);

    doc.setFont("helvetica", "normal");
    doc.setFontSize(12);
    doc.text("Esercizio Proposto:", 20, 80);
    
    doc.setFont("helvetica", "bold");
    const splitEs = doc.splitTextToSize(quiz.es, 160);
    doc.text(splitEs, 25, 90);

    doc.setFont("helvetica", "italic");
    doc.setFontSize(11);
    doc.setTextColor(100, 100, 100);
    doc.text("Suggerimento dell'AI:", 20, 120);
    doc.text(`- ${quiz.tip}`, 25, 130);

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text("Generato con l'app Il Mio Anno - Versione Pro", 20, 280);

    doc.save(`Ripasso_${materia}_${Date.now()}.pdf`);
  };

  // ‚îÄ‚îÄ RENDERING DELL'INTERFACCIA (JSX) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  return (
    <ThemeCtx.Provider value={{ dark, toggle: () => setDark(!dark) }}>
      <div className="app">
        
        {/* HEADER SUPERIORE */}
        <div className="header">
          <button className="tap" onClick={() => setDark(!dark)} style={{ background: "none", border: "none", fontSize: "24px" }}>
            {dark ? 'üåô' : '‚òÄÔ∏è'}
          </button>
          
          <div style={{ textAlign: "center" }} onClick={() => setView(view === "month" ? "year" : "month")}>
            <div style={{ fontSize: "19px", fontWeight: "800", letterSpacing: "-0.5px" }}>{MONTHS[month]}</div>
            <div style={{ fontSize: "13px", opacity: 0.5, fontWeight: "600" }}>{year}</div>
          </div>

          <button className="tap" onClick={() => setShowAl(true)} style={{ background: "none", border: "none", position: "relative" }}>
            <span style={{ fontSize: "24px" }}>üîî</span>
            {alerts.length > 0 && (
              <div style={{ position: "absolute", top: "-2px", right: "-2px", background: "#FF3B30", width: "10px", height: "10px", borderRadius: "50%", border: `2px solid ${dark ? '#000' : '#fff'}` }} />
            )}
          </button>
        </div>

        {/* GRIGLIA GIORNI SETTIMANA */}
        <div className="calendar-grid" style={{ marginBottom: "5px" }}>
          {DAYS.map(d => (
            <div key={d} style={{ textAlign: "center", fontSize: "12px", opacity: 0.3, fontWeight: "800", padding: "15px 0" }}>
              {d}
            </div>
          ))}
        </div>

        {/* GRIGLIA CALENDARIO DINAMICA */}
        <div className="calendar-grid" style={{ alignContent: "start", rowGap: "4px" }}>
          {/* Spazi vuoti per il primo giorno del mese */}
          {Array(firstDay(year, month)).fill(null).map((_, i) => (
            <div key={`empty-${i}`} />
          ))}

          {/* Giorni del mese */}
          {[...Array(daysIn(year, month))].map((_, i) => {
            const d = i + 1;
            const key = fmt(year, month, d);
            const dayEvs = getDay(key);
            const isToday = key === fmt(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());
            const isSelected = selDay === key;

            return (
              <div 
                key={d} 
                className={`day-cell ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}`}
                onClick={() => setSelDay(key)}
              >
                <span style={{ position: "relative", zIndex: 2 }}>{d}</span>
                
                {/* Indicatori Eventi (Pallini colorati) */}
                <div style={{ display: "flex", gap: "3px", position: "absolute", bottom: "8px", justifyContent: "center" }}>
                  {dayEvs.slice(0, 3).map((ev, idx) => (
                    <div 
                      key={idx} 
                      style={{ width: "5px", height: "5px", borderRadius: "50%", background: getCat(ev.category).color }} 
                    />
                  ))}
                  {dayEvs.length > 3 && <div style={{ width: "3px", height: "3px", borderRadius: "50%", background: "gray" }} />}
                </div>
              </div>
            );
          })}
        </div>

        {/* CONTROLLI DI NAVIGAZIONE INFERIORI */}
        <div style={{ padding: "20px 30px", display: "flex", justifyContent: "space-between", alignItems: "center", borderTop: dark ? "1px solid #222" : "1px solid #eee", background: "inherit" }}>
          <button className="tap" onClick={() => { const p = addMonths(year, month, -1); setYear(p.year); setMonth(p.month); }} style={{ background: "none", border: "none", color: "inherit", fontSize: "28px", padding: "10px" }}>‚Äπ</button>
          
          <button className="tap" onClick={() => { setYear(new Date().getFullYear()); setMonth(new Date().getMonth()); }} style={{ background: dark ? "#222" : "#eee", border: "none", padding: "8px 20px", borderRadius: "20px", fontWeight: "700", fontSize: "13px", color: "inherit" }}>
            OGGI
          </button>
          
          <button className="tap" onClick={() => { const n = addMonths(year, month, 1); setYear(n.year); setMonth(n.month); }} style={{ background: "none", border: "none", color: "inherit", fontSize: "28px", padding: "10px" }}>‚Ä∫</button>
        </div>

        {/* I componenti DaySheet e Modal seguono nella Parte 7... */}
        {/* MODALE DI INSERIMENTO / MODIFICA */}
        {showModal && (
          <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.7)", display: "flex", alignItems: "flex-end", zIndex: 2000 }}>
            <div style={{ 
              background: dark ? "#1c1c1e" : "#fff", 
              width: "100%", 
              padding: "25px", 
              borderRadius: "30px 30px 0 0", 
              animation: "slideUp 0.4s cubic-bezier(0.15,1,0.3,1)" 
            }}>
              <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "20px" }}>
                <h3 style={{ fontSize: "20px", fontWeight: "800" }}>{editEv ? "Modifica" : "Nuovo Impegno"}</h3>
                <button onClick={() => {setShowModal(false); setEditEv(null);}} style={{ background: "none", border: "none", color: "#007AFF", fontWeight: "700" }}>Annulla</button>
              </div>

              <div className="input-group">
                <label style={{ display: "block", fontSize: "11px", fontWeight: "700", opacity: 0.5, marginBottom: "8px", textTransform: "uppercase" }}>Cosa devi fare?</label>
                <input 
                  id="evTitle" 
                  autoFocus 
                  defaultValue={editEv?.title || ""} 
                  placeholder="Es: Verifica di Storia" 
                  style={{ background: dark ? "#2c2c2e" : "#f2f2f7", color: "inherit" }}
                />
              </div>

              <label style={{ display: "block", fontSize: "11px", fontWeight: "700", opacity: 0.5, marginBottom: "12px", textTransform: "uppercase" }}>Scegli Categoria</label>
              <div style={{ display: "grid", gridTemplateColumns: "repeat(2, 1fr)", gap: "10px", marginBottom: "20px" }}>
                {CATS.map(c => (
                  <button 
                    key={c.id} 
                    onClick={() => {
                      const title = document.getElementById("evTitle").value;
                      if(!title) return alert("Inserisci un titolo!");
                      handleSave(selDay, {
                        id: editEv?.id || Date.now(),
                        title,
                        category: c.id,
                        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                      });
                    }}
                    style={{ 
                      padding: "14px", 
                      borderRadius: "16px", 
                      border: "none", 
                      background: c.bg, 
                      color: c.color, 
                      fontWeight: "700", 
                      textAlign: "left",
                      display: "flex",
                      alignItems: "center",
                      gap: "8px"
                    }}
                  >
                    <span>{c.emoji}</span> {c.label}
                  </button>
                ))}
              </div>

              {/* Tasto per generare PDF direttamente dalla materia se √® una verifica */}
              <button 
                onClick={() => esportaSchedaPDF("matematica")}
                style={{ width: "100%", padding: "12px", borderRadius: "14px", background: "none", border: `1px solid ${dark ? '#333' : '#eee'}`, color: "inherit", fontSize: "13px", opacity: 0.8 }}
              >
                Genera PDF Studio Rapido üìÑ
              </button>
            </div>
          </div>
        )}

        {/* COMPONENTI AGGIUNTIVI (GI√Ä DEFINITI) */}
        {showAl && <AlertsPanel alerts={alerts} onClose={() => setShowAl(false)} onGo={(d) => {setSelDay(d); setShowAl(false);}} />}
        {selDay && (
          <DaySheet 
            dayKey={selDay} 
            events={getDay(selDay)} 
            onAdd={() => setShowModal(true)} 
            onEdit={(ev) => {setEditEv(ev); setShowModal(true);}} 
            onDel={(id) => delEv(selDay, id)} 
            onClose={() => setSelDay(null)} 
          />
        )}
      </div>
    </ThemeCtx.Provider>
  );
}

// ‚îÄ‚îÄ AVVIO APPLICAZIONE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
</script>
</body>
</html>
